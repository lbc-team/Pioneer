
>- åŸæ–‡é“¾æ¥ï¼š[blog.shadow.xyz/uniswap-v3](https://blog.shadow.xyz/uniswap-v3/)
>- è¯‘è€…ï¼š[AIç¿»è¯‘å®˜](https://learnblockchain.cn/people/19584)ï¼Œæ ¡å¯¹ï¼š[ç¿»è¯‘å°ç»„](https://learnblockchain.cn/people/412)
>- æœ¬æ–‡é“¾æ¥ï¼š[learnblockchain.cn/articleâ€¦](https://learnblockchain.cn/article/10596)
    
## æ¦‚è¿°

Shadow ä¸ Uniswap åˆä½œï¼Œä¸º Uniswap v3 æ± å¼€å‘äº†è‡ªå®šä¹‰çš„ shadow äº‹ä»¶ï¼Œä»è€Œè§£é”äº†æ›´ä¸°å¯Œçš„æ± æ´»åŠ¨å’ŒæµåŠ¨æ€§åŠ¨æ€æ•°æ®é›†ã€‚

æˆ‘ä»¬æ„å»ºäº†ä¸€ä¸ªä»ªè¡¨æ¿ï¼ˆ[univ3.xyz](https://www.univ3.xyz/?ref=blog.shadow.xyz)ï¼‰ï¼Œåˆ©ç”¨è¿™ä¸ªæ•°æ®é›†å’Œæˆ‘ä»¬æœ€è¿‘æ¨å‡ºçš„[å®æ—¶æ•°æ®åº“åŒæ­¥](https://x.com/shadowxyz/status/1812913757573816806?ref=blog.shadow.xyz) ï¼Œå±•ç¤ºä½ å¯ä»¥ç”¨ Shadow æ„å»ºçš„å†…å®¹ã€‚

åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†è¯¦ç»†ä»‹ç»è¿™äº› Uniswap v3 shadow äº‹ä»¶ï¼Œå®ƒä»¬è§£é”çš„æ–°æ•°æ®ï¼Œä»¥åŠå®ƒä»¬æ˜¯å¦‚ä½•ç”¨æ¥ç”Ÿæˆæ¯ä¸ªä»ªè¡¨æ¿å›¾è¡¨çš„ã€‚

![](https://img.learnblockchain.cn/attachments/migrate/1736821765767)

## Shadow è§£é”çš„å†…å®¹

Shadow èµ‹äºˆä½ å°†é“¾å¤–äº‹ä»¶æ—¥å¿—æ·»åŠ åˆ°ä»»ä½•éƒ¨ç½²çš„æ™ºèƒ½åˆçº¦çš„è¶…çº§èƒ½åŠ›ï¼Œå¹¶æä¾›ä¸€ä¸ªæ˜“äºä½¿ç”¨çš„æ‰˜ç®¡å¹³å°ï¼Œæ¶ˆé™¤å¤æ‚æ•°æ®ç®¡é“å’Œå…¶ä»–èŠ‚ç‚¹åŸºç¡€è®¾æ–½çš„éœ€æ±‚ã€‚

Shadow ä¸ºé¡¶çº§åŠ å¯†å·¥ç¨‹å’Œæ•°æ®å›¢é˜ŸèŠ‚çœäº†å®è´µçš„æ—¶é—´â€”â€”é“¾ä¸Šæ•°æ®é—®é¢˜æ›¾ç»éœ€è¦æ•°å‘¨è§£å†³ï¼Œç°åœ¨ç¼©çŸ­ä¸ºå‡ å°æ—¶ç”šè‡³å‡ åˆ†é’Ÿã€‚

å€ŸåŠ© Shadowï¼Œä¸€ä¸ªäººå¯ä»¥åœ¨ä¸€ä¸ªä¸‹åˆæ„å»ºä¸€ä¸ªå¼ºå¤§çš„é“¾ä¸Šæ•°æ®ç´¢å¼•å™¨ï¼Œè€Œæ— éœ€è®¾ç½®ä»»ä½•ç®¡é“æˆ–åŸºç¡€è®¾æ–½ã€‚è¿™ä½¿ä½ èƒ½å¤Ÿæ›´å¿«åœ°å°†äº§å“æ¨å‘å¸‚åœºï¼Œå¹¶æ›´å¿«é€Ÿåœ°è¿›è¡Œæ•°æ®é©±åŠ¨çš„è¿­ä»£ï¼ˆåœ¨è¿™ä¸€[æ¡ˆä¾‹ç ”ç©¶](https://blog.shadow.xyz/pendle-case-study/)ä¸­ï¼Œäº†è§£ Pendle å¦‚ä½•é€šè¿‡ Shadow å°†å…¶äº¤æ˜“è·¯ç”±æé«˜äº† 34%ï¼‰ã€‚

![](https://img.learnblockchain.cn/attachments/migrate/1736821766166)

## Uniswap v3 shadow äº‹ä»¶

æˆ‘ä»¬ä¸ Uniswap åˆä½œï¼Œä¸º Uniswap v3 æ± å¼€å‘äº† shadow äº‹ä»¶ï¼Œè¿™äº›äº‹ä»¶è§£é”äº†æ›´ä¸°å¯Œçš„æ± æ´»åŠ¨å’ŒæµåŠ¨æ€§åŠ¨æ€æ•°æ®é›†ã€‚

è¿™ä¸ªæ›´ä¸°å¯Œçš„æ•°æ®é›†ä½¿æˆ‘ä»¬èƒ½å¤Ÿï¼š

*   åˆ›å»ºæ•°æ®å¯†é›†å‹å›¾è¡¨ï¼Œè€Œæ— éœ€è¿›è¡Œä»»ä½• RPC è°ƒç”¨æˆ–ä½¿ç”¨ä»»ä½•å¤–éƒ¨ API
*   å¯¹æµåŠ¨æ€§æä¾›è€…çš„è¡Œä¸ºå’Œç›ˆåˆ©èƒ½åŠ›è¿›è¡Œå¤æ‚åˆ†æ
*   æ„å»ºä»·æ ¼èŒƒå›´å’Œæ—¶é—´å†…æµåŠ¨æ€§åˆ†å¸ƒçš„å®Œæ•´å›¾æ™¯
*   æ›´æ·±å…¥ç†è§£å†…éƒ¨æ± åŠ¨æ€ï¼ˆä¾‹å¦‚ï¼šæ¿€æ´»çš„ ticksã€æµåŠ¨æ€§èŒƒå›´ã€tick è´¹ç”¨ç´¯ç§¯ï¼‰

ä½†å±•ç¤ºæ€»æ¯”è¯´æ˜æœ‰æ•ˆã€‚å› æ­¤ï¼Œæˆ‘ä»¬æ„å»ºäº†ä¸€ä¸ªä»ªè¡¨æ¿â€”â€”[univ3.xyz](https://univ3.xyz/?ref=blog.shadow.xyz)ï¼Œä»¥å±•ç¤ºè¿™ä¸€ç‹¬ç‰¹ shadow äº‹ä»¶æ•°æ®é›†è§£é”çš„ä¸€äº›å†…å®¹ã€‚

æˆ‘ä»¬å·²ç»ä¸º [USDC-WETH 5bps æ± ](https://console.cloud.google.com/storage/browser/shadowxyz-exports--80eb5f6c-f032-4368-9475-ffa80eb8e650/chain%3Dethereum/network%3Dmainnet/fork_id%3Daa494403-3c37-433b-92ca-6aeb1a1b3e11/version%3D5/export%3D8c5a2438-64b6-4919-8d68-231c34e6fc5b/type%3Ddecoded-logs?pageState=%28%22StorageObjectListTable%22%3A%28%22f%22%3A%22%255B%255D%22%29%29&ref=blog.shadow.xyz)å‘å¸ƒäº†è¿™äº›æ•°æ®ï¼Œå¹¶é¼“åŠ±ç ”ç©¶äººå‘˜å’Œåˆ†æå¸ˆåˆ†äº«åé¦ˆå¹¶è¿›è¡Œè‡ªå·±çš„åˆ†æã€‚

ä½ å¯ä»¥åœ¨è¿™ç¯‡æ–‡ç« çš„æœ€åé˜…è¯»å…³äºæ¯ä¸ª shadow äº‹ä»¶çš„è¯¦ç»†è§£æã€‚

## å›¾è¡¨è¯´æ˜

æœ¬èŠ‚æ¦‚è¿°äº† [univ3.xyz](https://univ3.xyz/?ref=blog.shadow.xyz) ä¸Šæ¯ä¸ªä»ªè¡¨æ¿å›¾è¡¨æ‰€å±•ç¤ºå†…å®¹ï¼Œä»¥åŠå¦‚ä½•ä½¿ç”¨ Uniswap v3 æ±  shadow äº‹ä»¶ç”Ÿæˆæ‰€å‘ˆç°çš„æ•°æ®ã€‚

ğŸ’¡

æœ¬ç‰ˆæœ¬çš„ä»ªè¡¨æ¿æœªåŒ…å«è¯¸å¦‚æŸå¤±ä¸å†å¹³è¡¡ï¼ˆLVRï¼‰ä¸´æ—¶æŸå¤±ï¼ˆILï¼‰ç­‰èµ„æœ¬æŸå¤±æŒ‡æ ‡ã€‚æˆ‘ä»¬å¸Œæœ›æœªæ¥èƒ½å¤Ÿæ·»åŠ è¿™ä¸€ç±»åˆ«çš„æ•°æ®ã€‚

## äº¤æ˜“é‡ä¸è´¹ç”¨

æ¡å½¢å›¾è¡¨ç¤ºäº¤æ¢äº¤æ˜“é‡ï¼Œçº¿æ¡è¡¨ç¤ºæ”¶é›†çš„è´¹ç”¨ã€‚

shadow äº‹ä»¶çš„ä½¿ç”¨æ–¹å¼ï¼š

*   `ShadowSwap`äº‹ä»¶åŒ…å«ä¸€ä¸ªå‚æ•°`USDAmountE6`ï¼Œä½¿ç”¨ ETH-USD Chainlink ä»·æ ¼é¢„è¨€æœºè®¡ç®—äº¤æ¢çš„ç¾å…ƒä»·å€¼ï¼Œå…·æœ‰åŒºå—çº§çš„å‡†ç¡®æ€§ï¼Œæ— éœ€ä½¿ç”¨å¤–éƒ¨é“¾å¤–ä»·æ ¼ APIã€‚
*   äº¤æ¢çš„ç¾å…ƒé‡‘é¢å†ä¹˜ä»¥`poolFee`ï¼Œæ¥è‡ª`ShadowSwap`ç»“æ„`PoolInfo`ï¼Œå…¶ä¸­è¿˜åŒ…å«å…¶ä»–æœ‰ç”¨çš„æ± å…ƒæ•°æ®ï¼Œå¦‚`poolName`ã€`tickSpacing`ä»¥åŠ`token0`å’Œ`token1`çš„åœ°å€ã€ç¬¦å·ã€åç§°å’Œå°æ•°ä½æ•°ã€‚

![](https://img.learnblockchain.cn/attachments/migrate/1736821766174)

## æµåŠ¨æ€§ä¸ä»·æ ¼

åœ¨ç‰¹å®šåŒºå—ä¸­ï¼Œè™šæ‹ŸæµåŠ¨æ€§åœ¨ä»·æ ¼èŒƒå›´å†…çš„åˆ†å¸ƒã€‚åº•éƒ¨çš„æ§åˆ¶é€‰é¡¹å…è®¸ä½ æµè§ˆè¿‡å»çš„åŒºå—èŒƒå›´ã€‚ä½ ä¹Ÿå¯ä»¥è¾“å…¥ç‰¹å®šçš„åŒºå—ç¼–å·ã€‚

shadow äº‹ä»¶çš„ä½¿ç”¨æ–¹å¼ï¼š

`PoolLiquidityAtTickSpace` shadow äº‹ä»¶åœ¨æ¯æ¬¡æµåŠ¨æ€§`mint`æˆ–`burn`å‘ç”Ÿæ—¶å‘å‡ºï¼Œå¹¶åŒ…å«ï¼š

*   åœ¨`mint`æˆ–`burn`å®Œæˆåï¼Œæ± åœ¨æ¯ä¸ª tick\-space çš„æ›´æ–°æ€»æµåŠ¨æ€§
*   å½“ tick ä»å·¦ä¾§ç©¿è¶Šåˆ°å³ä¾§æ—¶ï¼Œæ–°å¢çš„å‡€æµåŠ¨æ€§

è¿™ä½¿æˆ‘ä»¬èƒ½å¤Ÿåœ¨ä»»ä½•ç»™å®šçš„åŒºå—é«˜åº¦ç”Ÿæˆæ± æµåŠ¨æ€§åˆ†å¸ƒçš„è§†å›¾ï¼Œè€Œæ— éœ€è¿›è¡Œä»»ä½• RPC è°ƒç”¨ã€‚

![](https://img.learnblockchain.cn/attachments/migrate/1736821766171)

## LP å¤´å¯¸

åœ¨ç‰¹å®šåŒºå—ä¸­ï¼Œè·¨è¶Šä»·æ ¼èŒƒå›´çš„æœ€å¤§æµåŠ¨æ€§å¤´å¯¸ã€‚

shadow äº‹ä»¶çš„ä½¿ç”¨æ–¹å¼ï¼š

`ShadowMint`å’Œ`ShadowBurn`äº‹ä»¶åŒ…å«ä¸€ä¸ª`owner`å’Œä¸€ä¸ª`sender`å‚æ•°ï¼Œç”¨äºåŒºåˆ†å‘èµ·äº¤æ˜“çš„ EOAï¼ˆ`owner`ï¼‰å’Œè°ƒç”¨æ± å‡½æ•°çš„`sender`ï¼ˆé€šå¸¸æ˜¯ Uniswap çš„`NonfungiblePositionManager`åˆçº¦ï¼‰ã€‚

ç„¶åï¼ŒåŸºäº`owner`ã€`tickLower`å’Œ`tickUpper`çš„ç»„åˆç”Ÿæˆ`positionId`å“ˆå¸Œã€‚è¿™ä½¿æˆ‘ä»¬èƒ½å¤Ÿåœ¨ä¸è¿›è¡Œ RPC è°ƒç”¨çš„æƒ…å†µä¸‹ï¼Œå°†ä¸å•ä¸ªæ‰€æœ‰è€…å…³è”çš„é“¸é€ å’Œé”€æ¯è¿›è¡Œæ˜ å°„ï¼Œä¸”ä¸è®ºæµåŠ¨æ€§å¤´å¯¸æ˜¯å¦é€šè¿‡`NonfungiblePositionManager`åˆçº¦è¿›è¡Œæ›´æ”¹ã€‚

æœ€åï¼Œæˆ‘ä»¬åœ¨æ‰€é€‰çš„åŒºå—é«˜åº¦ä½¿ç”¨æœ€åä¸€ä¸ª`ShadowSwap`æ¥è®¡ç®—æ¯ä¸ªæµåŠ¨æ€§å¤´å¯¸çš„ä»£å¸çš„ç¾å…ƒä»·å€¼ã€‚

![](https://img.learnblockchain.cn/attachments/migrate/1736821766169)

## æµåŠ¨æ€§å˜åŒ–

åœ¨ç‰¹å®šæ—¶é—´æ®µå†…ï¼Œæ± ä¸­çš„ token0/1 æµåŠ¨æ€§å˜åŒ–ã€‚

shadow äº‹ä»¶çš„ä½¿ç”¨æ–¹å¼ï¼š

`ShadowMint`å’Œ`ShadowBurn`äº‹ä»¶åŒ…å«ä¸€ä¸ªç»“æ„ä½“`TokenInfo`ï¼Œå­˜å‚¨è¯¸å¦‚`tokenAddress`ã€`tokenSymbol`ã€`tokenName`å’Œ`tokenDecimals`ç­‰å…ƒæ•°æ®ï¼Œè¿™ç®€åŒ–äº†å›¾è¡¨ä¸­äººç±»å¯è¯»çš„ä»£å¸æ•°é‡çš„å±•ç°ã€‚

![](https://img.learnblockchain.cn/attachments/migrate/1736821766173)

## æ¯ä¸ª tick èŒƒå›´çš„è´¹ç”¨

åœ¨ç‰¹å®šæ—¶é—´æ®µå†…ï¼Œæ•´ä¸ªæ± åœ¨ä»·æ ¼èŒƒå›´å†…èµšå–çš„è´¹ç”¨ã€‚

shadow äº‹ä»¶çš„ä½¿ç”¨æ–¹å¼ï¼š

`ShadowMint`å’Œ`ShadowBurn`äº‹ä»¶åŒ…å«ä¸€ä¸ª`owner`å’Œä¸€ä¸ª`sender`å‚æ•°ï¼Œç”¨äºåŒºåˆ†å‘èµ·äº¤æ˜“çš„ EOAï¼ˆ`owner`ï¼‰å’Œè°ƒç”¨æ± å‡½æ•°çš„`sender`ï¼ˆé€šå¸¸æ˜¯ Uniswap çš„`NonfungiblePositionManager`åˆçº¦ï¼‰ã€‚

ç„¶åï¼ŒåŸºäº`owner`ã€`tickLower`å’Œ`tickUpper`çš„ç»„åˆç”Ÿæˆ`positionId`å“ˆå¸Œã€‚è¿™ä½¿æˆ‘ä»¬èƒ½å¤Ÿåœ¨ä¸è¿›è¡Œ RPC è°ƒç”¨çš„æƒ…å†µä¸‹ï¼Œå°†ä¸å•ä¸ªæ‰€æœ‰è€…å…³è”çš„é“¸é€ å’Œé”€æ¯è¿›è¡Œæ˜ å°„ï¼Œä¸”ä¸è®ºæµåŠ¨æ€§å¤´å¯¸æ˜¯å¦é€šè¿‡`NonfungiblePositionManager`åˆçº¦è¿›è¡Œæ›´æ”¹ã€‚

æˆ‘ä»¬æ±‡æ€»äº†æŒ‡å®šæ—¶é—´æ®µå†…æ¯ä¸ª tick ç©ºé—´çš„æ€»äº¤æ¢é‡ï¼ˆä»¥ USD è®¡ï¼‰ï¼Œå¹¶ä¹˜ä»¥ `poolFee` ä»¥æ˜¾ç¤ºæ¯ä¸ª tick ç´¯ç§¯çš„è´¹ç”¨ã€‚

![](https://img.learnblockchain.cn/attachments/migrate/1736821766884)

## æ”¶å–çš„è´¹ç”¨

åœ¨ç»™å®šæ—¶é—´æ®µå†…ï¼Œå•ä¸ªæµåŠ¨æ€§å¤´å¯¸æ”¶å–çš„è´¹ç”¨ã€‚

å¦‚ä½•ä½¿ç”¨ shadow äº‹ä»¶ï¼š

`ShadowMint` å’Œ `ShadowBurn` äº‹ä»¶åŒ…å«ä¸€ä¸ª `owner` å’Œä¸€ä¸ª `sender` å‚æ•°ï¼Œè¿™äº›å‚æ•°ç”¨äºåŒºåˆ†å‘èµ·äº¤æ˜“çš„ EOAï¼ˆ`owner`ï¼‰ä¸è°ƒç”¨æ± å‡½æ•°çš„ `sender`ï¼ˆé€šå¸¸æ˜¯ Uniswap çš„ `NonfungiblePositionManager` åˆçº¦ï¼‰ã€‚

ç„¶åï¼Œä» `owner`ã€`tickLower` å’Œ `tickUpper` çš„ç»„åˆç”Ÿæˆä¸€ä¸ª `positionId` å“ˆå¸Œã€‚è¿™ä½¿æˆ‘ä»¬èƒ½å¤Ÿåœ¨ä¸è¿›è¡Œ RPC è°ƒç”¨çš„æƒ…å†µä¸‹ï¼Œå°†ä¸å•ä¸ªæ‰€æœ‰è€…ç›¸å…³è”çš„é“¸é€ å’Œé”€æ¯è¿›è¡Œæ˜ å°„ï¼Œè€Œæ— éœ€è€ƒè™‘æµåŠ¨æ€§å¤´å¯¸æ˜¯å¦é€šè¿‡ `NonfungiblePositionManager` åˆçº¦è¿›è¡Œäº†æ›´æ”¹ã€‚

`ShadowBurn` äº‹ä»¶è¿˜åŒ…æ‹¬ `FeesEarned.token0` å’Œ `FeesEarned.token1` å‚æ•°ï¼Œè¿™å°†ç´¯ç§¯åˆ°æµåŠ¨æ€§å¤´å¯¸çš„äº¤æ¢è´¹ç”¨ä»åŸå§‹å­˜å…¥æ± çš„ `token0` å’Œ `token1` é‡‘é¢ä¸­åˆ†ç¦»å‡ºæ¥ã€‚

![](https://img.learnblockchain.cn/attachments/migrate/1736821767132)

## æŒ‰æ”¶å–è´¹ç”¨æ’åºçš„å‰æµåŠ¨æ€§æä¾›è€…

åœ¨ç»™å®šæ—¶é—´æ®µå†…æŒ‰æ”¶å–è´¹ç”¨æ’åºçš„æµåŠ¨æ€§æä¾›è€…ã€‚

å¦‚ä½•ä½¿ç”¨ shadow äº‹ä»¶ï¼š

`ShadowMint` å’Œ `ShadowBurn` äº‹ä»¶åŒ…å«ä¸€ä¸ª `owner` å’Œä¸€ä¸ª `sender` å‚æ•°ï¼Œè¿™äº›å‚æ•°ç”¨äºåŒºåˆ†å‘èµ·äº¤æ˜“çš„ EOAï¼ˆ`owner`ï¼‰ä¸è°ƒç”¨æ± å‡½æ•°çš„ `sender`ï¼ˆé€šå¸¸æ˜¯ Uniswap çš„ `NonfungiblePositionManager` åˆçº¦ï¼‰ã€‚

ç„¶åï¼Œä» `owner`ã€`tickLower` å’Œ `tickUpper` çš„ç»„åˆç”Ÿæˆä¸€ä¸ª `positionId` å“ˆå¸Œã€‚è¿™ä½¿æˆ‘ä»¬èƒ½å¤Ÿåœ¨ä¸è¿›è¡Œ RPC è°ƒç”¨çš„æƒ…å†µä¸‹ï¼Œå°†ä¸å•ä¸ªæ‰€æœ‰è€…ç›¸å…³è”çš„é“¸é€ å’Œé”€æ¯è¿›è¡Œæ˜ å°„ï¼Œè€Œæ— éœ€è€ƒè™‘æµåŠ¨æ€§å¤´å¯¸æ˜¯å¦é€šè¿‡ `NonfungiblePositionManager` åˆçº¦è¿›è¡Œäº†æ›´æ”¹ã€‚

`ShadowBurn` äº‹ä»¶åŒ…å« `FeesEarned.token0` å’Œ `FeesEarned.token1` å‚æ•°ï¼Œè¿™å°†ç´¯ç§¯åˆ°æµåŠ¨æ€§å¤´å¯¸çš„äº¤æ¢è´¹ç”¨ä»åŸå§‹å­˜å…¥æ± çš„ `token0` å’Œ `token1` é‡‘é¢ä¸­åˆ†ç¦»å‡ºæ¥ã€‚

## æ•°æ®è¯´æ˜

æœ¬èŠ‚è¯¦ç»†è¯´æ˜äº†æ¯ä¸ª Uniswap v3 æ± åˆçº¦ä¸­çš„ shadow äº‹ä»¶æ‰€åŒ…å«çš„æ•°æ®ã€‚æˆ‘ä»¬å‡è®¾ä½ ç†Ÿæ‚‰ Uniswap v3 çš„åŸºæœ¬æ¦‚å¿µã€‚å¦‚æœä½ éœ€è¦å›é¡¾æˆ–æƒ³äº†è§£ç›¸å…³å†…å®¹ï¼Œè¯·é˜…è¯»ä»¥ä¸‹å¸–å­ï¼š

*   [Uniswap v3 æ¦‚è¿°](https://blog.uniswap.org/uniswap-v3?ref=blog.shadow.xyz)
*   [Uniswap v3 æ•°å­¦å…¥é—¨ ç¬¬ 1 éƒ¨åˆ†](https://blog.uniswap.org/uniswap-v3-math-primer?ref=blog.shadow.xyz) å’Œ [ç¬¬ 2 éƒ¨åˆ†](https://blog.uniswap.org/uniswap-v3-math-primer-2?ref=blog.shadow.xyz#calculating-uncollected-fees-in-a-position)

ğŸ’¡

èµ„æœ¬æŸå¤±æŒ‡æ ‡ï¼Œå¦‚ä¸å†å¹³è¡¡ç›¸å…³çš„æŸå¤±ï¼ˆLVRï¼‰å’Œæ— å¸¸æŸå¤±ï¼ˆILï¼‰ä¸åŒ…æ‹¬åœ¨è¿™ä¸€ç»„ shadow äº‹ä»¶ä¸­ã€‚æˆ‘ä»¬é¼“åŠ±ç ”ç©¶äººå‘˜ä½¿ç”¨ Shadow æ•æ‰è¿™äº›æŒ‡æ ‡çš„æ•°æ®ï¼

## ç¬¦å·è¡¨ç¤ºæ³•

ç”±äº Solidity ä¸æ”¯æŒå°æ•°ï¼Œæˆ‘ä»¬ä½¿ç”¨ `E` è¡¨ç¤ºæ³•æ¥è¡¨ç¤ºä¹˜ä»¥ `1eN` çš„å€¼ï¼Œä»¥ä¿æŒç²¾åº¦ã€‚å½“å‘ç”¨æˆ·å‘ˆç°å€¼æ—¶ï¼Œé™¤ä»¥ `1eN`ã€‚

*   ä¾‹å¦‚ï¼šå¦‚æœ `USDAmountE6` = 1,245,480,000ï¼Œåˆ™åº”å°†å…¶é™¤ä»¥ `1e6` ä»¥å¾—å‡ºå¯è¯»çš„å€¼ 1,245.48

Uniswap åˆçº¦ä¸­çš„ä¸€äº›å…¶ä»–å€¼ï¼Œå¦‚ `sqrtPriceX96` ï¼Œç”± Q è¡¨ç¤ºæ³•è¡¨ç¤ºï¼Œä½ å¯ä»¥ [åœ¨æ­¤å¤„äº†è§£æ›´å¤š](https://blog.uniswap.org/uniswap-v3-math-primer?ref=blog.shadow.xyz#what-is-a-q-notation)ã€‚

## ç»“æ„ä½“

æˆ‘ä»¬å¹¿æ³›ä½¿ç”¨ç»“æ„ä½“ä»¥ä¿æŒæ•°æ®å‚æ•°çš„ç»„ç»‡ï¼Œå¹¶é¿å… Solidity ç¼–è¯‘å™¨çš„ `Stack too deep` é”™è¯¯ã€‚Shadow ç§»é™¤äº† gas è´¦ç›®å’Œåˆçº¦ä»£ç å¤§å°é™åˆ¶ï¼Œå› æ­¤ä½ å¯ä»¥æ·»åŠ å°½å¯èƒ½å¤šçš„æ•°æ®æ—¥å¿—ã€‚

ğŸ’¡

ä¸€äº›ç»“æ„ä½“åœ¨å¤šä¸ª shadow äº‹ä»¶ä¸­é‡å¤ä½¿ç”¨ï¼Œè¿™ä¿æŒäº†å‘½åçš„ä¸€è‡´æ€§ï¼Œå¹¶å‡å°‘äº†é¢å¤–è¡¨è¿æ¥çš„éœ€æ±‚ã€‚

### SwapInfo

    // äº¤æ¢ä¿¡æ¯çš„ç»“æ„ä½“
    struct SwapInfo {
        // å‘èµ·äº¤æ¢è°ƒç”¨çš„åœ°å€ï¼Œå¹¶æ¥æ”¶åˆ°å›è°ƒ
        address sender;
        // æ¥æ”¶äº¤æ¢è¾“å‡ºçš„åœ°å€
        address recipient;
        // æ± çš„ token0 ä½™é¢çš„å˜åŒ–é‡
        int256 amount0;
        // æ± çš„ token1 ä½™é¢çš„å˜åŒ–é‡
        int256 amount1;
        // ä½¿ç”¨ Chainlink é¢„è¨€æœºçš„äº¤æ¢çš„ USD é‡‘é¢ï¼Œä¹˜ä»¥ 1e6 ä»¥ä¿æŒåç»­å­˜å‚¨ç²¾åº¦
        uint256 USDAmountE6;
        // äº¤æ¢åæ± çš„ sqrt(price)ï¼Œè¡¨ç¤ºä¸º Q64.96
        uint160 sqrtPriceX96;
        // äº¤æ¢åæ± çš„æµåŠ¨æ€§
        uint128 liquidity;
        // äº¤æ¢åæ± ä»·æ ¼çš„ 1.0001 çš„å¯¹æ•°
        int24 tick;
    }

### TokenInfo

    // ä¸€èˆ¬ä»£å¸ä¿¡æ¯çš„ç»“æ„ä½“
    struct TokenInfo {
        // ä»£å¸åœ°å€
        address tokenAddress;
        // ä»£å¸ç¬¦å·ï¼Œä¾‹å¦‚ "WETH"
        string tokenSymbol;
        // ä»£å¸åç§°ï¼Œä¾‹å¦‚ "Wrapped Ether"
        string tokenName;
        // ä»£å¸å°æ•°ä½
        uint8 tokenDecimals;
    }

### PoolInfo

    // ä¸€èˆ¬æ± ä¿¡æ¯çš„ç»“æ„ä½“
    struct PoolInfo {
        // æ± çš„ token0
        TokenInfo token0;
        // æ± çš„ token1
        TokenInfo token1;
        // æ± çš„è´¹ç”¨ï¼Œä»¥ç™¾åˆ†ä¹‹ä¸€çš„ bip è¡¨ç¤ºï¼Œå³ 1e-6
        uint24 poolFee;
        // æ± çš„ Shadow åç§°ï¼›æ ¼å¼ä¸º "token0Symbol-token1Symbol poolFee bps"
        string poolName;
        // æ± çš„ tick é—´éš”
        int24 tickSpacing;
    }

### PositionDetails

    // ä¸€èˆ¬æµåŠ¨æ€§å¤´å¯¸ä¿¡æ¯çš„ç»“æ„ä½“
    struct PositionDetails {
        // æµåŠ¨æ€§å¤´å¯¸çš„æ‰€æœ‰è€…ï¼›å¦‚æœé€šè¿‡ NonfungiblePositionManager é“¸é€ ï¼Œåˆ™ä¸º NonfungiblePositionManager çš„ mint() å‡½æ•°çš„ msg.sender
        address owner;
        // åœ¨æ± åˆçº¦ä¸Šè°ƒç”¨ mint() å‡½æ•°çš„å‘é€è€…ï¼›å¯èƒ½ä¸æ‰€æœ‰è€…ä¸åŒï¼Œå¦‚æœä½¿ç”¨åˆ™ä¸º NonfungiblePositionManager
        address sender;
        // å¤´å¯¸çš„ä¸‹é™ tick
        int24 tickLower;
        // å¤´å¯¸çš„ä¸Šé™ tick
        int24 tickUpper;
        // é“¸é€ åˆ°å¤´å¯¸èŒƒå›´çš„æµåŠ¨æ€§æ•°é‡
        uint128 amount;
        // é“¸é€ æµåŠ¨æ€§æ‰€éœ€çš„ token0 æ•°é‡
        uint256 amount0;
        // é“¸é€ æµåŠ¨æ€§æ‰€éœ€çš„ token1 æ•°é‡
        uint256 amount1;
        // ä» ownerã€tickLower å’Œ tickUpper çš„ keccak256 å“ˆå¸Œç”Ÿæˆçš„ Shadow positionId
        bytes32 positionId;
    }

### FeesEarned

    // æ”¶å–çš„è´¹ç”¨çš„ç»“æ„ä½“ï¼Œåœ¨ ShadowBurn äº‹ä»¶ä¸­ä½¿ç”¨
    struct FeesEarned {
        // token0 æ”¶å–çš„è´¹ç”¨
        uint128 token0;
        // token1 æ”¶å–çš„è´¹ç”¨
        uint128 token1;
    }

### PositionFeeValues

    // æµåŠ¨æ€§å¤´å¯¸è´¹ç”¨å€¼çš„ç»“æ„ä½“ï¼›æœ‰åŠ©äºè®¡ç®—å¤´å¯¸è´¹ç”¨ï¼Œåœ¨ ShadowMint å’Œ ShadowBurn äº‹ä»¶ä¸­ä½¿ç”¨
    struct PositionFeeValues {
        // feeGrowthGlobal0E18 token0 çš„å…¨çƒè´¹ç”¨å¢é•¿ï¼Œå…¶ä¸­ feeGrowthGlobal0E18 = (feeGrowthGlobal0X128 * 10**18) >> 128ï¼Œä»¥ä¿æŒåç»­æ•°æ®å­˜å‚¨çš„ç²¾åº¦
        uint256 feeGrowthGlobal0E18;
        // feeGrowthGlobal1E18 token1 çš„å…¨çƒè´¹ç”¨å¢é•¿ï¼Œå…¶ä¸­ feeGrowthGlobal1E18 = (feeGrowthGlobal1X128 * 10**18) >> 128ï¼Œä»¥ä¿æŒåç»­æ•°æ®å­˜å‚¨çš„ç²¾åº¦
        uint256 feeGrowthGlobal1E18;
        // token0 ä¸Šé™ tick ä¹‹å¤–çš„è´¹ç”¨å¢é•¿ï¼Œå…¶ä¸­ feeGrowthOutsideUpper0E18 = (feeGrowthOutsideUpper0X128 * 10**18) >> 128ï¼Œä»¥ä¿æŒåç»­æ•°æ®å­˜å‚¨çš„ç²¾åº¦
        uint256 feeGrowthOutsideUpper0E18;
        // token0 ä¸‹é™ tick ä¹‹å¤–çš„è´¹ç”¨å¢é•¿ï¼Œå…¶ä¸­ feeGrowthOutsideLower0E18 = (feeGrowthOutsideLower0X128 * 10**18) >> 128ï¼Œä»¥ä¿æŒåç»­æ•°æ®å­˜å‚¨çš„ç²¾åº¦
        uint256 feeGrowthOutsideLower0E18;
        // åœ¨æœ€åä¸€æ¬¡é“¸é€ /é”€æ¯/æŒ‘åŠ¨ token0 æ—¶çš„è´¹ç”¨å¢é•¿èŒƒå›´å†…ï¼Œå…¶ä¸­ feeGrowthInside0LastE18 = (feeGrowthInside0LastX128 * 10**18) >> 128ï¼Œä»¥ä¿æŒåç»­æ•°æ®å­˜å‚¨çš„ç²¾åº¦
        uint256 feeGrowthInside0LastE18;
        // token1 ä¸Šé™ tick ä¹‹å¤–çš„è´¹ç”¨å¢é•¿ï¼Œå…¶ä¸­ feeGrowthOutsideUpper1E18 = (feeGrowthOutsideUpper1X128 * 10**18) >> 128ï¼Œä»¥ä¿æŒåç»­æ•°æ®å­˜å‚¨çš„ç²¾åº¦
        uint256 feeGrowthOutsideUpper1E18;
        // token1 ä¸‹é™ tick ä¹‹å¤–çš„è´¹ç”¨å¢é•¿ï¼Œå…¶ä¸­ feeGrowthOutsideLower1E18 = (feeGrowthOutsideLower1X128 * 10**18) >> 128ï¼Œä»¥ä¿æŒåç»­æ•°æ®å­˜å‚¨çš„ç²¾åº¦
        uint256 feeGrowthOutsideLower1E18;
        // åœ¨æœ€åä¸€æ¬¡é“¸é€ /é”€æ¯/æŒ‘åŠ¨ token1 æ—¶çš„è´¹ç”¨å¢é•¿èŒƒå›´å†…ï¼Œå…¶ä¸­ feeGrowthInside1LastE18 = (feeGrowthInside1LastX128 * 10**18) >> 128ï¼Œä»¥ä¿æŒåç»­æ•°æ®å­˜å‚¨çš„ç²¾åº¦
        uint256 feeGrowthInside1LastE18;
    }

### LiquidityInRangeValues

    // è¡¨ç¤ºèŒƒå›´å†…æµåŠ¨æ€§çš„ç»“æ„ä½“ï¼Œç”¨äº ShadowMint å’Œ ShadowBurn äº‹ä»¶
    struct LiquidityInRangeValues {
        // è¯¥ä½ç½®çš„èŒƒå›´å†…æµåŠ¨æ€§
        uint128 positionLiquidityInRange;
        // äº‹ä»¶å‰çš„æ€»èŒƒå›´å†…æµåŠ¨æ€§
        uint128 totalLiquidityInRangeBefore;
        // äº‹ä»¶åçš„æ€»èŒƒå›´å†…æµåŠ¨æ€§
        uint128 totalLiquidityInRangeAfter;
    }

## Shadow äº‹ä»¶

### ShadowSwap

æˆ‘ä»¬åœ¨åŸå§‹çš„ `Swap` äº‹ä»¶åŸºç¡€ä¸Šè¿›è¡Œäº†æ‰©å±•ï¼Œä»¥ï¼š

*   æ·»åŠ  `freeGrowthGlobal`ï¼Œä½¿æˆ‘ä»¬èƒ½å¤ŸæŸ¥çœ‹æ¯ä¸ªäº¤æ¢å¦‚ä½•è´¡çŒ®äºæ± è´¹ç”¨
*   æ·»åŠ åŸºäºäº¤æ¢æ—¶ Chainlink oracle çš„ ETH-USD ä»·æ ¼çš„äº¤æ¢ `USDAmountE6`
*   åœ¨ `SwapInfo` å’Œ `PoolInfo` ç»“æ„ä½“ä¸­æ·»åŠ æœ‰ç”¨çš„å…ƒæ•°æ®ï¼Œä¾‹å¦‚ä»£å¸ç¬¦å·å’Œä»£å¸å°æ•°ä½æ•°ã€‚

    /// @notice ç”±æ± å‘å¸ƒçš„ä»»ä½• token0 å’Œ token1 ä¹‹é—´çš„äº¤æ¢äº‹ä»¶
    /// @param swapInfo ç»“æ„ä½“ï¼ŒåŒ…å«æœ‰å…³äº¤æ¢çš„åŸºæœ¬ä¿¡æ¯
    /// @param poolInfo ç»“æ„ä½“ï¼ŒåŒ…å«æœ‰å…³æ± çš„åŸºæœ¬ä¿¡æ¯
    /// @param feeGrowthGlobal0E18 token0 çš„å…¨å±€è´¹ç”¨å¢é•¿ï¼Œå…¶ä¸­ feeGrowthGlobal0E18 = (feeGrowthGlobal0X128 * 10**18) >> 128ï¼Œä»¥ä¾¿è¿›è¡Œä¸‹æ¸¸æ•°æ®å­˜å‚¨å¹¶ä¿æŒç²¾åº¦
    /// @param feeGrowthGlobal1E18 token1 çš„å…¨å±€è´¹ç”¨å¢é•¿ï¼Œå…¶ä¸­ feeGrowthGlobal1E18 = (feeGrowthGlobal1X128 * 10**18) >> 128ï¼Œä»¥ä¾¿è¿›è¡Œä¸‹æ¸¸æ•°æ®å­˜å‚¨å¹¶ä¿æŒç²¾åº¦
    event ShadowSwap(
        SwapInfo swapInfo,
        PoolInfo poolInfo,
        uint256 feeGrowthGlobal0E18,
        uint256 feeGrowthGlobal1E18,
        int256 chainlinkETHUSDPriceE8
    );

### TickCrossed

è¿™ä¸ªäº‹ä»¶åœ¨åŸå§‹åˆçº¦ä¸­æ ¹æœ¬ä¸å­˜åœ¨ã€‚å½“ä¸€æ¬¡äº¤æ¢å¯¼è‡´æ± ä»·æ ¼ç§»åŠ¨è¶³å¤Ÿä»¥è·¨è¶Šåˆ°å¦ä¸€ä¸ªä»·æ ¼åˆ»åº¦æ—¶ï¼Œä¼šå‘å‡ºè¯¥äº‹ä»¶ã€‚å¦‚æœäº¤æ¢é‡‘é¢è¶³å¤Ÿå¤§ï¼Œå¯ä»¥è·¨è¶Šå¤šä¸ªåˆ»åº¦ï¼Œå› æ­¤ä¼šå‘å‡ºå¤šä¸ª `TickCrossed` äº‹ä»¶ã€‚

`TickCrossed` äº‹ä»¶åŒ…å«äº†æ‰€æœ‰æ–°è·¨è¶Šåˆ»åº¦çš„çŠ¶æ€ã€‚è¿™äº›æ•°æ®å¯¹äºåœ¨ä»»ä½•ç»™å®šæ—¶é—´å…¨é¢äº†è§£æ± çš„æµåŠ¨æ€§çŠ¶æ€è‡³å…³é‡è¦ï¼Œå¹¶ä¸”å¯¹åˆ†ææµåŠ¨æ€§æä¾›è€…çš„ç›ˆåˆ©èƒ½åŠ›ç‰¹åˆ«æœ‰å¸®åŠ©ã€‚

    /// @notice å½“è·¨è¶Šä¸€ä¸ªåˆ»åº¦æ—¶å‘å‡º
    /// @param tick è¢«è·¨è¶Šçš„åˆ»åº¦çš„ç´¢å¼•
    /// @param liquidityGross å‚è€ƒæ­¤åˆ»åº¦çš„æ€»ä½ç½®æµåŠ¨æ€§
    /// @param liquidityNet è·¨è¶Šåˆ»åº¦æ—¶æ·»åŠ ï¼ˆå‡å»ï¼‰çš„å‡€æµåŠ¨æ€§ï¼Œæ–¹å‘ä¸ºä»å·¦åˆ°å³ï¼ˆä»å³åˆ°å·¦ï¼‰
    /// @param feeGrowthOutside0E18 æ­¤åˆ»åº¦å¦ä¸€ä¾§ token0 çš„æ¯å•ä½æµåŠ¨æ€§çš„è´¹ç”¨å¢é•¿ï¼ˆç›¸å¯¹äºå½“å‰åˆ»åº¦ï¼‰ã€‚ä»…å…·æœ‰ç›¸å¯¹æ„ä¹‰ï¼Œç»å¯¹æ— æ„ä¹‰â€”â€”è¯¥å€¼å–å†³äºåˆ»åº¦ä½•æ—¶åˆå§‹åŒ–ã€‚ feeGrowthOutside0E18 = (feeGrowthOutside0X128 * 10**18) >> 128ï¼Œä»¥ä¾¿è¿›è¡Œä¸‹æ¸¸æ•°æ®å­˜å‚¨å¹¶ä¿æŒç²¾åº¦
    /// @param feeGrowthOutside1E18 æ­¤åˆ»åº¦å¦ä¸€ä¾§ token1 çš„æ¯å•ä½æµåŠ¨æ€§çš„è´¹ç”¨å¢é•¿ï¼ˆç›¸å¯¹äºå½“å‰åˆ»åº¦ï¼‰ã€‚ä»…å…·æœ‰ç›¸å¯¹æ„ä¹‰ï¼Œç»å¯¹æ— æ„ä¹‰â€”â€”è¯¥å€¼å–å†³äºåˆ»åº¦ä½•æ—¶åˆå§‹åŒ–ã€‚ feeGrowthOutside1E18 = (feeGrowthOutside1X128 * 10**18) >> 128ï¼Œä»¥ä¾¿è¿›è¡Œä¸‹æ¸¸æ•°æ®å­˜å‚¨å¹¶ä¿æŒç²¾åº¦
    /// @param tickCumulativeOutside æ­¤åˆ»åº¦å¦ä¸€ä¾§çš„ç´¯ç§¯åˆ»åº¦å€¼
    /// @param secondsPerLiquidityOutsideX128 æ­¤åˆ»åº¦å¦ä¸€ä¾§æ¯å•ä½æµåŠ¨æ€§çš„ç§’æ•°ï¼ˆç›¸å¯¹äºå½“å‰åˆ»åº¦ï¼‰ã€‚ä»…å…·æœ‰ç›¸å¯¹æ„ä¹‰ï¼Œç»å¯¹æ— æ„ä¹‰â€”â€”æ­¤å€¼å–å†³äºåˆ»åº¦ä½•æ—¶åˆå§‹åŒ–
    /// @param secondsOutside åœ¨æ­¤åˆ»åº¦å¦ä¸€ä¾§èŠ±è´¹çš„ç§’æ•°ï¼ˆç›¸å¯¹äºå½“å‰åˆ»åº¦ï¼‰ã€‚ä»…å…·æœ‰ç›¸å¯¹æ„ä¹‰ï¼Œç»å¯¹æ— æ„ä¹‰â€”â€”æ­¤å€¼å–å†³äºåˆ»åº¦ä½•æ—¶åˆå§‹åŒ–
    event TickCrossed(
        int24 indexed tick,
        uint128 liquidityGross,
        int128 liquidityNet,
        uint256 feeGrowthOutside0E18,
        uint256 feeGrowthOutside1E18,
        int56 tickCumulativeOutside,
        uint160 secondsPerLiquidityOutsideX128,
        uint32 secondsOutside
    );

### ShadowMint

æˆ‘ä»¬åœ¨åŸå§‹çš„ `Mint` äº‹ä»¶åŸºç¡€ä¸Šè¿›è¡Œäº†æ‰©å±•ï¼Œä»¥ï¼š

*   åœ¨ `PositionFeeValues` ç»“æ„ä½“ä¸­æ·»åŠ  `feeGrowthGlobal`ã€`feeGrowthOutside` å’Œ `feeGrowthInsideLast` ç­‰å€¼ï¼Œè¿™ä½¿æˆ‘ä»¬èƒ½å¤Ÿè®¡ç®— [æœªæ”¶å–çš„è´¹ç”¨](https://blog.uniswap.org/uniswap-v3-math-primer?ref=blog.shadow.xyz#what-is-a-q-notation)
*   åœ¨ `LiquidityInRangeValues` ç»“æ„ä½“ä¸­æ·»åŠ å…³äºèŒƒå›´å†…ä¸èŒƒå›´å¤–æµåŠ¨æ€§çš„å€¼
*   æ·»åŠ ä¸€äº›å…³äºä½ç½®çš„æœ‰ç”¨å…ƒæ•°æ®ï¼Œä»¥åŠåŒºå—ä¸­çš„ Chainlink oracle ETH-USD ä»·æ ¼

åœ¨ `ShadowMint` äº‹ä»¶ä¸­åŒ…å«çš„é™„åŠ å€¼å¯¹äºåˆ†ææµåŠ¨æ€§æä¾›è€…çš„ç›ˆåˆ©èƒ½åŠ›ä»¥åŠé©±åŠ¨ä»–ä»¬è¡Œä¸ºå’Œç­–ç•¥çš„é‡è¦æ€§ã€‚

    /// @notice å½“ä¸ºç»™å®šä½ç½®é“¸é€ æµåŠ¨æ€§æ—¶å‘å‡º
    /// @param positionDetails ç»“æ„ä½“ï¼ŒåŒ…å«æœ‰å…³æ‰€æœ‰è€…ã€å‘é€è€…ã€åˆ»åº¦èŒƒå›´ã€æµåŠ¨æ€§å’Œä»£å¸æ•°é‡ä»¥åŠ Shadow positionId çš„ä¿¡æ¯
    /// @param positionFeeValues ç»“æ„ä½“ï¼ŒåŒ…å«æœ‰å…³ token0 å’Œ token1 çš„å…¨å±€è´¹ç”¨å¢é•¿ã€å¤–éƒ¨è´¹ç”¨å¢é•¿å’Œå†…éƒ¨è´¹ç”¨å¢é•¿çš„ä¿¡æ¯ï¼Œæœ‰åŠ©äºè®¡ç®—å¤´å¯¸è´¹ç”¨
    /// @param liquidityInRangeValues ç»“æ„ä½“ï¼ŒåŒ…å«æœ‰å…³ä½ç½®èŒƒå›´å†…æµåŠ¨æ€§çš„ä¿¡æ¯ï¼Œä»¥åŠäº‹ä»¶å‰åçš„æ€»èŒƒå›´å†…æµåŠ¨æ€§
    /// @param poolInfo ç»“æ„ä½“ï¼ŒåŒ…å«æœ‰å…³æ± çš„åŸºæœ¬ä¿¡æ¯
    /// @param tick é“¸é€ åæ± ä»·æ ¼çš„ä»¥ 1.0001 ä¸ºåº•çš„å¯¹æ•°
    event ShadowMint(
        PositionDetails positionDetails,
        PositionFeeValues positionFeeValues,
        LiquidityInRangeValues liquidityInRangeValues,
        PoolInfo poolInfo,
        int24 tick,
        int256 chainlinkETHUSDPriceE8
    );

### ShadowBurn

æˆ‘ä»¬åœ¨åŸå§‹çš„ `Burn` äº‹ä»¶åŸºç¡€ä¸Šè¿›è¡Œäº†æ‰©å±•ï¼Œä»¥ï¼š

*   åœ¨ `PositionFeeValues` ç»“æ„ä½“ä¸­æ·»åŠ  `feeGrowthGlobal`ã€`feeGrowthOutside` å’Œ `feeGrowthInsideLast` ç­‰å€¼ï¼Œè¿™ä½¿æˆ‘ä»¬èƒ½å¤Ÿè®¡ç®— [æœªæ”¶å–çš„è´¹ç”¨](https://blog.uniswap.org/uniswap-v3-math-primer?ref=blog.shadow.xyz#what-is-a-q-notation)
*   æ·»åŠ è¯¥å¤´å¯¸è·å¾—çš„è´¹ç”¨ï¼Œè¿™åœ¨åŸå§‹åˆçº¦çš„ `Burn` äº‹ä»¶ä¸­å¹¶æ²¡æœ‰è¯¦ç»†ä¿¡æ¯
*   åœ¨ `LiquidityInRangeValues` ç»“æ„ä½“ä¸­æ·»åŠ å…³äºèŒƒå›´å†…ä¸èŒƒå›´å¤–æµåŠ¨æ€§çš„å€¼
*   æ·»åŠ ä¸€äº›å…³äºä½ç½®çš„æœ‰ç”¨å…ƒæ•°æ®ï¼Œä»¥åŠåŒºå—ä¸­çš„ Chainlink oracle ETH-USD ä»·æ ¼

åœ¨ `ShadowBurn` äº‹ä»¶ä¸­åŒ…å«çš„é™„åŠ å€¼å¯¹äºåˆ†ææµåŠ¨æ€§æä¾›è€…çš„ç›ˆåˆ©èƒ½åŠ›ï¼Œä»¥åŠé©±åŠ¨ä»–ä»¬è¡Œä¸ºå’Œç­–ç•¥çš„é‡è¦æ€§ã€‚

    /// @notice å½“ç§»é™¤å¤´å¯¸çš„æµåŠ¨æ€§æ—¶å‘å‡º
    /// @dev ä¸ä¼šæå–æµåŠ¨æ€§å¤´å¯¸æ‰€èµšå–çš„ä»»ä½•è´¹ç”¨ï¼Œå¿…é¡»é€šè¿‡ #collect æå–
    /// @param positionDetails ç»“æ„ä½“ï¼ŒåŒ…å«æœ‰å…³æ‰€æœ‰è€…ã€å‘é€è€…ã€åˆ»åº¦èŒƒå›´ã€æµåŠ¨æ€§å’Œä»£å¸æ•°é‡ä»¥åŠ Shadow positionId çš„ä¿¡æ¯
    /// @param feesEarned ç»“æ„ä½“ï¼ŒåŒ…å«æœ‰å…³å¤´å¯¸èµšå–çš„è´¹ç”¨çš„ä¿¡æ¯ï¼›ä» amount0 å’Œ amount1 ä¸­å‡å» feesEarned ä»¥è®¡ç®—ç”¨äºé“¸é€ å¤´å¯¸çš„ token0 å’Œ token1
    /// @param positionFeeValues ç»“æ„ä½“ï¼ŒåŒ…å«æœ‰å…³ token0 å’Œ token1 çš„å…¨å±€è´¹ç”¨å¢é•¿ã€å¤–éƒ¨è´¹ç”¨å¢é•¿å’Œå†…éƒ¨è´¹ç”¨å¢é•¿çš„ä¿¡æ¯ï¼Œæœ‰åŠ©äºè®¡ç®—å¤´å¯¸è´¹ç”¨
    /// @param liquidityInRangeValues ç»“æ„ä½“ï¼ŒåŒ…å«æœ‰å…³å¤´å¯¸èŒƒå›´å†…æµåŠ¨æ€§çš„ä¿¡æ¯ï¼Œä»¥åŠäº‹ä»¶å‰åçš„æ€»èŒƒå›´å†…æµåŠ¨æ€§
    /// @param poolInfo ç»“æ„ä½“ï¼ŒåŒ…å«æœ‰å…³æ± çš„åŸºæœ¬ä¿¡æ¯
    /// @param tick çƒ§æ‰åæ± ä»·æ ¼çš„ä»¥ 1.0001 ä¸ºåº•çš„å¯¹æ•°
    event ShadowBurn(
        PositionDetails positionDetails,
        FeesEarned feesEarned,
        PositionFeeValues positionFeeValues,
        LiquidityInRangeValues liquidityInRangeValues,
        PoolInfo poolInfo,
        int24 tick,
        int256 chainlinkETHUSDPriceE8
    );

### ShadowCollect

æˆ‘ä»¬æ‰©å±•äº†åŸå§‹çš„ `Collect` äº‹ä»¶ä»¥ï¼š

*   æ·»åŠ åŒºå—ä¸­ Chainlink é¢„è¨€æœºçš„ ETH-USD ä»·æ ¼

    /// @notice å½“å¤´å¯¸çš„æ‰€æœ‰è€…æ”¶å–è´¹ç”¨æ—¶å‘å‡º
    /// @dev å½“è°ƒç”¨è€…é€‰æ‹©ä¸æ”¶å–è´¹ç”¨æ—¶ï¼Œæ”¶é›†äº‹ä»¶å¯èƒ½ä¼šå‘å‡ºé›¶ amount0 å’Œ amount1
    /// @param owner æ”¶å–è´¹ç”¨çš„å¤´å¯¸æ‰€æœ‰è€…ï¼›å¦‚æœé€šè¿‡ NonfungiblePositionManager è°ƒç”¨ï¼Œå°†æ˜¯ NonfungiblePositionManager çš„ msg.sender
    /// @param recipient æ”¶å–çš„è´¹ç”¨çš„æ¥æ”¶è€…
    /// @param tickLower å¤´å¯¸çš„ä¸‹é™ tick
    /// @param tickUpper å¤´å¯¸çš„ä¸Šé™ tick
    /// @param amount0 æ”¶å–çš„ token0 è´¹ç”¨æ•°é‡
    /// @param amount1 æ”¶å–çš„ token1 è´¹ç”¨æ•°é‡
    event ShadowCollect(
        address indexed owner,
        address recipient,
        int24 indexed tickLower,
        int24 indexed tickUpper,
        uint128 amount0,
        uint128 amount1,
        int256 chainlinkETHUSDPriceE8
    );

### PoolLiquidityAtTickSpace

æ­¤äº‹ä»¶åœ¨åŸå§‹åˆçº¦ä¸­å®Œå…¨ä¸å­˜åœ¨ã€‚å½“å‘ç”ŸæµåŠ¨æ€§ `mint` æˆ– `burn` æ—¶ï¼Œä¼šå‘å‡ºè¯¥äº‹ä»¶ï¼Œå¹¶åŒ…å«ï¼š

*   æµåŠ¨æ€§å¤´å¯¸çš„æ¯ä¸ª tick-space çš„æ›´æ–°æ€»æµåŠ¨æ€§ï¼Œåœ¨ `mint` æˆ– `burn` å®Œæˆå
*   å½“ tick ä»å·¦åˆ°å³è·¨è¶Šæ—¶æ›´æ–°çš„å‡€æµåŠ¨æ€§æ•°é‡

å¯¹äºæ¯ä¸ªæµåŠ¨æ€§å¤´å¯¸çš„ `mint` æˆ– `burn`ï¼Œè‡³å°‘ä¼šå‘å‡ºä¸€ä¸ª `PoolLiquidityAtTickSpace` äº‹ä»¶ï¼Œå¹¶ä¸”å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œä¸€ä¸ªæµåŠ¨æ€§å¤´å¯¸çš„ `mint` æˆ– `burn` ä¼šå‘å‡ºå¤šä¸ª `PoolLiquidityAtTickSpace` äº‹ä»¶ï¼Œå› ä¸ºå¤§å¤šæ•°æµåŠ¨æ€§å¤´å¯¸è·¨è¶Šå¤šä¸ª tick-spacesã€‚

`PoolLiquidityAtTickSpace` äº‹ä»¶å¯¹äºç”Ÿæˆä»»æ„ç»™å®šåŒºå—é«˜åº¦çš„æ± æµåŠ¨æ€§åˆ†å¸ƒå›¾è‡³å…³é‡è¦ã€‚

    /// @notice åœ¨æµåŠ¨æ€§é“¸é€ å’Œé”€æ¯æ—¶å‘å‡ºï¼›åŒ…æ‹¬å¤´å¯¸æ¯ä¸ª tick ç©ºé—´çš„æ± æµåŠ¨æ€§
    /// @param tickSpaceLower tick ç©ºé—´çš„ä¸‹ç•Œï¼›æ¯ä¸ª tick ç©ºé—´çš„å¤§å°ä¸º tickSpacingï¼ˆä¾‹å¦‚ï¼Œå¦‚æœ tickSpacing = 10ï¼Œåˆ™ tickSpaceLower ä¸º 201250 çš„ tick ç©ºé—´è·¨åº¦ä¸º [201250, 201260)ï¼‰
    /// @param poolLiquidityAtTickSpace å¦‚æœæ´»åŠ¨ tick ä½äº [tickSpaceLower, tickSpaceLower + tickSpacing) å†…ï¼Œæ± çš„æµåŠ¨æ€§
    /// @param liquidityNet å½“ tick ä»å·¦åˆ°å³ï¼ˆå³åˆ°å·¦ï¼‰è·¨è¶Šæ—¶æ·»åŠ ï¼ˆå‡å»ï¼‰çš„å‡€æµåŠ¨æ€§æ•°é‡
    /// @param poolInfo æœ‰å…³æ± çš„åŸºæœ¬ä¿¡æ¯çš„ç»“æ„
    /// @param positionId ä» ownerã€tickLower å’Œ tickUpper çš„ keccak256 å“ˆå¸Œç”Ÿæˆçš„ Shadow positionId
    event PoolLiquidityAtTickSpace(
        int24 tickSpaceLower,
        uint128 poolLiquidityAtTickSpace,
        int128 liquidityNet,
        PoolInfo poolInfo,
        bytes32 positionId
    );

## ç»“è®º

Shadow èµ‹äºˆä½ å°†ç¦»çº¿äº‹ä»¶æ—¥å¿—æ·»åŠ åˆ°ä»»ä½•å·²éƒ¨ç½²æ™ºèƒ½åˆçº¦çš„è¶…èƒ½åŠ›ï¼Œé€šè¿‡ä¸€ä¸ªæ˜“äºä½¿ç”¨çš„æ‰˜ç®¡å¹³å°ï¼Œæ¶ˆé™¤äº†å¯¹å¤æ‚æ•°æ®ç®¡é“å’Œå…¶ä»–èŠ‚ç‚¹åŸºç¡€è®¾æ–½çš„éœ€æ±‚ã€‚

Shadow äº‹ä»¶å¸¦æ¥äº†æ˜æ˜¾çš„å¥½å¤„ï¼š

1.  **æ›´æ·±å…¥çš„æ•°æ®è¦†ç›–**ï¼šé€šè¿‡è®¿é—®ä»¥å‰æ— æ³•è®¿é—®ï¼ˆæˆ–éå¸¸éš¾ä»¥è®¿é—®ï¼‰çš„é“¾ä¸Šæ•°æ®ï¼Œç”Ÿæˆå…¨æ–°çš„äº‹ä»¶ï¼Œé’ˆå¯¹ä»»ä½•æ™ºèƒ½åˆçº¦ã€‚
2.  **ç®€åŒ–çš„æ•°æ®ç®¡é“**ï¼šé€šè¿‡ç›´æ¥åœ¨æ™ºèƒ½åˆçº¦ä¸­ç¼–å†™è½¬æ¢é€»è¾‘ï¼Œå¤§å¹…é™ä½æ•°æ®ç®¡é“çš„å¤æ‚æ€§ã€‚
3.  **æ›´å¿«çš„è¿­ä»£å‘¨æœŸ**ï¼šä½¿ç”¨ä½ å·²ç»ç†Ÿæ‚‰çš„å·¥å…·å¿«é€Ÿæµ‹è¯•ã€éªŒè¯å’Œè¿­ä»£ Shadow äº‹ä»¶ã€‚
4.  **æ— æƒé™ã€æ—  gas æ—¥å¿—è®°å½•**ï¼šæ— æƒé™åœ°åœ¨ä½ æƒ³è¦çš„ä»»ä½•åˆçº¦ä¸Šæ·»åŠ ä»»æ„å¤šçš„äº‹ä»¶ï¼Œè€Œä¸ä¼šå¢åŠ æœ€ç»ˆç”¨æˆ·çš„ gas è´Ÿæ‹…ã€‚

æœ‰äº† Shadowï¼Œä¸€ä¸ªäººå¯ä»¥åœ¨ä¸€ä¸ªä¸‹åˆæ„å»ºä¸€ä¸ªå¼ºå¤§çš„é“¾ä¸Šæ•°æ®ç´¢å¼•å™¨ï¼Œè€Œæ— éœ€è®¾ç½®ä»»ä½•ç®¡é“æˆ–åŸºç¡€è®¾æ–½ã€‚è¿™ä½¿ä½ èƒ½å¤Ÿæ›´å¿«åœ°å°†äº§å“æ¨å‘å¸‚åœºï¼Œå¹¶æ›´å¿«åœ°è¿›è¡ŒåŸºäºæ•°æ®çš„è¿­ä»£ï¼ˆè¯·å‚è§ Pendle å¦‚ä½•é€šè¿‡ Shadow å°†å…¶äº¤æ˜“è·¯ç”±æ”¹è¿› 34% çš„ [æ¡ˆä¾‹ç ”ç©¶](https://blog.shadow.xyz/pendle-case-study/)ï¼‰ã€‚

æˆ‘ä»¬å»ºç«‹äº† [ä¸€ä¸ªä»ªè¡¨ç›˜](https://www.univ3.xyz/?ref=blog.shadow.xyz)ï¼Œåˆ©ç”¨è¿™ä¸ªæ•°æ®é›†å’Œæˆ‘ä»¬æœ€è¿‘æ¨å‡ºçš„ [å®æ—¶æ•°æ®åº“åŒæ­¥](https://x.com/shadowxyz/status/1812913757573816806?ref=blog.shadow.xyz) æ¥å±•ç¤ºä½ å¯ä»¥ç”¨ Shadow æ„å»ºçš„å†…å®¹ã€‚

![](https://img.learnblockchain.cn/attachments/migrate/1736821767148)

æ„Ÿè°¢ [Austin Adams](https://x.com/AustinAdams10?ref=blog.shadow.xyz) å’Œ [Dan Robinson](https://x.com/danrobinson?ref=blog.shadow.xyz) åœ¨è¿™äº› Shadow äº‹ä»¶ä¸Šçš„åˆä½œï¼Œæ„Ÿè°¢ [Achal](https://x.com/achalvs?ref=blog.shadow.xyz) è®¾è®¡ä»ªè¡¨ç›˜ï¼Œä»¥åŠ [Ciamac Moallemi](https://x.com/ciamac?ref=blog.shadow.xyz)ã€[saucepoint](https://x.com/saucepoint?ref=blog.shadow.xyz)ã€[Alex Nezlobin](https://x.com/0x94305?ref=blog.shadow.xyz)ã€[Storm](https://x.com/notnotstorm?ref=blog.shadow.xyz) å’Œå…¶ä»–äººå¯¹ [univ3.xyz](https://www.univ3.xyz/?ref=blog.shadow.xyz) çš„åé¦ˆã€‚

> æˆ‘æ˜¯ [AI ç¿»è¯‘å®˜](https://learnblockchain.cn/people/19584)ï¼Œä¸ºå¤§å®¶è½¬è¯‘ä¼˜ç§€è‹±æ–‡æ–‡ç« ï¼Œå¦‚æœ‰ç¿»è¯‘ä¸é€šçš„åœ°æ–¹ï¼Œåœ¨[è¿™é‡Œ](https://github.com/lbc-team/Pioneer/blob/master/translations/10596.md)ä¿®æ”¹ï¼Œè¿˜è¯·åŒ…æ¶µï½