
>- åŸæ–‡é“¾æ¥ï¼šhttps://fsjohnny.medium.com/zero-to-hero-with-solana-token-2022-transfer-hook-7d5454891a22
>- è¯‘è€…ï¼š[AIç¿»è¯‘å®˜](https://learnblockchain.cn/people/19584)ï¼Œæ ¡å¯¹ï¼š[ç¿»è¯‘å°ç»„](https://learnblockchain.cn/people/412)
>- æœ¬æ–‡æ°¸ä¹…é“¾æ¥ï¼š[learnblockchain.cn/articleâ€¦](https://learnblockchain.cn/article/9689)
    
# ä»é›¶åˆ°è‹±é›„çš„ Solana ä»£å¸ 2022 â€” Transfer Hook ğŸª

![](https://img.learnblockchain.cn/attachments/migrate/1730184463920)

ç…§ç‰‡ç”± [Fabian Blank](https://unsplash.com/@blankerwahnsinn?utm_content=creditCopyText&utm_medium=referral&utm_source=unsplash) æ‹æ‘„ï¼Œå‘å¸ƒåœ¨ [Unsplash](https://unsplash.com/photos/pink-pig-figurine-on-white-surface-pElSkGRA2NU?utm_content=creditCopyText&utm_medium=referral&utm_source=unsplash)

Token 2022 è®¡åˆ’å¼•å…¥äº†å‡ é¡¹ä»¤äººå…´å¥‹çš„æ‰©å±•ï¼Œå¢å¼ºäº†é“¸é€ å’Œä»£å¸è´¦æˆ·çš„åŠŸèƒ½ã€‚åœ¨è¿™äº›åŠŸèƒ½ä¸­ï¼Œæˆ‘ä¸ªäººæœ€å–œæ¬¢çš„æ˜¯Transfer Hook ï¼ˆè½¬è´¦é’©å­ï¼‰ ğŸªã€‚

## æƒ³è±¡æ—¶é—´

è®©æˆ‘ä»¬æˆ´ä¸Šæƒ³è±¡çš„å¸½å­ï¼Œæƒ³è±¡ä¸€ä¸‹è¿™ä¸ªç¾å¥½çš„åœºæ™¯ï¼šä½ æ˜¯ä¸€ä¸ª NFT é¡¹ç›®çš„æ‰€æœ‰è€…ã€‚ä½ å‘æŒæœ‰è€…å‘æ”¾ä»£å¸ï¼Œä»¥å¥–åŠ±ä»–ä»¬å°† NFT æŠµæŠ¼ç»™ä½ ã€‚ä½ å°†ä½ çš„é¡¹ç›®è§†ä¸ºä¸€ä¸ªâ€œå°é—­ç¤¾åŒºâ€ï¼Œè¿™æ„å‘³ç€åªæœ‰ä½ çš„ NFT æŒæœ‰è€…æ‰èƒ½æŒæœ‰ä½ çš„ä»£å¸ã€‚åœ¨æ²¡æœ‰è½¬è´¦é’©å­ä¹‹å‰ï¼Œä½ å¿…é¡»æ„å»ºè‡ªå·±çš„ç¨‹åºæ¥å¤„ç†è½¬è´¦ï¼Œä»¥å¼ºåˆ¶æ‰§è¡Œè¿™ç§è¡Œä¸ºã€‚ä½†æœ‰äº†è½¬è´¦é’©å­ï¼Œè¿™å°±éå¸¸ç®€å•äº†ï¼ä½ åªéœ€è¦æ„å»ºä¸€ä¸ªè½¬è´¦é’©å­ç¨‹åºï¼ŒéªŒè¯è½¬è´¦çš„ç›®æ ‡åœ°å€æ˜¯å¦ç¡®å®æ˜¯ç™½åå•åœ°å€ä¹‹ä¸€ï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™åœæ­¢äº¤æ˜“ã€‚å¦ä¸€ä¸ªä¾‹å­ï¼Ÿå‡è®¾ä½ å¸Œæœ›ç”¨æˆ·åœ¨æ¯æ¬¡è¿›è¡Œä»£å¸è½¬è´¦æ—¶æ”¯ä»˜é¢å¤–è´¹ç”¨â€¦â€¦æ²¡é—®é¢˜ï¼è¿™ä¹Ÿå¯ä»¥é€šè¿‡æ„å»ºä¸€ä¸ªå¤„ç†è½¬è´¦çš„é’©å­æ¥å®ç°ï¼

ç°åœ¨ï¼Œåœ¨ NFT é¡¹ç›®çš„èƒŒæ™¯ä¸‹ï¼Œè¿™äº›ä¾‹å­å¯èƒ½çœ‹èµ·æ¥æœ‰äº›æ„šè ¢ï¼Œä½†æƒ³è±¡ä¸€ä¸‹æ›´å¤§çš„å›¾æ™¯ï¼Œè¿™æ ·çš„é’©å­å¯ä»¥å¸®åŠ©éµå®ˆç›‘ç®¡è¦æ±‚ï¼Œä¾‹å¦‚å¼ºåˆ¶æ‰§è¡ŒæŒæœ‰æœŸæˆ–è®¾ç½®ä»£å¸çš„æœ€å¤§æŒæœ‰é‡ã€‚

## Transfer Hook â€” å®ƒåˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ

é¡¾åæ€ä¹‰ï¼ŒTransfer Hook æ‰©å±•ä¸ä»£å¸è½¬è´¦å¯†åˆ‡ç›¸å…³ã€‚æ¯å½“ä¸€ä¸ªé“¸é€ é…ç½®äº† Transfer Hook æ—¶ï¼Œæ¯æ¬¡åœ¨è¯¥é“¸é€ ä¸Šæ‰§è¡Œè½¬è´¦æŒ‡ä»¤æ—¶ï¼Œéƒ½ä¼šè‡ªåŠ¨è§¦å‘ä¸€ä¸ªæŒ‡ä»¤ã€‚å¦‚æœè¿™ä¸ªæ¦‚å¿µçœ‹èµ·æ¥å¾ˆç†Ÿæ‚‰ï¼Œé‚£æ˜¯å› ä¸ºå®ƒç¡®å®å¦‚æ­¤â€”â€”è¿™ä¸ªæµç¨‹ä¸ web2 ä¸­çš„ webhooks å·¥ä½œæ–¹å¼éå¸¸ç›¸ä¼¼ã€‚

è½¬è´¦é’©å­æŒ‡ä»¤å¯ä»¥è®¿é—®ä¸€ä¸ªå˜é‡ï¼Œå³è½¬è´¦é‡‘é¢ï¼Œä½†æˆ‘ä»¬å¯ä»¥æä¾›ä¸€ä¸ªé¢å¤–çš„è´¦æˆ·ï¼ˆ`extra-account-meta-list`ï¼‰ï¼Œå…¶ä¸­åŒ…å«æŒ‡ä»¤å¯ä»¥ä½¿ç”¨çš„å…¶ä»–è‡ªå®šä¹‰è´¦æˆ·ã€‚æˆ‘ä»¬å¾ˆå¿«ä¼šè¯¦ç»†è®¨è®ºè¿™ä¸ªè´¦æˆ·ã€‚

è™½ç„¶è½¬è´¦é’©å­ç¡®å®å¯ä»¥è®¿é—®åˆå§‹è½¬è´¦è´¦æˆ·ï¼Œä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå®ƒä»¬ä½œä¸ºåªè¯»è´¦æˆ·ä¼ é€’ï¼Œè¿™æ„å‘³ç€å‘é€è€…çš„ç­¾åæƒé™**ä¸ä¼š**æ‰©å±•åˆ°Transfer Hookç¨‹åºã€‚

æœ€åï¼Œå½“ä½¿ç”¨ Anchor ç¼–å†™Transfer Hookç¨‹åºæ—¶ï¼Œéœ€è¦ä¸€ä¸ªå›é€€æŒ‡ä»¤æ¥æ‰‹åŠ¨åŒ¹é…åŸç”Ÿç¨‹åºæŒ‡ä»¤é‰´åˆ«å™¨å¹¶è°ƒç”¨Transfer HookæŒ‡ä»¤ã€‚è¿™æ˜¯å› ä¸º Token 2022 è®¡åˆ’æ˜¯ä¸€ä¸ªåŸç”Ÿç¨‹åºï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦â€œæ¡¥æ¥â€å…¶åŸç”Ÿæ¥å£ä¸ Anchorã€‚

## æ˜¯æ—¶å€™åŠ¨æ‰‹äº†

![](https://img.learnblockchain.cn/attachments/migrate/1730184463923)

å¥½äº†ï¼Œè¯ä¸å¤šè¯´â€”â€”è®©æˆ‘ä»¬æ„å»ºä¸€äº›ä¸œè¥¿ï¼æˆ‘ä»¬å°†æ„å»ºä¸€ä¸ªâ€œé²¸é±¼è­¦æŠ¥â€è½¬è´¦é’©å­ ğŸ‹ï¼å¯¹äºæ¯æ¬¡ä»£å¸è½¬è´¦ï¼Œè½¬è´¦é’©å­æŒ‡ä»¤å°†æ¯”è¾ƒè½¬è´¦é‡‘é¢ä¸é¢„å®šä¹‰çš„å€¼ï¼ˆä¾‹å¦‚ï¼Œ10,000 ä»£å¸ï¼‰ã€‚å¦‚æœç­‰äºæˆ–å¤§äºè¯¥å€¼ï¼Œæˆ‘ä»¬å°†æ›´æ–°ä¸€ä¸ªè´¦æˆ·ï¼Œè®°å½•æœ€æ–°çš„é²¸é±¼è¯¦æƒ…ï¼Œå¹¶å‘å‡ºä¸€ä¸ªäº‹ä»¶ä¾›å®¢æˆ·ç«¯å¤„ç†ã€‚

> âš’ï¸ ä½ å°†éœ€è¦å®‰è£… Solana CLI å·¥å…·å’Œ Anchorã€‚å¦‚æœä½ è¿˜æ²¡æœ‰å®‰è£…ï¼Œè¯·æŸ¥çœ‹ [Anchor æ–‡æ¡£](https://www.anchor-lang.com/docs/installation) ä»¥è·å–å®‰è£…è¯´æ˜ã€‚

## ç¬¬ä¸€æ­¥ï¼šè½¬è´¦é’©å­ç¨‹åº

è®©æˆ‘ä»¬è®¾è®¡æˆ‘ä»¬çš„è½¬è´¦é’©å­ç¨‹åºã€‚æˆ‘ä»¬çš„è½¬è´¦é’©å­ç¨‹åºé¦–å…ˆéœ€è¦ä¸€ä¸ªæŒ‡ä»¤ï¼Œå¯ä»¥åœ¨è½¬è´¦å®Œæˆåè°ƒç”¨ã€‚æˆ‘ä»¬å°†ä½¿ç”¨ Anchor æ„å»ºæˆ‘ä»¬çš„ç¨‹åºï¼Œç„¶è€Œï¼ŒToken 2022 è®¡åˆ’æ˜¯ä¸€ä¸ªåŸç”Ÿ Solana ç¨‹åºâ€”â€”å› æ­¤æˆ‘ä»¬éœ€è¦å¦ä¸€ä¸ªæŒ‡ä»¤ï¼šä¸€ä¸ªæŒ‡ä»¤æ¥åŒ¹é…æŒ‡ä»¤é‰´åˆ«å™¨åˆ°è½¬è´¦é’©å­çš„ `execute` æ¥å£ï¼Œå¹¶åœ¨åŒ¹é…æ—¶è°ƒç”¨ `transfer_hook` æŒ‡ä»¤ã€‚æ‰€ä»¥ç›®å‰æœ‰ä¸¤ä¸ªæŒ‡ä»¤ã€‚

å½“æˆ‘ä»¬çš„é’©å­è¢«è°ƒç”¨æ—¶ï¼Œå®ƒä¼šå°†è½¬è´¦é‡‘é¢ä¸ä¸€ä¸ªå€¼è¿›è¡Œæ¯”è¾ƒâ€”â€”ä½†è¿™ä¸ªå€¼æ¥è‡ªå“ªé‡Œï¼Ÿå½“ç„¶ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ç¨‹åºä¸­ç¡¬ç¼–ç è¿™ä¸ªå€¼â€”â€”ä½†å¦‚æœæ˜å¤©æˆ‘ä»¬å†³å®šè¦å¢åŠ /å‡å°‘è¿™ä¸ªå€¼å‘¢ï¼Ÿæˆ‘ä»¬éœ€è¦é‡æ–°éƒ¨ç½²ç¨‹åºã€‚æ›´å¥½çš„å¤„ç†æ–¹å¼æ˜¯å°†æ¯”è¾ƒå€¼ä¿å­˜åœ¨ä¸€ä¸ªè´¦æˆ·ä¸­ã€‚è¦å°†é¢å¤–çš„è´¦æˆ·ä¼ é€’ç»™è½¬è´¦é’©å­ï¼Œæˆ‘ä»¬ä½¿ç”¨ `extra_account_meta_list` è´¦æˆ·ã€‚è¿™æ˜¯ä¸€ä¸ª PDA è´¦æˆ·ï¼Œå­˜å‚¨è½¬è´¦é’©å­åœ¨è°ƒç”¨æ—¶å¯ä»¥ä½¿ç”¨çš„è´¦æˆ·ã€‚`extra_account_meta_list` è´¦æˆ·å°†å§‹ç»ˆä½¿ç”¨ç¡¬ç¼–ç å­—ç¬¦ä¸² **extra-account-metas** å’Œä»£å¸çš„é“¸é€ åœ°å€ä½œä¸ºç§å­ã€‚

ç°åœ¨ä½ å¯èƒ½ä¼šé—®è‡ªå·±ï¼Œæˆ‘ä»¬å¦‚ä½•åˆ›å»ºå’Œåˆå§‹åŒ–è¿™ä¸ª `extra_account_meta_list` è´¦æˆ·ï¼Ÿè¿™å°±æ˜¯æˆ‘ä»¬ç¨‹åºçš„ç¬¬ä¸‰ä¸ªä¹Ÿæ˜¯æœ€åä¸€ä¸ªæŒ‡ä»¤â€”â€”`initialize_extra_account_meta_list` æŒ‡ä»¤çš„ä½œç”¨ã€‚

åœ¨å®Œæˆæˆ‘ä»¬ç¨‹åºçš„é«˜å±‚è®¾è®¡åï¼Œè®©æˆ‘ä»¬å¼€å§‹å®é™…ç¼–å†™è½¬è´¦é’©å­ç¨‹åº ğŸ‰ã€‚

1. åˆ›å»ºä¸€ä¸ªæ–°çš„ Anchor é¡¹ç›®å¹¶åœ¨ä½ å–œæ¬¢çš„ IDE ä¸­æ‰“å¼€å®ƒï¼š

```sh
anchor init transfer-hook-whale
```

2. å®‰è£… **anchor-spl, spl-transfer-hook-interface** å’Œ **spl_tlv_account_resolution** cratesã€‚è¿™äº› crates åŒ…å«å¸®åŠ©å‡½æ•°å’Œæ¥å£ï¼Œä½¿æˆ‘ä»¬åœ¨å¤„ç† SPL ä»£å¸å’Œæ‰©å±•æŒ‡ä»¤æ—¶æ›´åŠ è½»æ¾ã€‚

```sh
cd programs/transfer-hook-whale
cargo add anchor-spl spl-transfer-hook-interface spl_tlv_account_resolution
```

3. ä» Anchor 0.30 å¼€å§‹ï¼Œæˆ‘ä»¬éœ€è¦å‘Šè¯‰ Anchor ä¸ºæˆ‘ä»¬ä½¿ç”¨çš„ crates ç”Ÿæˆç±»å‹å®šä¹‰ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å‘Šè¯‰å®ƒä¸º **anchor-spl** crate ç”Ÿæˆç±»å‹å®šä¹‰ã€‚æ‰“å¼€ **Cargo.toml** æ–‡ä»¶ï¼Œä½äº **programs/transfer-hook-whale** æ–‡ä»¶å¤¹å†…ï¼Œå¹¶æŒ‰å¦‚ä¸‹æ–¹å¼æ›´æ–° `idl-build`ï¼š

```toml
[features]
...
idl-build = ["anchor-lang/idl-build", "anchor-spl/idl-build"]
```

4. æ‰“å¼€ **lib.rs** å¹¶æ·»åŠ ä»¥ä¸‹ `use` è¯­å¥ï¼š

```rust
use anchor_lang::system_program::{create_account, CreateAccount};
use anchor_spl::{
    associated_token::AssociatedToken,
    token_interface::{Mint, TokenInterface},
};
use spl_transfer_hook_interface::instruction::TransferHookInstruction;

use spl_tlv_account_resolution::{
    account::ExtraAccountMeta, seeds::Seed, state::ExtraAccountMetaList,
};
use spl_transfer_hook_interface::instruction::ExecuteInstruction;
```

ä¸€ä¸ªè½¬è´¦é’©å­ç¨‹åºé€šå¸¸ç”±ä¸‰ä¸ªæŒ‡ä»¤ç»„æˆï¼š

* **initialize_extra_account_meta** â€” ä¸€ä¸ªåˆ›å»ºè´¦æˆ·ï¼ˆ`extra_account_meta_list`ï¼‰çš„æŒ‡ä»¤ï¼Œè¯¥è´¦æˆ·ä¿å­˜è½¬è´¦é’©å­å¯ä»¥ä½¿ç”¨çš„é¢å¤–è´¦æˆ·åˆ—è¡¨ã€‚  
  åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œè¿™ä¸ªè´¦æˆ·å°†ä¿å­˜æœ€æ–°â€œé²¸é±¼â€åœ°å€å’Œé‡‘é¢çš„è¯¦ç»†ä¿¡æ¯ã€‚
* **transfer_hook** â€” é’©å­æœ¬èº«ã€‚è¿™æ˜¯æ¯æ¬¡å‘ç”Ÿä»£å¸è½¬è´¦æ—¶å®é™…è°ƒç”¨çš„æŒ‡ä»¤ã€‚
* **fallback** â€” Token 2022 è®¡åˆ’æ˜¯ä¸€ä¸ªåŸç”Ÿç¨‹åºï¼Œä½†æˆ‘ä»¬ä½¿ç”¨ Anchor æ„å»ºæˆ‘ä»¬çš„ç¨‹åºï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æ·»åŠ ä¸€ä¸ªå›é€€æŒ‡ä»¤ï¼Œè¯¥æŒ‡ä»¤å°†æŒ‡ä»¤é‰´åˆ«å™¨åŒ¹é…åˆ°è½¬è´¦é’©å­çš„ `execute` æ¥å£ï¼Œå¹¶åœ¨åŒ¹é…æ—¶è°ƒç”¨æˆ‘ä»¬çš„ `transfer_hook` æŒ‡ä»¤ã€‚

## å®ç° initialize_extra_account_meta æŒ‡ä»¤
1. åœ¨ä½ çš„ **lib.rs** åº•éƒ¨ï¼Œæ·»åŠ ä»¥ä¸‹è´¦æˆ·ã€‚æ­¤è´¦æˆ·å°†ä¿å­˜æœ€æ–°â€œé²¸é±¼â€è½¬è´¦çš„è¯¦ç»†ä¿¡æ¯ï¼š

```rust
#[account]
pub struct WhaleAccount {
    pub whale_address: Pubkey,
    pub transfer_amount: u64
}
```

2. æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å®šä¹‰ `initialize_extra_account_meta` æŒ‡ä»¤æ‰§è¡Œæ‰€éœ€çš„æ‰€æœ‰è´¦æˆ·ã€‚åœ¨ `LatestWhaleAccount` ä¸Šæ–¹æ·»åŠ ä»¥ä¸‹ä»£ç ç‰‡æ®µï¼š

```rust
#[derive(Accounts)]
pub struct InitializeExtraAccountMeta<'info> {
    #[account(mut)]
    pub payer: Signer<'info>,
    /// CHECK: ExtraAccountMetaList Account, must use these exact seeds
    #[account(mut, seeds=[b"extra-account-metas", mint.key().as_ref()], bump)]
    pub extra_account_meta_list: AccountInfo<'info>,
    pub mint: InterfaceAccount<'info, Mint>,
    #[account(init, seeds=[b"whale_account"], bump, payer=payer, space=8+32+8)]
    pub latest_whale_account: Account<'info, WhaleAccount>,
    pub token_program: Interface<'info, TokenInterface>,
    pub associated_token_program: Program<'info, AssociatedToken>,
    pub system_program: Program<'info, System>,
}
```

ğŸ§‘â€ğŸ« **æç¤º**ï¼š

* å°†ä¿å­˜é¢å¤–è´¦æˆ·çš„è´¦æˆ· (`extra_account_meta_list`) **å¿…é¡»**æœ‰ä¸€ä¸ªéå¸¸ç‰¹å®šçš„ç§å­ç”¨äºå…¶ PDAï¼šå­—èŠ‚ä¸² **extra-account-metas** å’Œä»£å¸çš„ `mint` è´¦æˆ·çš„å…¬é’¥ã€‚
* å°†ä¿å­˜é²¸é±¼è¯¦ç»†ä¿¡æ¯çš„è´¦æˆ· (`latest_whale_account`) å°†æœ‰ä¸€ä¸ªç®€å•çš„ç§å­ç”¨äºå…¶ PDAï¼šå­—ç¬¦ä¸² **whale_account** çš„å­—èŠ‚ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬é“¸é€ çš„æ‰€æœ‰ä»£å¸å°†å…±äº«åŒä¸€ä¸ªè´¦æˆ·ã€‚
* æˆ‘ä»¬å¿…é¡»ä¸ºæŒ‡ä»¤æä¾›ä»£å¸ç¨‹åºã€å…³è”ä»£å¸ç¨‹åºå’Œç³»ç»Ÿç¨‹åºï¼Œå› ä¸ºå®ƒåœ¨è¿è¡Œæ—¶éœ€è¦ä½¿ç”¨å®ƒä»¬ã€‚

3. æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬æ·»åŠ  `initialize_extra_account_meta` æŒ‡ä»¤ã€‚ç”¨ä»¥ä¸‹å†…å®¹æ›¿æ¢é»˜è®¤çš„ `initialize` æŒ‡ä»¤ï¼š

```rust
pub fn initialize_extra_account(ctx: Context<InitializeExtraAccountMeta>) -> Result<()> {
  // è¿™æ˜¯æˆ‘ä»¬éœ€è¦çš„é¢å¤–è´¦æˆ·çš„å‘é‡ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­
  // åªæœ‰ä¸€ä¸ªè´¦æˆ· - é²¸é±¼è¯¦ç»†ä¿¡æ¯è´¦æˆ·ã€‚
  let account_metas = vec![ExtraAccountMeta::new_with_seeds(
    &[Seed::Literal {
      bytes: "whale_account".as_bytes().to_vec(),
    }],
    false,
    true,
  )?];
    
  // è®¡ç®—è´¦æˆ·å¤§å°å’Œç§Ÿé‡‘
  let account_size = ExtraAccountMetaList::size_of(account_metas.len())? as u64;
  let lamports = Rent::get()?.minimum_balance(account_size as usize);
  
  // ä»ä¸Šä¸‹æ–‡ä¸­è·å–é“¸é€ è´¦æˆ·å…¬é’¥ã€‚
  let mint = ctx.accounts.mint.key();
  
  // ExtraAccountMetaList PDA çš„ç§å­ã€‚
  let signer_seeds: &[&[&[u8]]] = &[&[
    b"extra-account-metas",
    &mint.as_ref(),
    &[ctx.bumps.extra_account_meta_list],
  ]];
  
  // åˆ›å»º ExtraAccountMetaList è´¦æˆ·
  create_account(
    CpiContext::new(
      ctx.accounts.system_program.to_account_info(),
      CreateAccount {
        from: ctx.accounts.payer.to_account_info(),
        to: ctx.accounts.extra_account_meta_list.to_account_info(),
      },
    )
    .with_signer(signer_seeds),
    lamports,
    account_size,
    ctx.program_id,
  )?;
  
  // ä½¿ç”¨é¢å¤–è´¦æˆ·åˆå§‹åŒ– ExtraAccountMetaList è´¦æˆ·
  ExtraAccountMetaList::init::<ExecuteInstruction>(
    &mut ctx.accounts.extra_account_meta_list.try_borrow_mut_data()?,
    &account_metas,
  )?;
  
  Ok(())
}
```

è¿™é‡Œæœ‰å¾ˆå¤šå†…å®¹ï¼Œè®©æˆ‘ä»¬é€æ­¥ç†è§£ï¼š

1. é¦–å…ˆæˆ‘ä»¬å£°æ˜ä¸€ä¸ª `ExtraAccountMeta` è´¦æˆ·çš„å‘é‡ (`account_metas`)ï¼ŒæŒ‡å®šæˆ‘ä»¬å°†ä½¿ç”¨çš„ä¸åŒé¢å¤–è´¦æˆ·ã€‚è¿™äº›å¯ä»¥ä»ç§å­ã€å…¬é’¥ç­‰æŒ‡å®šã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦ä¸€ä¸ªé¢å¤–è´¦æˆ·â€”â€”é²¸é±¼è¯¦ç»†ä¿¡æ¯è´¦æˆ·ã€‚
2. æˆ‘ä»¬è®¡ç®—è´¦æˆ·å¤§å°ï¼Œå¹¶åŸºäºæ­¤è®¡ç®—ç§Ÿé‡‘æ‰€éœ€çš„ lamports æ•°é‡ã€‚
3. æˆ‘ä»¬æŒ‡å®šéœ€è¦ç­¾åçš„ç§å­ä¸º `extra_account_meta_list` PDAã€‚
4. æˆ‘ä»¬è°ƒç”¨ `create_account` CPI å®é™…åˆ›å»º `extra_account_meta_list` è´¦æˆ·ï¼Œæä¾›æ‰€æœ‰éœ€è¦çš„æ•°æ®ï¼ˆä»˜æ¬¾äººã€ç­¾åè€…ç§å­ã€è´¦æˆ·å¤§å°ç­‰ï¼‰ã€‚
5. æœ€åï¼Œæˆ‘ä»¬ç”¨åœ¨æ­¥éª¤ 1 ä¸­å£°æ˜çš„é¢å¤–è´¦æˆ·å‘é‡åˆå§‹åŒ–æ–°åˆ›å»ºçš„è´¦æˆ·ã€‚

## å®ç° transfer_hook æŒ‡ä»¤

æˆ‘ä»¬è¾¾åˆ°äº†ç¨‹åºçš„æ ¸å¿ƒâ€”â€”`transfer_hook` æŒ‡ä»¤ï¼è¿™æ˜¯å®é™…æ“ä½œå‘ç”Ÿçš„åœ°æ–¹ï¼Œå› ä¸ºæ¯å½“è¿›è¡Œäº¤æ˜“æ—¶éƒ½ä¼šè°ƒç”¨æ­¤æŒ‡ä»¤ã€‚

1. æˆ‘ä»¬é¦–å…ˆä¸ºæŒ‡ä»¤æ·»åŠ ä¼ å…¥è´¦æˆ·ã€‚åœ¨ **lib.rs** ä¸­ `InitializeExtraAccountMeta` ä¸‹æ–¹æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```rust
#[derive(Accounts)]
pub struct TransferHook<'info> {
  #[account(token::mint = mint, token::authority = owner)]
  pub source_token: InterfaceAccount<'info, TokenAccount>,
  pub mint: InterfaceAccount<'info, Mint>,
  #[account(token::mint = mint)]
  pub destination_token: InterfaceAccount<'info, TokenAccount>,
  /// CHECK: source token account owner,   
  /// can be SystemAccount or PDA owned by another program  
  pub owner: UncheckedAccount<'info>,
  /// CHECK: ExtraAccountMetaList Account,
  #[account(seeds = [b"extra-account-metas", mint.key().as_ref()],bump)]
  pub extra_account_meta_list: UncheckedAccount<'info>,
  #[account(mut, seeds=[b"whale_account"], bump)]
  pub latest_whale_account: Account<'info, WhaleAccount>,
}
```

ğŸ§‘â€ğŸ« **æç¤º**ï¼š

* è¿™é‡ŒæŒ‡å®šçš„è´¦æˆ·é¡ºåºå¾ˆé‡è¦ï¼š
  - å‰å››ä¸ªè´¦æˆ·æ˜¯ä»£å¸è½¬è´¦æ‰€éœ€çš„è´¦æˆ·ï¼ˆæºã€é“¸é€ ã€ç›®æ ‡å’Œæ‰€æœ‰è€…â€”â€”æŒ‰æ­¤é¡ºåºï¼‰ï¼Œ
  - ç¬¬äº”ä¸ªè´¦æˆ·æ˜¯ `ExtraAccountMetaList` è´¦æˆ·çš„åœ°å€ã€‚
  - å‰©ä½™çš„è´¦æˆ·æ˜¯ `ExtraAccountMetaList` è´¦æˆ·æ‰€éœ€çš„é¢å¤–è´¦æˆ·ã€‚
* æ³¨æ„æˆ‘ä»¬åœ¨è¿™é‡Œä¼ é€’çš„çº¦æŸâ€”â€”å®ƒä»¬æ˜¯ä¸ºäº†å¸®åŠ©æˆ‘ä»¬ç¡®ä¿ä¼ é€’çš„è´¦æˆ·ç¡®å®æ˜¯æˆ‘ä»¬æœŸæœ›çš„è´¦æˆ·ï¼ˆå³æ­£ç¡®çš„é“¸é€ è´¦æˆ·ï¼Œæ­£ç¡®çš„æ‰€æœ‰è€…ç­‰ï¼‰ã€‚

2. ç°åœ¨æˆ‘ä»¬å¯ä»¥ç»§ç»­è¿›è¡Œå®é™…æŒ‡ä»¤ã€‚åœ¨ `initialize_extra_account` æŒ‡ä»¤ä¸‹æ–¹æ·»åŠ ä»¥ä¸‹ä»£ç ç‰‡æ®µï¼š

```rust
pub fn transfer_hook(ctx: Context<TransferHook>, amount: u64) -> Result<()> {
    msg!(&format!("Transfer hook fired for an amount of {}", amount));
  
    if amount >= 1000 * (u64::pow(10, ctx.accounts.mint.decimals as u32)) {
        // æˆ‘ä»¬æœ‰ä¸€ä¸ªé²¸é±¼ï¼
        ctx.accounts.latest_whale_account.whale_address = ctx.accounts.owner.key();
        ctx.accounts.latest_whale_account.transfer_amount = amount;
  
        emit!(WhaleTransferEvent {
            whale_address: ctx.accounts.owner.key(),
            transfer_amount: amount
        });
    }
  
    Ok(())
}
```

ğŸ¦ è¿™é‡Œæ²¡æœ‰å¤ªå¤šç–¯ç‹‚çš„äº‹æƒ…ï¼š

* æˆ‘ä»¬æ£€æŸ¥è½¬è´¦é‡‘é¢æ˜¯å¦å¤§äºæˆ–ç­‰äº 1000 ä»£å¸ï¼ˆè¿™æ˜¯æˆ‘é€‰æ‹©çš„ä»»æ„é‡‘é¢ï¼Œä½ å¯ä»¥é€‰æ‹©å…¶ä»–é‡‘é¢ï¼‰ã€‚
* å¦‚æœé‡‘é¢ç¡®å®æ˜¯ 1000 æˆ–æ›´å¤šï¼Œæˆ‘ä»¬æ›´æ–°é²¸é±¼è¯¦ç»†ä¿¡æ¯è´¦æˆ·çš„æ–°åœ°å€å’Œé‡‘é¢ã€‚
* æœ€åï¼Œæˆ‘ä»¬å‘å‡ºä¸€ä¸ªåä¸º `WhaleTransferEvent` çš„äº‹ä»¶ï¼Œä¾›å®¢æˆ·ç«¯ï¼ˆä¾‹å¦‚ Discord æœºå™¨äººã€Web åº”ç”¨ç¨‹åºç­‰ï¼‰ç›‘å¬ã€‚

3. åœ¨ lib.rs åº•éƒ¨æ·»åŠ å®é™…çš„äº‹ä»¶å£°æ˜ï¼š

```rust
#[event]
pub struct WhaleTransferEvent {
    pub whale_address: Pubkey,
    pub transfer_amount: u64,
}
```
## å®ç° fallback æŒ‡ä»¤

æœ€åä½†åŒæ ·é‡è¦çš„æ˜¯ï¼Œ`fallback` æŒ‡ä»¤ã€‚åœ¨ `transfer_hook` æŒ‡ä»¤ä¹‹åæ·»åŠ ä»¥ä¸‹ä»£ç ç‰‡æ®µï¼š

```rust
pub fn fallback<'info>(
    program_id: &Pubkey,
    accounts: &'info [AccountInfo<'info>],
    data: &[u8],
) -> Result<()> {
    let instruction = TransferHookInstruction::unpack(data)?;

    // åŒ¹é…æŒ‡ä»¤è¯†åˆ«ç¬¦ä»¥æ‰§è¡Œ transfer hook æ¥å£æŒ‡ä»¤
    // token2022 ç¨‹åºåœ¨ä»£å¸è½¬ç§»æ—¶è°ƒç”¨æ­¤æŒ‡ä»¤
    match instruction {
        TransferHookInstruction::Execute { amount } => {
            let amount_bytes = amount.to_le_bytes();

            // åœ¨æˆ‘ä»¬çš„ç¨‹åºä¸­è°ƒç”¨è‡ªå®šä¹‰ transfer hook æŒ‡ä»¤
            __private::__global::transfer_hook(program_id, accounts, &amount_bytes)
        }
        _ => return Err(ProgramError::InvalidInstructionData.into()),
    }
}
```

> fallback æŒ‡ä»¤å–è‡ª Solana çš„ [hello-world transfer hook ç¤ºä¾‹](https://medium.com/r?url=https%3A%2F%2Fbeta.solpg.io%2Fgithub.com%2Fsolana-developers%2Fanchor-transfer-hook%2Ftree%2Fhello_world) ã€‚

è™½ç„¶çœ‹èµ·æ¥å¾ˆå¤æ‚ï¼Œä½†è¿™ä¸ªæŒ‡ä»¤å…¶å®ç›¸å½“ç®€å•ï¼š

1. è§£åŒ…æŒ‡ä»¤æ•°æ®å¹¶å°†å…¶è½¬æ¢ä¸º `TransferHookInstruction`ã€‚
2. åŒ¹é… `TransferHookInstruction` æšä¸¾ã€‚
3. å¦‚æœæ˜¯ `Execute` æŒ‡ä»¤ï¼Œè·å–è½¬ç§»çš„é‡‘é¢å¹¶è°ƒç”¨ `transfer_hook` æŒ‡ä»¤ã€‚
4. å¦‚æœä¸æ˜¯ `Execute` æŒ‡ä»¤ï¼Œåˆ™è¿”å›æ— æ•ˆæŒ‡ä»¤æ•°æ®çš„é”™è¯¯ã€‚

![](https://img.learnblockchain.cn/attachments/migrate/1730184464025)

ç»§ç»­å°†ç¨‹åºéƒ¨ç½²åˆ° Devnet ğŸ‰

## ç¬¬ 2 æ­¥ï¼šé“¸é€ 

å¥½çš„ï¼Œæˆ‘ä»¬çš„ç¨‹åºå·²ç»éƒ¨ç½²ï¼Œç°åœ¨æˆ‘ä»¬å¯ä»¥å°†æ³¨æ„åŠ›è½¬å‘åˆ›å»ºä¸€ä¸ªå®é™…ä½¿ç”¨å®ƒçš„ä»£å¸é“¸é€ ã€‚

1. ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åˆ›å»ºä¸€ä¸ªé“¸é€ ï¼š

```bash
spl-token --program-id TokenzQdBNbLqP5VEhdkAS6EPFLC1PHnBqCXEpPxuEb create-token --transfer-hook <your transfer hook program id>
```

ğŸ§‘â€ğŸ« **æç¤º**ï¼š

* æ³¨æ„å‘½ä»¤ä¸­çš„ç¨‹åº idï¼Ÿé‚£æ˜¯ Token 2022 ç¨‹åºçš„åœ°å€ã€‚æˆ‘ä»¬å¿…é¡»æŒ‡å®šå®ƒä»¥ä¾¿é“¸é€ å®é™…ä½¿ç”¨æ–°æ ‡å‡†ã€‚
* ä¸ºé“¸é€ æ³¨å†Œ transfer hook å°±åƒåœ¨ `spl-token` å‘½ä»¤ä¸­æ·»åŠ  `--transfer-hook <address>` å­å‘½ä»¤ä¸€æ ·ç®€å•ã€‚

2. ä¸ºä½ é…ç½®çš„é’±åŒ…åˆ›å»ºä»£å¸è´¦æˆ·ï¼š

```bash
spl-token create-account <the token address from previous step>
```

3. å‘ä½ çš„é’±åŒ…é“¸é€ ä¸€äº›ä»£å¸ï¼š

```bash
spl-token mint <the token address from previous step> 3000
```

## ç¬¬ 3 æ­¥ï¼šåˆå§‹åŒ– ExtraAccountMeta è´¦æˆ·

å¦‚æœä½ å°è¯•è½¬ç§»ä»£å¸ï¼ˆä¾‹å¦‚ä½¿ç”¨ `spl-token transfer` å‘½ä»¤ï¼‰ï¼Œä½ å°†é‡åˆ° `AccountNotFound` é”™è¯¯ã€‚è¿™æ˜¯å› ä¸ºæˆ‘ä»¬ä»æœªåˆå§‹åŒ–æˆ‘ä»¬çš„è€æœ‹å‹ `ExtraAccountMetaList`

æˆ‘ä»¬åœ¨ç¨‹åºä¸­åˆ›å»ºäº†ä¸€ä¸ªæŒ‡ä»¤æ¥åˆå§‹åŒ–è´¦æˆ·ï¼Œ`initialize_extra_account`ï¼Œæ‰€ä»¥ç°åœ¨æ˜¯è°ƒç”¨å®ƒçš„æœ€ä½³æ—¶æœºã€‚

æˆ‘åˆ›å»ºäº†è¿™ä¸ªå°çš„ TypeScript ä»£ç æ¥è°ƒç”¨å®ƒï¼Œä½†ä½ å¯ä»¥éšæ„ä½¿ç”¨ä»»ä½•ä½ å–œæ¬¢çš„æ–¹æ³•ï¼š

```typescript
import { readFile } from "fs/promises";
import * as anchor from "@coral-xyz/anchor";
// è¿™ä¸¤ä¸ªæ–‡ä»¶æ˜¯ä»æ„å»ºçš„ Anchor ç¨‹åº Target/idl å’Œ Target/types æ–‡ä»¶å¤¹ä¸­å¤åˆ¶çš„ã€‚
import { TransferHookWhale } from "./program/transfer_hook_whale";
import idl from './program/transfer_hook_whale.json';

import { TOKEN_2022_PROGRAM_ID, ASSOCIATED_TOKEN_PROGRAM_ID } from "@solana/spl-token";
import "dotenv/config";

const kpFile = ".<your keypair file>";
const mint = new anchor.web3.PublicKey("<your mint public address>")

const main = async () => {

    if (!process.env.SOLANA_RPC) {
        console.log("Missing required env variables");
        return;
    }

    console.log("ğŸ’° Reading wallet...");
    const keyFile = await readFile(kpFile);
    const keypair: anchor.web3.Keypair = anchor.web3.Keypair.fromSecretKey(new Uint8Array(JSON.parse(keyFile.toString())));
    const wallet = new anchor.Wallet(keypair);

    console.log("â˜•ï¸ Setting provider and program...");
    const connection = new anchor.web3.Connection(process.env.SOLANA_RPC);
    const provider = new anchor.AnchorProvider(connection, wallet, {});
    anchor.setProvider(provider);
    const program = new anchor.Program<TransferHookWhale>(idl as TransferHookWhale, provider);

    console.log("ğŸª Initializing transfer hook accounts");
    const [extraAccountMetaListPDA] = anchor.web3.PublicKey.findProgramAddressSync(
        [Buffer.from("extra-account-metas"), mint.toBuffer()],
        program.programId
    );

    const [whalePDA] = anchor.web3.PublicKey.findProgramAddressSync([Buffer.from("whale_account")], program.programId);

    const initializeExtraAccountMetaListInstruction = await program.methods
        .initializeExtraAccount()
        .accounts({
            mint,
            extraAccountMetaList: extraAccountMetaListPDA,
            latestWhaleAccount: whalePDA,
            systemProgram: anchor.web3.SystemProgram.programId,
            tokenProgram: TOKEN_2022_PROGRAM_ID,
            associatedTokenProgram: ASSOCIATED_TOKEN_PROGRAM_ID,
        })
        .instruction();

    const transaction = new anchor.web3.Transaction().add(initializeExtraAccountMetaListInstruction);

    const tx = await anchor.web3.sendAndConfirmTransaction(connection, transaction, [wallet.payer], {
        commitment: "confirmed",
    });

    console.log("Transaction Signature:", tx);
}

main().then(() => {
    console.log("done!");
    process.exit(0);
}).catch((e) => {
    console.log("Error: ", e);
    process.exit(1);
});
```

> *ğŸ’ˆ* å®Œæ•´é¡¹ç›®åœ¨ [GitHub](https://github.com/jtordgeman/transfer-hook-whale-helpers)

## ç¬¬ 4 æ­¥ï¼šè®©è½¬ç§»å¼€å§‹ï¼

å°±æ˜¯è¿™æ ·ï¼Œæœ‹å‹ä»¬ï¼éšç€ transfer hook ç¨‹åºçš„éƒ¨ç½²ï¼Œé…ç½®ä½¿ç”¨å®ƒçš„é“¸é€ ï¼Œä»¥åŠ `ExtraAccountMetaList` è´¦æˆ·çš„åˆå§‹åŒ–ï¼Œæˆ‘ä»¬ç»ˆäºå¯ä»¥å¼€å§‹ä½¿ç”¨æˆ‘ä»¬çš„ hook äº†ï¼š

![](https://img.learnblockchain.cn/attachments/migrate/1730184464040)

transfer hook æ­£åœ¨è¿è¡Œï¼

## ç»“æŸè¯­

* ä½ å¯ä»¥åœ¨[è¿™é‡Œ](https://github.com/jtordgeman/transfer-hook-whale)æ‰¾åˆ° whale transfer hook ç¨‹åºçš„å®Œæ•´æºç ã€‚
* ä½ å¯ä»¥åœ¨[è¿™é‡Œ](https://github.com/jtordgeman/transfer-hook-whale-helpers)æ‰¾åˆ°ç¤ºä¾‹ç›‘å¬å™¨çš„æºç ã€‚
* æ¬¢è¿è¯„è®º :)

éå¸¸æ„Ÿè°¢ [Sara Lumelsky](https://medium.com/u/9caa2c6ac2a4?source=post_page---user_mention--7d5454891a22--------------------------------) å¸®åŠ©æˆ‘å¤„ç†è¯­æ³•å’Œå…¶ä»–é—®é¢˜ ğŸ˜…

> æˆ‘æ˜¯ [AI ç¿»è¯‘å®˜](https://learnblockchain.cn/people/19584)ï¼Œä¸ºå¤§å®¶è½¬è¯‘ä¼˜ç§€è‹±æ–‡æ–‡ç« ï¼Œå¦‚æœ‰ç¿»è¯‘ä¸é€šçš„åœ°æ–¹ï¼Œåœ¨[è¿™é‡Œ](https://github.com/lbc-team/Pioneer/blob/master/translations/9689.md)ä¿®æ”¹ï¼Œè¿˜è¯·åŒ…æ¶µï½