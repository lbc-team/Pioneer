
>- åŸæ–‡é“¾æ¥ï¼š[medium.com/@solidquant...](https://medium.com/@solidquant/up-your-mev-game-by-using-assembly-93c31b06cf96)
>- è¯‘è€…ï¼š[AIç¿»è¯‘å®˜](https://learnblockchain.cn/people/19584)ï¼Œæ ¡å¯¹ï¼š[ç¿»è¯‘å°ç»„](https://learnblockchain.cn/people/412)
>- æœ¬æ–‡é“¾æ¥ï¼š[learnblockchain.cn/articleâ€¦](https://learnblockchain.cn/article/9972)
    


## ä¸€ä»½å…³äºé™ä½ gas æˆæœ¬å’Œä½¿ç”¨æ±‡ç¼–å¤„ç†é”™è¯¯ã€è½¬ç§»ä»£å¸ã€äº¤æ¢ä»£å¸ç­‰çš„ A åˆ° Z æŒ‡å—

![](https://img.learnblockchain.cn/attachments/migrate/1732070012830)

å›¾ç‰‡æ¥æºï¼šBitKeep Academy

æ‰€ä»¥ï¼Œè¿™å¯¹æˆ‘æ¥è¯´æ˜¯ä¸€ä¸ªåå¤å‡ºç°çš„æ•…äº‹ã€‚æˆ‘å­¦ä¹ äº†ä¸€äº› Solidityï¼Œå‘ç°äº†ä¸€ä¸ªæˆ‘æƒ³è¦ç ”ç©¶çš„æœåŠ¡ã€‚ä»£ç çœ‹èµ·æ¥æ˜¯è¿™æ ·çš„ï¼š

![](https://img.learnblockchain.cn/attachments/migrate/1732070012948)

Seaport Core: BasicOrderFulfiller.sol

Solidity ä»£ç åœ¨å“ªé‡Œï¼Ÿäººä»¬ä¼¼ä¹ä¸å†ä½¿ç”¨æ™®é€šçš„ Solidity ä»£ç äº† ğŸ¥²

è¿™ç§åœ¨æ™ºèƒ½åˆçº¦ä¸­ä½¿ç”¨ä½çº§ä»£ç çš„è¶‹åŠ¿æ˜¯ä¸å¯é¿å…çš„ï¼Œå› ä¸ºä½¿ç”¨æ±‡ç¼–å¯ä»¥è®©æˆ‘ä»¬æ›´æ¥è¿‘ EVMï¼Œæ‰€æœ‰çš„æ“ä½œç éƒ½æ˜¯åœ¨è¿™é‡Œè¿è¡Œçš„ã€‚*ï¼ˆä¸Šé¢çš„ä»£ç ç‰‡æ®µå¹¶ä¸æ˜¯çº¯æ±‡ç¼–ï¼Œå®ƒå®é™…ä¸Šæ˜¯å¯ä»¥ä¸ Solidity ä¸€èµ·ä½¿ç”¨çš„ Yul è¯­è¨€ã€‚ä½†æˆ‘ä¼šå°†è¿™ä¸¤ä¸ªæœ¯è¯­äº’æ¢ä½¿ç”¨ã€‚ï¼‰*

è¿™æ ·åšï¼Œæˆ‘ä»¬å¯ä»¥ç»•è¿‡ Solidity æœ‰æ—¶å¼ºåŠ ç»™æˆ‘ä»¬çš„ä¸å¿…è¦çš„ä»£ç è¿è¡Œï¼Œä»è€Œé™ä½ gas æˆæœ¬ã€‚æ­¤å¤–ï¼Œè¿˜æœ‰ä¸€äº›ä»»åŠ¡æ˜¯ä»…ä½¿ç”¨ Solidity æ— æ³•æ‰§è¡Œçš„ï¼Œè€Œ Yul å¯ä»¥å¸®åŠ©æˆ‘ä»¬å®Œæˆè¿™äº›ä»»åŠ¡ã€‚

å»ä¸­å¿ƒåŒ–æœåŠ¡è¯•å›¾å°½å¯èƒ½ä½¿ç”¨æ±‡ç¼–ä¼˜åŒ–ä»–ä»¬çš„ä»£ç ï¼Œä»¥ä¾¿ä¸ºç”¨æˆ·æä¾›æ›´å¥½çš„ä½“éªŒã€‚

å¯¹äº MEV æœç´¢è€…æ¥è¯´ï¼Œæ¯ä¸€ç¬”äº¤æ˜“ï¼Œæ— è®ºæ˜¯æˆåŠŸè¿˜æ˜¯è¢«æ’¤å›ï¼Œéƒ½ä¼šåœ¨è¿è¡Œè€…èº«ä¸Šäº§ç”Ÿ gas æˆæœ¬ï¼Œä¼˜åŒ–çš„ Solidity ä»£ç å°†èŠ‚çœè¿è¥æˆæœ¬ã€‚å› æ­¤ï¼Œæœç´¢è€…ç†è§£ EVM å¹¶åˆ©ç”¨ Solidity ä¸­æ±‡ç¼–ä»£ç çš„åŠ›é‡è‡³å…³é‡è¦ã€‚

æˆ‘åœ¨ GitHub ä¸Šç ”ç©¶ libevm çš„ subway bot ä»£ç ï¼š

[ GitHub - libevm/subway](https://github.com/libevm/subway?source=post_page-----93c31b06cf96--------------------------------)

å¹¶çœ‹åˆ°ä»–åœ¨åˆçº¦çš„ **fallback** å‡½æ•°ä¸­ä½¿ç”¨äº†æ±‡ç¼–ä»£ç ï¼ˆæˆ‘å°†åœ¨è¿™ç¯‡æ–‡ç« ä¸­è§£é‡Šè¿™ä¸ªåˆçº¦çš„æ¯ä¸€è¡Œï¼‰ï¼š

```solidity
// SPDX-License-Identifier: MIT  
  
pragma solidity >=0.8.0;  
  
import "./interface/IERC20.sol";  
import "./lib/SafeTransfer.sol";  
  
contract Sandwich {  
    using SafeTransfer for IERC20;  
  
    // æˆæƒ  
    address internal immutable user;  
  
    // transfer(address,uint256)  
    bytes4 internal constant ERC20_TRANSFER_ID = 0xa9059cbb;  
  
    // swap(uint256,uint256,address,bytes)  
    bytes4 internal constant PAIR_SWAP_ID = 0x022c0d9f;  
  
    // æ„é€ å‡½æ•°è®¾ç½®å”¯ä¸€ç”¨æˆ·  
    receive() external payable {}  
  
    constructor(address _owner) {  
        user = _owner;  
    }  
  
    // *** ä»åˆçº¦ä¸­æ¢å¤åˆ©æ¶¦ *** //  
    function recoverERC20(address token) public {  
        require(msg.sender == user, "shoo");  
        IERC20(token).safeTransfer(  
            msg.sender,  
            IERC20(token).balanceOf(address(this))  
        );  
    }  
  
    /*  
        å›é€€å‡½æ•°ï¼Œä½ å¯ä»¥åœ¨è¿™é‡Œè¿›è¡Œå‰åˆ‡ç‰‡å’Œååˆ‡ç‰‡  
  
        æ²¡æœ‰å”å—ä¿æŠ¤ï¼Œä½¿ç”¨é£é™©è‡ªè´Ÿ  
  
        è´Ÿè½½ç»“æ„ (abi encodePacked)  
  
        - token: address        - ä½ è¦äº¤æ¢çš„ä»£å¸åœ°å€  
        - pair: address         - ä½ åœ¨å…¶ä¸Šè¿›è¡Œå¤¹å‡»çš„ Univ2 å¯¹  
        - amountIn: uint128     - ä½ é€šè¿‡äº¤æ¢æä¾›çš„æ•°é‡  
        - amountOut: uint128    - ä½ é€šè¿‡äº¤æ¢æ¥æ”¶çš„æ•°é‡  
        - tokenOutNo: uint8     - ä½ æä¾›çš„ä»£å¸æ˜¯ token0 è¿˜æ˜¯ token1ï¼Ÿ (åœ¨ univ2 å¯¹ä¸Š)  
  
        æ³¨æ„ï¼šæ­¤å›é€€å‡½æ•°ä¼šç”Ÿæˆä¸€äº›æ‚¬æŒ‚ä½  
    */  
    fallback() external payable {  
        // æ±‡ç¼–æ— æ³•è¯»å–ä¸å¯å˜å˜é‡  
        address memUser = user;  
  
        assembly {  
            // åªæœ‰åœ¨ä½ è¢«æˆæƒçš„æƒ…å†µä¸‹æ‰èƒ½è®¿é—®å›é€€å‡½æ•°  
            if iszero(eq(caller(), memUser)) {  
                // Ohm (3, 3) ä½¿ä½ çš„ä»£ç æ›´é«˜æ•ˆ  
                // WGMI  
                revert(3, 3)  
            }  
  
            // æå–å˜é‡  
            // æˆ‘ä»¬æ²¡æœ‰å‡½æ•°ç­¾åï¼ŒèŠ‚çœæ›´å¤š gas  
  
            // bytes20  
            let token := shr(96, calldataload(0x00))  
            // bytes20  
            let pair := shr(96, calldataload(0x14))  
            // uint128  
            let amountIn := shr(128, calldataload(0x28))  
            // uint128  
            let amountOut := shr(128, calldataload(0x38))  
            // uint8  
            let tokenOutNo := shr(248, calldataload(0x48))  
  
            // **** è°ƒç”¨ token.transfer(pair, amountIn) ****  
  
            // è½¬ç§»å‡½æ•°ç­¾å  
            mstore(0x7c, ERC20_TRANSFER_ID)  
            // ç›®æ ‡  
            mstore(0x80, pair)  
            // æ•°é‡  
            mstore(0xa0, amountIn)  
  
            let s1 := call(sub(gas(), 5000), token, 0, 0x7c, 0x44, 0, 0)  
            if iszero(s1) {  
                // WGMI  
                revert(3, 3)  
            }  
  
            // ***************  
            /*   
                è°ƒç”¨ pair.swap(  
                    tokenOutNo == 0 ? amountOut : 0,  
                    tokenOutNo == 1 ? amountOut : 0,  
                    address(this),  
                    new bytes(0)  
                )  
            */  
  
            // äº¤æ¢å‡½æ•°ç­¾å  
            mstore(0x7c, PAIR_SWAP_ID)  
            // tokenOutNo == 0 ? ....  
            switch tokenOutNo  
            case 0 {  
                mstore(0x80, amountOut)  
                mstore(0xa0, 0)  
            }  
            case 1 {  
                mstore(0x80, 0)  
                mstore(0xa0, amountOut)  
            }  
            // address(this)  
            mstore(0xc0, address())  
            // ç©ºå­—èŠ‚  
            mstore(0xe0, 0x80)  
  
            let s2 := call(sub(gas(), 5000), pair, 0, 0x7c, 0xa4, 0, 0)  
            if iszero(s2) {  
                revert(3, 3)  
            }  
        }  
    }  
}
```

å…¶ä»– MEV é¡¹ç›®ä¹Ÿåœ¨è¿™æ ·åšï¼Œå¾ˆå¤šé¡¹ç›®ä¹Ÿåœ¨é‡‡ç”¨ Huff è¯­è¨€ä½œä¸ºæ›¿ä»£ã€‚ä½ å¯ä»¥åœ¨è¿™é‡Œäº†è§£æ›´å¤šå…³äº Huff çš„ä¿¡æ¯ï¼š

[ Getting started | Huff Language](https://docs.huff.sh/get-started/overview/?source=post_page-----93c31b06cf96--------------------------------)

ä½†åœ¨ä»Šå¤©çš„æ–‡ç« ä¸­ï¼Œæˆ‘æƒ³å°è¯•ç†è§£ subway çš„ Sandwich.sol æ–‡ä»¶åœ¨èƒŒååšäº†ä»€ä¹ˆã€‚

æˆ‘è¿˜æƒ³æ¯”è¾ƒå®ç°çº¯ Solidity ç‰ˆæœ¬çš„å›é€€å‡½æ•°çš„ gas æˆæœ¬ï¼Œçœ‹çœ‹ä½¿ç”¨æ±‡ç¼–ä»£ç èƒ½å¸®åŠ©æˆ‘ä»¬å‡å°‘å¤šå°‘ gas æˆæœ¬ã€‚

æˆ‘è¿™æ ·åšæ˜¯å› ä¸ºå½“æˆ‘åˆšå¼€å§‹å­¦ä¹  EVM å’Œæ“ä½œç æ—¶ï¼Œæˆ‘å‘ç°äº†ä¸€äº›å¾ˆå¥½çš„èµ„æºæ¥å¸®åŠ©æˆ‘ç†è§£åŸºç¡€çŸ¥è¯†ï¼Œä½†å®é™…ä¸Šæ²¡æœ‰å¤šå°‘èµ„æºç»™å‡ºäº†å¦‚ä½•åœ¨çœŸå®é¡¹ç›®ä¸­ä½¿ç”¨æ±‡ç¼–çš„ç¤ºä¾‹ã€‚

## ç›®å½•ï¼š

1.  **ä½¿ç”¨çš„æ“ä½œç **
2.  **Sandwich.sol çš„å­˜å‚¨å¸ƒå±€**
3.  **åœ¨æ±‡ç¼–ä¸­ä½¿ç”¨â€œrequireâ€**
4.  **ä½¿ç”¨â€œcalldataloadâ€å’Œâ€œshrâ€è¯»å– calldata**
5.  **åœ¨æ±‡ç¼–ä¸­è°ƒç”¨ ERC-20 â€œtransferâ€ å‡½æ•°**
6.  **åœ¨æ±‡ç¼–ä¸­è°ƒç”¨ Uniswap V2 â€œswapâ€ å‡½æ•°**
7.  **æ¯”è¾ƒ gas æˆæœ¬ï¼šSolidity vs. Assembly**
8.  **æ¥ä¸‹æ¥æ˜¯ä»€ä¹ˆï¼Ÿ**

# ä½¿ç”¨çš„æ“ä½œç 

åœ¨å›é€€å‡½æ•°ä¸­ä½¿ç”¨äº†å‡ ä¸ªæ“ä½œç ã€‚

*   **iszero**
*   **eq**
*   **caller**
*   **revert**
*   **shr**
*   **calldataload**
*   **mstore**
*   **call**
*   **sub**
*   **gas**
*   **sstore** *ï¼ˆæˆ‘ä»¬ä¹Ÿå°†åœ¨æ­¤è¿‡ç¨‹ä¸­å­¦ä¹ è¿™ä¸ªæ“ä½œç ï¼‰*
*   **mload** *ï¼ˆè¿™ä¸ªä¹Ÿæ˜¯ï¼‰*

é€šè¿‡ä½¿ç”¨è‡³å°‘ 10 ä¸ªæ“ä½œç ï¼Œæˆ‘ä»¬å¯ä»¥ä»å…¶ä»–åˆçº¦è°ƒç”¨è½¬è´¦å’Œäº¤æ¢å‡½æ•°ï¼Œå¹¶åœ¨æˆ‘ä»¬çš„å‡½æ•°å†…éƒ¨è¿›è¡ŒåŸºæœ¬çš„â€œrequireâ€æ£€æŸ¥ã€‚

æˆ‘ä»¬å°†å°è¯•é€æ­¥å­¦ä¹ è¿™ 10 ä¸ªæ“ä½œç ã€‚*ä¸€äº›è¯»è€…å¯èƒ½ä¼šè§‰å¾—è¿™äº›æ¦‚å¿µç›¸å½“åŸºç¡€ï¼Œä½†æˆ‘å°½é‡å°†æ‰€æœ‰å†…å®¹ä¿æŒåœ¨åˆå­¦è€…çš„è§†è§’ã€‚*

æˆ‘å°†ä»‹ç»ä¸€äº›é‡è¦çš„æ¦‚å¿µï¼Œä¾‹å¦‚ï¼š

*   **å­˜å‚¨ï¼Œ**
*   **å†…å­˜ï¼Œ**
*   **è°ƒç”¨æ•°æ®ï¼Œ**
*   **ä½¿ç”¨æ±‡ç¼–è°ƒç”¨å‡½æ•°ï¼Œ**
*   **ä½¿ç”¨ Foundry åˆ†ææ™ºèƒ½åˆçº¦**

ä»¥å¸®åŠ©ä½ å¿«é€Ÿäº†è§£ EVM å’Œæ±‡ç¼–è¯­è¨€ã€‚

## å›é€€å‡½æ•°

åœ¨æˆ‘ä»¬å¼€å§‹ä¹‹å‰ï¼Œè®©æˆ‘ä»¬è€ƒè™‘ä¸€ä¸‹ä¸ºä»€ä¹ˆåˆçº¦åªæœ‰ä¸€ä¸ªâ€œå›é€€â€å‡½æ•°ï¼Œè€Œä¸æ˜¯å¸¸è§„çš„å‡½æ•°ç­¾åã€‚

è¿™å®é™…ä¸Šæ˜¯ä¸€ä¸ªéå¸¸å·§å¦™çš„æŠ€å·§ï¼Œå¯ä»¥ä½¿ä½ çš„åˆçº¦æ›´åŠ è½»é‡å’Œçµæ´»ã€‚å½“è°ƒç”¨çš„åŒ¹é…å‡½æ•°åœ¨åˆçº¦ä¸­ä¸å­˜åœ¨æ—¶ï¼Œå›é€€å‡½æ•°ä¼šè¢«æ‰§è¡Œã€‚

ä¾‹å¦‚ï¼Œæœ‰äººä¼šå‘æˆ‘çš„åˆçº¦å‘é€ä¸€ä¸ªâ€œäº¤æ¢â€è°ƒç”¨ï¼Œä½†æˆ‘çš„åˆçº¦æ²¡æœ‰â€œäº¤æ¢â€å‡½æ•°ï¼Œé‚£ä¹ˆè¿™ä¸ªè°ƒç”¨å°†é»˜è®¤è½¬åˆ°â€œå›é€€â€å‡½æ•°ã€‚

æˆ‘ä»¬å°†ä½¿ç”¨ Foundry å’Œ ethers.js æ¥æŸ¥çœ‹è¿™ä¸€ç‚¹ã€‚

é¦–å…ˆï¼Œåˆå§‹åŒ–ä½ çš„ Foundry é¡¹ç›®ï¼š

```
forge init subway  
cd subway
```

åœ¨ä½ çš„ _src_ ç›®å½•ä¸­ï¼Œåˆ›å»ºä¸€ä¸ªåä¸º **_Sandwich.sol_** çš„ Solidity æ–‡ä»¶ï¼š

```solidity
// SPDX-License-Identifier: MIT  
  
pragma solidity >=0.8.0;  
  
contract Sandwich {  
    uint256 public x;  
  
    receive() external payable {}  
  
    fallback() external payable {  
        assembly {  
            let value := calldataload(0x00)  
            sstore(x.slot, value)  
        }  
    }  
}
```

é€šè¿‡è¾“å…¥ä»¥ä¸‹å‘½ä»¤ç¼–è¯‘æ­¤åˆçº¦ï¼š

```
forge compile
```

è¿™æ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„åˆçº¦ï¼Œåªæœ‰ä¸¤ä¸ªå‡½æ•°ï¼š**receive** å’Œ **fallback**ã€‚å½“æ²¡æœ‰è°ƒç”¨æ•°æ®æ—¶ï¼Œæ‰§è¡Œ receive å‡½æ•°ï¼›å½“å‘é€å¸¦æœ‰è°ƒç”¨æ•°æ®çš„å‡½æ•°è°ƒç”¨åˆ°æ­¤åˆçº¦æ—¶ï¼Œæ‰§è¡Œå›é€€å‡½æ•°ã€‚æ­¤å¤–ï¼Œä¸ºäº†æ–¹ä¾¿è°ƒè¯•å›é€€å‡½æ•°çš„è°ƒç”¨ï¼Œæˆ‘æ·»åŠ äº†ä¸€ä¸ªä¸´æ—¶çš„ uint256 å€¼ xã€‚ä¸‹é¢æˆ‘å°†å±•ç¤ºå®ƒæ˜¯å¦‚ä½•ä½¿ç”¨çš„ã€‚

æˆ‘åœ¨è¿™é‡Œä½¿ç”¨äº†ä¸¤ä¸ªæ“ä½œç ï¼Œåˆ†åˆ«æ˜¯ï¼š**calldataload** å’Œ **sstore**ã€‚

âœ… **calldataload**

å½“ä½ åœ¨äº¤æ˜“ä¸­å‘é€è°ƒç”¨æ•°æ®æ—¶ï¼Œæˆ‘ä»¬å°†çœ‹åˆ°å¦‚ä½•ä½¿ç”¨ Javascriptï¼Œå®ƒä»¥ 32 å­—èŠ‚å­—çš„è¿æ¥å½¢å¼å­˜åœ¨ã€‚

ä½ å¯ä»¥ä½¿ç”¨æ“ä½œç  **calldataload** æ¯æ¬¡è®¿é—® 32 å­—èŠ‚çš„è°ƒç”¨æ•°æ®ï¼Œé€šè¿‡ä¼ å…¥å¼€å§‹è¯»å–è°ƒç”¨æ•°æ®çš„åç§»å€¼ã€‚ä»æˆ‘ä»¬çš„ Sandwich åˆçº¦ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æˆ‘ä»¬åŠ è½½äº† 0x00(=0) çš„è°ƒç”¨æ•°æ®ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬ä»åç§»é‡ 0 è¯»å–äº†ä¸€ä¸ª 32 å­—èŠ‚çš„å­—ã€‚

âœ… **sstore**

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†ä»è°ƒç”¨æ•°æ®ä¸­æ£€ç´¢åˆ°çš„å€¼å­˜å‚¨åˆ°æˆ‘ä»¬çš„å˜é‡ x ä¸­ã€‚æˆ‘ä»¬çš„å˜é‡ x æ˜¯åœ¨åˆçº¦ä¸­é¦–å…ˆå®šä¹‰çš„ï¼Œä½œä¸ºä¸€ä¸ª uint256 å˜é‡â€”â€”å®ƒæ˜¯ 32 å­—èŠ‚ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬çš„å€¼ x å­˜å‚¨åœ¨å­˜å‚¨çš„ç¬¬ 0 ä¸ªæ§½ä¸­ã€‚è¿™å¬èµ·æ¥ç›¸å½“å¤æ‚ï¼Œä½†å¯ä»¥é€šè¿‡ Foundry è¿›è¡Œå¯è§†åŒ–ã€‚å°è¯•è¿è¡Œï¼š

```
forge inspect src/Sandwich.sol:Sandwich storage-layout
```

è¿™å°†è¾“å‡ºï¼š

![](https://img.learnblockchain.cn/attachments/migrate/1732070012953)

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„å˜é‡/æ ‡ç­¾ x åœ¨æ§½ 0 ä¸­ã€‚

æ‰€ä»¥å¦‚æœæˆ‘ä»¬å›åˆ°æˆ‘ä»¬çš„ sstore ä»£ç ï¼Œæˆ‘ä»¬æ­£åœ¨å°†â€œvalueâ€çš„å€¼å­˜å‚¨åˆ° x å˜é‡çš„æ§½ä¸­ï¼Œå³ 0ã€‚

ç°åœ¨ï¼Œè®©æˆ‘ä»¬åœ¨åŒä¸€ä¸ª Foundry é¡¹ç›®ç›®å½•ä¸­è®¾ç½®ä¸€ä¸ªèŠ‚ç‚¹é¡¹ç›®ï¼Œä»¥å¼€å§‹ç¼–å†™æˆ‘ä»¬çš„ Javascript ä»£ç ã€‚è¿è¡Œï¼š

```
npm init  
npm install ethers@5
```

*æ³¨æ„ï¼Œæˆ‘ä½¿ç”¨çš„æ˜¯ ethers ç‰ˆæœ¬ 5ï¼Œè€Œä¸æ˜¯ç‰ˆæœ¬ 6ã€‚è¿™æ˜¯å› ä¸ºç½‘ä¸Šå¾ˆå¤šç¤ºä¾‹ä»ç„¶ä½¿ç”¨è¿™ä¸ªç‰ˆæœ¬ï¼Œå› æ­¤è¿™æ ·æ›´å®¹æ˜“è·Ÿéšã€‚*

åˆ›å»ºä¸€ä¸ªåä¸º **_index.js_** çš„ Javascript æ–‡ä»¶ï¼š

```javascript
const { ethers } = require('ethers');  
  
const ABI = require('./out/Sandwich.sol/Sandwich.json').abi;  
const ADDRESS = '<Address of deployed contract>'; // we'll get this address from below  
  
const calcNextBlockBaseFee = (curBlock) => {  
    // taken from: https://github.com/libevm/subway/blob/master/bot/src/utils.js  
    const baseFee = curBlock.baseFeePerGas;  
    const gasUsed = curBlock.gasUsed;  
    const targetGasUsed = curBlock.gasLimit.div(2);  
    const delta = gasUsed.sub(targetGasUsed);  
  
    const newBaseFee = baseFee.add(  
        baseFee.mul(delta).div(targetGasUsed).div(ethers.BigNumber.from(8))  
    );  
  
    // Add 0-9 wei so it becomes a different hash each time  
    const rand = Math.floor(Math.random() * 10);  
    return newBaseFee.add(rand);  
};  
  
async function main() {  
    // referenced: https://github.com/libevm/subway/blob/master/bot/index.js  
  
    // public, private key generated from Anvil  
    const PUBLIC = '0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266';  
    const PRIVATE = '0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80';  
  
    const provider = new ethers.providers.JsonRpcProvider('http://127.0.0.1:8545'); // Anvil RPC  
    const wallet = new ethers.Wallet(PRIVATE, provider);  
    const { chainId } = await provider.getNetwork();  
  
    const sandwich = new ethers.Contract(ADDRESS, ABI, wallet);  
      
    // before call  
    let x = await sandwich.x();  
    console.log(`Before: ${x.toString()}`);  
  
    // send transaction  
    const block = await provider.getBlock();  
    const nextBaseFee = calcNextBlockBaseFee(block);  
    const nonce = await wallet.getTransactionCount();  
    // you don't need a function signature to call fallback function  
    const payload = ethers.utils.solidityPack(  
        ['uint256'],  
        [10]  
    );  
    console.log(payload);  
    const tx = {  
        to: ADDRESS,  
        from: PUBLIC,  
        data: payload,  
        chainId,  
        maxPriorityFeePerGas: 0,  
        maxFeePerGas: nextBaseFee,  
        gasLimit: 250000,  
        nonce,  
        type: 2,  
    };  
    const signed = await wallet.signTransaction(tx);  
    const res = await provider.sendTransaction(signed);  
    const receipt = await provider.getTransactionReceipt(res.hash);  
    console.log(receipt.gasUsed.toString());  
  
    // after call  
    x = await sandwich.x();  
    console.log(`After: ${x.toString()}`);  
}  
  
(async () => {  
    await main();  
})();
```

æˆ‘ä»¬åªéœ€å…³æ³¨ä¸»å‡½æ•°ã€‚åœ¨è°ƒç”¨å›é€€å‡½æ•°ä¹‹å‰ï¼Œæˆ‘ä»¬è·å– x çš„å€¼ã€‚ç„¶åæˆ‘ä»¬å‘é€ä¸€ä¸ªæ²¡æœ‰è¦è°ƒç”¨çš„å‡½æ•°åç§°çš„äº¤æ˜“ï¼Œè€Œæ˜¯ç®€å•åœ°ä½¿ç”¨ **ethers.utils.solidityPack** ç¼–ç æˆ‘ä»¬æƒ³è¦å‘é€åˆ°åˆçº¦çš„å€¼ã€‚è¿™å°†äº§ç”Ÿï¼š

```
0x000000000000000000000000000000000000000000000000000000000000000a
```

ç„¶åæˆ‘ä»¬ç­¾ç½²åŸå§‹äº¤æ˜“ï¼Œå¹¶æ£€æŸ¥æˆ‘ä»¬çš„ x å€¼æ˜¯å¦å·²æ›´æ”¹ä¸º 10ã€‚

è¦è¿è¡Œæ­¤ä»£ç ï¼Œæˆ‘å°†ä½¿ç”¨ Anvilï¼Œè¿™æ˜¯ä¸€ä¸ªç±»ä¼¼äº Ganache çš„æœ¬åœ°æµ‹è¯•ç½‘èŠ‚ç‚¹ã€‚å¦‚æœä½ å®‰è£…äº† Foundryï¼Œä½ ä¹Ÿä¼šæœ‰ Anvilã€‚é€šè¿‡å¯åŠ¨å¦ä¸€ä¸ªç»ˆç«¯è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```
anvil
```

è¿™å°†å¯åŠ¨ä½ çš„æœ¬åœ°æµ‹è¯•ç½‘ï¼š

![](https://img.learnblockchain.cn/attachments/migrate/1732070012960)

è¿™å°±æ˜¯è¿è¡Œæˆ‘ä»¬ä»£ç çš„æ•´ä¸ªè®¾ç½®ã€‚

æˆ‘ä»¬å°†é¦–å…ˆéƒ¨ç½²æˆ‘ä»¬çš„ Sandwich åˆçº¦ï¼š

```
forge create --rpc-url http://127.0.0.1:8545 --private-key 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80 src/Sandwich.sol:Sandwich
```

æˆ‘ä»¬å¾—åˆ°çš„è¾“å‡ºå¦‚ä¸‹æ‰€ç¤ºï¼š

![](https://img.learnblockchain.cn/attachments/migrate/1732070012961)

å¤åˆ¶â€œDeployed toâ€éƒ¨åˆ†çš„å†…å®¹ï¼Œå¯¹æˆ‘æ¥è¯´æ˜¯ï¼š*0xB7f8BC63BbcaD18155201308C8f3540b07f84F5e*

å°†æ­¤å€¼ç²˜è´´åˆ°æˆ‘ä»¬çš„ JavaScript ä»£ç ä¸­ã€‚ç”¨æˆ‘ä»¬å·²éƒ¨ç½²åˆçº¦çš„åœ°å€æ›¿æ¢ä»¥ä¸‹ä»£ç ç‰‡æ®µï¼š

```javascript
const ADDRESS = '0xB7f8BC63BbcaD18155201308C8f3540b07f84F5e'; // we'll get this address from below
```

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¿è¡Œæˆ‘ä»¬çš„ JavaScript ä»£ç ï¼š

```bash
node index.js
```

æˆ‘ä»¬æˆåŠŸè¿è¡Œäº†æˆ‘ä»¬çš„å›é€€å‡½æ•°ï¼š

![](https://img.learnblockchain.cn/attachments/migrate/1732070012958)

ç°åœ¨ä»£ç è®¾ç½®å®Œæˆï¼Œè®©æˆ‘ä»¬æ·±å…¥ç ”ç©¶åŸå§‹çš„å›é€€å‡½æ•°ã€‚

# Sandwich.sol çš„å­˜å‚¨å¸ƒå±€

é¦–å…ˆï¼Œè®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæœ€ç®€åŒ–çš„ Sandwich.sol ä»£ç ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```solidity
// SPDX-License-Identifier: MIT  
  
pragma solidity >=0.8.0;  
  
import "./IERC20.sol";  
import "./SafeTransfer.sol";  
  
contract Sandwich {  
    using SafeTransfer for IERC20;  
  
    address internal immutable user;  
    bytes4 internal constant ERC20_TRANSFER_ID = 0xa9059cbb;  
    bytes4 internal constant PAIR_SWAP_ID = 0x022c0d9f;  
  
    receive() external payable {}  
  
    constructor(address _owner) {  
        user = _owner;  
    }  
  
    function recoverERC20(address token) public {  
        require(msg.sender == user, "shoo");  
        IERC20(token).safeTransfer(  
            msg.sender,  
            IERC20(token).balanceOf(address(this))  
        );  
    }  
  
    fallback() external payable {}  
}
```

è¿™å°±æ˜¯ Sandwich.sol ä¸­é™¤äº†å›é€€å‡½æ•°çš„æ‰€æœ‰å†…å®¹ã€‚æ€»å…±å®šä¹‰äº† 3 ä¸ªå˜é‡ï¼šaddressã€bytes4ã€bytes4ã€‚

è®©æˆ‘ä»¬æ£€æŸ¥ä¸€ä¸‹è¿™ä¸ªåˆçº¦çš„å­˜å‚¨å¸ƒå±€ï¼š

```bash
forge inspect src/Sandwich.sol:Sandwich storage-layout
```

æˆ‘ä»¬å¾—åˆ°ï¼š

**{"storage": [], "types": {}}**

è¿™å¾ˆå¥‡æ€ªã€‚ç„¶è€Œï¼Œç”±äºè¿™äº›å˜é‡éƒ½æ˜¯ä¸å¯å˜æˆ–å¸¸é‡ï¼Œå› æ­¤å®ƒä»¬ä¸ä¼šè¢«ä¿å­˜åˆ°å­˜å‚¨ä¸­ï¼Œè€Œæ˜¯åœ¨ç¼–è¯‘æ—¶ç”¨è¿™äº›ç¡¬ç¼–ç å€¼æ›¿æ¢ä»£ç ä¸­ä½¿ç”¨è¿™äº›å˜é‡çš„æ¯ä¸ªåœ°æ–¹ã€‚

è¿™å¯ä»¥å¸®åŠ©èŠ‚çœ gas æˆæœ¬ï¼Œå› ä¸ºå­˜å‚¨æ“ä½œæ˜¯ä¸æ™ºèƒ½åˆçº¦äº¤äº’æ—¶éœ€è¦æ³¨æ„çš„ä¸€äº›æœ€æ˜‚è´µçš„ä»¥å¤ªåŠæ“ä½œã€‚

æˆ‘ä»¬äº†è§£äº†åˆçº¦çš„å­˜å‚¨å¸ƒå±€ã€‚æˆ‘ä»¬ä¹ŸçŸ¥é“ä½•æ—¶å¯ä»¥ä½¿ç”¨å›é€€å‡½æ•°ã€‚æˆ‘æƒ³ç°åœ¨æˆ‘ä»¬å‡†å¤‡å¥½å¡«å……æˆ‘ä»¬çš„å›é€€å‡½æ•°çš„æ ¸å¿ƒé€»è¾‘äº†ã€‚

# åœ¨æ±‡ç¼–ä¸­ä½¿ç”¨â€œrequireâ€

è®©æˆ‘ä»¬ä»â€œrequireâ€å¼€å§‹ã€‚è¿™å¾ˆç®€å•ã€‚ç¡®åˆ‡åœ°è¯´ï¼Œæ±‡ç¼–ä¸æ”¯æŒâ€œrequireâ€çš„ç­‰ä»·ç‰©ï¼Œå› æ­¤æˆ‘ä»¬å¿…é¡»ç”¨â€œrevertâ€æ¥åº”å¯¹ã€‚

å› ä¸ºâ€œrevertâ€æ‰€åšçš„åªæ˜¯æ£€æŸ¥æ¡ä»¶æ˜¯å¦æ»¡è¶³ï¼Œå¦‚æœæ¡ä»¶ä¸æˆç«‹ï¼Œæˆ‘ä»¬å°±ä¼šæ’¤é”€æ•´ä¸ªäº¤æ˜“ï¼Œæ’¤é”€æ‰€åšçš„ä»»ä½•çŠ¶æ€æ›´æ”¹ã€‚æˆ‘ä»¬å¿…é¡»å…ˆè¿›è¡Œæ¡ä»¶æ£€æŸ¥ï¼Œç„¶åæ˜¾å¼è°ƒç”¨ **revert** æ“ä½œç ã€‚

è®©æˆ‘ä»¬æ”¾å¤§å›é€€å‡½æ•°ï¼Œæˆ‘ä»¬å°†å…¶å¡«å……å¦‚ä¸‹ï¼š

```solidity
fallback() external payable {  
    address memUser = user;  
  
    assembly {  
        if iszero(eq(caller(), memUser)) {  
            revert(0, 0) // the same as revert(3, 3)  
        }  
    }  
}
```

å¯æƒœçš„æ˜¯ï¼Œæˆ‘ä»¬æ— æ³•ä½¿ç”¨æ±‡ç¼–è®¿é—®ä¸å¯å˜å˜é‡ï¼Œå› æ­¤æˆ‘ä»¬å°† _user_ çš„åœ°å€è®¾ç½®ä¸º _memUser_ï¼Œä»¥ä¾¿åœ¨æ±‡ç¼–çš„ä½œç”¨åŸŸå¤–ä½¿ç”¨ã€‚ç„¶åï¼Œæˆ‘ä»¬å¼€å§‹æ±‡ç¼–å—ã€‚

åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨äº†å››ä¸ªæ–°çš„æ“ä½œç ï¼Œè¿™äº›æ“ä½œç ç›¸å½“ç®€å•æ˜“æ‡‚ï¼š

*   âœ… **iszero:** å¦‚æœç»™å®šçš„å€¼ä¸º 0ï¼Œåˆ™è¿”å› true
*   âœ… **eq:** æ£€æŸ¥ä½œä¸ºå‡½æ•°å‚æ•°ç»™å‡ºçš„ä¸¤ä¸ªå‚æ•°æ˜¯å¦å…·æœ‰ç›¸åŒçš„å€¼
*   âœ… **caller:** å‡½æ•°çš„è°ƒç”¨è€…ï¼ˆç›¸å½“äº msg.senderï¼‰
*   âœ… **revert:** æ’¤é”€äº¤æ˜“

è¿™æ®µä»£ç æ—¢ç®€å•åˆé«˜æ•ˆï¼Œç„¶è€Œï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦æ›´å¤šå…³äºé”™è¯¯çš„ä¿¡æ¯ã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥å°†ä»£ç æ›´æ”¹å¦‚ä¸‹ï¼š

```solidity
error NotOwner();  
  
fallback() external payable {  
    address memUser = user;  
  
    assembly {  
        if iszero(eq(caller(), memUser)) {  
            let errorPtr := mload(0x40)  
            mstore(  
                errorPtr,  
                0x30cd747100000000000000000000000000000000000000000000000000000000  
            )  
            revert(errorPtr, 0x4)  
        }  
    }  
}
```

æˆ‘ä¸ºä¸€ä¸ªåä¸º **NotOwner** çš„é”™è¯¯æ·»åŠ äº†å®šä¹‰ï¼Œå¹¶åœ¨æ±‡ç¼–ä»£ç å—ä¸­ä½¿ç”¨ **mload** ä»å†…å­˜ä¸­åŠ è½½æ•°æ®ã€‚

æ¥ä¸‹æ¥ï¼Œåœ¨è¯¥å†…å­˜ç©ºé—´ä¸­æ·»åŠ äº† NowOwner çš„é€‰æ‹©å™¨çš„å‰ 4 ä¸ªå­—èŠ‚ï¼ˆ=8 ä¸ªå­—ç¬¦ï¼‰(*30cd7471*_*2f59d478562d48e2d35de830db72c60a63dd08ae59199eec990b5bc4*ï¼‰ã€‚ä½ å¯ä»¥ä»ä¸‹é¢æ£€æŸ¥è¿™ä¸€ç‚¹ï¼š

![](https://img.learnblockchain.cn/attachments/migrate/1732070013707)

ç„¶åï¼Œæˆ‘å†æ¬¡ä½¿ç”¨â€œrevertâ€ï¼Œä½†è¿™æ¬¡è¿”å›å­˜å‚¨åœ¨ errorPtr ä¸­çš„é”™è¯¯ç­¾åã€‚

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ ethers.js æ£€ç´¢é”™è¯¯æ¶ˆæ¯ï¼š

```javascript
const signed = await wallet.signTransaction(tx);  
const res = await provider.sendTransaction(signed);  
const receipt = await provider.getTransactionReceipt(res.hash);  
  
const code = await wallet.call(  
    {  
        data: res.data,  
        to: res.to  
    }  
);  
console.log(sandwich.interface.parseError(code));  
```

```javascript
/*  
ErrorDescription {  
  args: [],  
  errorFragment: {  
    type: 'error',  
    name: 'NotOwner',  
    inputs: [],  
    _isFragment: true,  
    constructor: [Function: ErrorFragment] {  
      from: [Function (anonymous)],  
      fromObject: [Function (anonymous)],  
      fromString: [Function (anonymous)],  
      isErrorFragment: [Function (anonymous)]  
    },  
    format: [Function (anonymous)]  
  },  
  name: 'NotOwner',  
  signature: 'NotOwner()',  
  sighash: '0x30cd7471'  
}  
*/
```

é‚£ä¹ˆï¼Œä»€ä¹ˆæ˜¯æ›´å¥½çš„æ’¤é”€æ–¹æ³•ï¼Ÿæˆ‘è®¤ä¸ºè¿™å®Œå…¨å–å†³äºä½ çš„åå¥½ã€‚ä¸¤è€…ä¹‹é—´çš„åŒºåˆ«æœ¬è´¨ä¸Šåœ¨äºå¯è¯»æ€§å’Œ gas æˆæœ¬ï¼šrevert(0, 0) çš„æˆæœ¬æ˜¯ 21255ï¼Œè€Œåè€…çš„æˆæœ¬æ˜¯ 21282ã€‚å·®åˆ«ä¸å¤§ã€‚*ï¼ˆæˆ‘ä¼šé€‰æ‹©æ›´ç®€å•çš„æ–¹æ³•ã€‚ï¼‰*

# ä½¿ç”¨â€œcalldataloadâ€å’Œâ€œshrâ€è¯»å– calldata

è®©æˆ‘ä»¬å°è¯•è¯»å–åŒ…å«å¤šä¸ªå˜é‡å€¼çš„æ‰“åŒ… calldataã€‚

```solidity
fallback() external payable {  
    address memUser = user;  
  
    assembly {  
        if iszero(eq(caller(), memUser)) {  
            revert(0, 0) // the same as revert(3, 3)  
        }  
  
        let token := shr(96, calldataload(0x00))  
        let pair := shr(96, calldataload(0x14))  
        let amountIn := shr(128, calldataload(0x28))  
        let amountOut := shr(128, calldataload(0x38))  
        let tokenOutNo := shr(248, calldataload(0x48)) // I'll explain what this is from 'Calling Uniswap V2 "swap" function in assembly'  
    }  
}
```

è¦ç†è§£ç”¨äºè§£æ calldata çš„æ“ä½œç ï¼Œæˆ‘ä»¬é¦–å…ˆåº”è¯¥çœ‹çœ‹ calldata æ˜¯å¦‚ä½•ä¼ é€’çš„ã€‚æˆ‘ä»¬å°†ä½¿ç”¨ JavaScript å¦‚ä¸‹ï¼š

```javascript
const payload = ethers.utils.solidityPack(  
    ['address', 'address', 'uint128', 'uint128', 'uint8'],  
    [  
        '0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266',  
        '0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266',  
        1,  
        2,  
        3  
    ]  
);  
console.log(payload);
```

ä¸ºäº†è®©æˆ‘ä»¬çš„ç”Ÿæ´»æ›´è½»æ¾ï¼Œæˆ‘æ’å…¥äº†ä¸€äº›ç®€å•å¤„ç†çš„åå…­è¿›åˆ¶å€¼ã€‚ç»“æœå€¼çœ‹èµ·æ¥åƒè¿™æ ·ï¼š

**0xf39fd6e51aad88f6f4ce6ab8827279cfffb92266f39fd6e51aad88f6f4ce6ab8827279cfffb92266000000000000000000000000000000010000000000000000000000000000000203**

æˆ‘ä¼šå°è¯•è®©è¿™ä¸ªæ›´æ˜“è¯»ï¼š

1.  **0xf39fd6e51aad88f6f4ce6ab8827279cfffb92266** (20 å­—èŠ‚)

**2. f39fd6e51aad88f6f4ce6ab8827279cfffb92266** (20 å­—èŠ‚)

**3\. 00000000000000000000000000000001** (16 å­—èŠ‚ = 128 ä½)

**4\. 00000000000000000000000000000002** (16 å­—èŠ‚ = 128 ä½)

**5\. 03** (1 å­—èŠ‚ = 8 ä½)

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¿æ¥çš„å˜é‡åœ¨é•¿åº¦ä¸Šæœ‰æ‰€ä¸åŒï¼Œå› ä¸ºå®ƒä»¬çš„å¤§å°ä¸åŒï¼Œç„¶è€Œï¼Œæˆ‘ä»¬ä»ä¸Šé¢çœ‹åˆ°â€œcalldataloadâ€ä¸€æ¬¡åªèƒ½è¯»å– 32 å­—èŠ‚çš„å­—ã€‚

âœ… **shr**

è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦ä½¿ç”¨â€œshrâ€æ“ä½œç æ¥ä½ç§»æˆ‘ä»¬çš„æ•°æ®ä»¥æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ã€‚æˆ‘ä»¬å°†è¿›ä¸€æ­¥ç ”ç©¶è¿™ä¸€ç‚¹ã€‚

ç¬¬ä¸€ä¸ªå‘½ä»¤å°è¯•æ£€ç´¢â€œtokenâ€æ•°æ®ã€‚è¿™å°†ä»ç¬¬ 0 å­—èŠ‚ç´¢å¼•åŠ è½½ 32 å­—èŠ‚çš„ calldataï¼Œç›¸å½“äº 64 ä¸ªå­—ç¬¦ã€‚

![](https://img.learnblockchain.cn/attachments/migrate/1732070013728)

ç„¶è€Œï¼Œæˆ‘ä»¬åªéœ€è¦å‰ 20 å­—èŠ‚çš„ calldataï¼Œå› ä¸ºåœ°å€æ˜¯ bytes20 ç±»å‹ã€‚æˆ‘ä»¬é€šè¿‡ä½¿ç”¨â€œshrâ€æ¥å®ç°è¿™ä¸€ç‚¹ã€‚

![](https://img.learnblockchain.cn/attachments/migrate/1732070013760)

å°†å€¼å³ç§» 96 ä½ï¼ˆ=12 å­—èŠ‚ï¼‰ï¼Œæˆ‘ä»¬åªå‰©ä¸‹æ‰€éœ€çš„æ•°æ®ã€‚

åŒæ ·çš„é€»è¾‘é€‚ç”¨äºå…¶ä»–å‘½ä»¤ï¼š

*   **pair:** ä»ç¬¬ 20 å­—èŠ‚ç´¢å¼•è¯»å– calldataï¼ˆ=0x14ï¼Œåè¿›åˆ¶ä¸º 20ï¼‰ï¼Œå³ç§» 96 ä½ï¼Œ
*   **amountIn:** ä»ç¬¬ 40 å­—èŠ‚ç´¢å¼•è¯»å– calldataï¼ˆ=0x28ï¼‰ï¼Œå³ç§» 128 ä½ï¼Œ
*   **amountOut:** ä»ç¬¬ 56 å­—èŠ‚ç´¢å¼•è¯»å– calldataï¼ˆ=0x38ï¼‰ï¼Œå³ç§» 128 ä½ï¼Œ
*   **tokenOutNo:** ä»ç¬¬ 72 å­—èŠ‚ç´¢å¼•è¯»å– calldataï¼ˆ=0x48ï¼‰ï¼Œå³ç§» 248 ä½

# åœ¨æ±‡ç¼–ä¸­è°ƒç”¨ ERC-20 â€œtransferâ€ å‡½æ•°

æˆ‘ä»¬ç°åœ¨å°†ä½¿ç”¨æ±‡ç¼–è°ƒç”¨ ERC-20 çš„ transfer å‡½æ•°ã€‚æˆ‘ä»¬å°†å¿«é€ŸæŸ¥çœ‹å¦‚ä½•è°ƒç”¨â€œtransferâ€å‡½æ•°ï¼š

![](https://img.learnblockchain.cn/attachments/migrate/1732070013767)

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°â€œtransferâ€å‡½æ•°æ¥å—ä¸¤ä¸ªå˜é‡ï¼š**_to_** å’Œ **_amount_**ã€‚è®©æˆ‘ä»¬ç«‹å³ç¼–å†™æˆ‘ä»¬çš„æ±‡ç¼–ä»£ç ï¼š

fallback() external payable {  
    address memUser = user;  
  
    assembly {  
        // owner check  
        if iszero(eq(caller(), memUser)) {  
            revert(0, 0)  
        }  
  
        // read calldata  
        let token := shr(96, calldataload(0x00))  
        let pair := shr(96, calldataload(0x14))  
        let amountIn := shr(128, calldataload(0x28))  
        let amountOut := shr(128, calldataload(0x38))  
        let tokenOutNo := shr(248, calldataload(0x48))  
  
        // call transfer  
        mstore(0x7c, ERC20\_TRANSFER\_ID)  
        mstore(0x80, pair)  
        mstore(0xa0, amountIn)  
  
        let s1 := call(sub(gas(), 5000), token, 0, 0x7c, 0x44, 0, 0)  
        if iszero(s1) {  
            revert(0, 0)  
        }  
    }  
}

âœ… **mstore**

æˆ‘ä»¬è°ƒç”¨ **â€œmstore(x, y)â€** å°†å€¼ y å­˜å‚¨åˆ°å†…å­˜ä½ç½® x ä¸­ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬å°† _â€œtransferâ€_ çš„ 4 å­—èŠ‚é€‰æ‹©å™¨ 0xa9059cbb å­˜å‚¨åˆ°å†…å­˜ä½ç½® 0x7cï¼ˆ=124 åè¿›åˆ¶ï¼‰ã€‚åœ¨è¿™æ®µæ•°æ®å†™å…¥åï¼Œæˆ‘ä»¬å¯ä»¥å¼€å§‹å°†ä¸‹ä¸€ä¸ªæ•°æ®å­˜å‚¨åœ¨ 0x7c ä¹‹åçš„ 4 å­—èŠ‚å¤„ï¼Œå³ 0x80ï¼ˆ=128 åè¿›åˆ¶ï¼‰ã€‚

è¿™æ¬¡ï¼Œæˆ‘ä»¬å°† pair åœ°å€å­˜å‚¨åœ¨å†…å­˜ä½ç½® 0x80ã€‚è¿™å°†å ç”¨ 32 å­—èŠ‚ï¼Œå› æ­¤ä¸‹ä¸€ä¸ªå‚æ•°å¯ä»¥æ”¾å…¥å†…å­˜ä½ç½® 0xa0ï¼ˆ=160 åè¿›åˆ¶ï¼‰ã€‚

amountIn ä¹Ÿæ˜¯å¦‚æ­¤ã€‚ä» 0xa0 å¼€å§‹ï¼Œæˆ‘ä»¬å°† 32 å­—èŠ‚çš„å€¼å­˜å‚¨åˆ°å†…å­˜ä¸­ã€‚

âœ… **call**

ä½ å¯èƒ½ä¼šæƒ³çŸ¥é“ä¸ºä»€ä¹ˆæˆ‘ä»¬å¿…é¡»åœ¨æ‰§è¡Œå‡½æ•°è°ƒç”¨ä¹‹å‰å°†å‡½æ•°é€‰æ‹©å™¨å’Œå‚æ•°å­˜å‚¨åˆ°å†…å­˜ä¸­ã€‚è¿™æ˜¯å› ä¸º EVM çš„ç»“æ„æ˜¯ä½¿ç”¨å†…å­˜æ¥å¤„ç†å¤–éƒ¨è°ƒç”¨çš„è¿”å›ã€è®¾ç½®å¤–éƒ¨è°ƒç”¨çš„å‡½æ•°å€¼ç­‰ä»»åŠ¡ã€‚

è€ƒè™‘åˆ°è¿™ä¸€ç‚¹ï¼Œä½¿ç”¨â€œcallâ€æ“ä½œç è¿›è¡Œå¤–éƒ¨å‡½æ•°è°ƒç”¨å¹¶ä¸å¤ªå›°éš¾ã€‚

**call(g, a, v, in, insize, out, outsize):** æ˜¯ç”¨äºè°ƒç”¨åœ°å€ _a_ çš„åˆçº¦çš„æ“ä½œç ï¼Œä½¿ç”¨çš„ gas æ•°é‡ä¸º _g_ï¼Œä¼ é€’ _v_ wei ä½œä¸º msg.valueï¼Œä» _in_ å¼€å§‹ä¼ é€’ tx.data ä½ç½®ï¼Œå¤§å°ä¸º _insize_ å­—èŠ‚ï¼Œå¹¶å°†è¿”å›çš„æ•°æ®å­˜å‚¨åœ¨ä» _out_ å¼€å§‹çš„å†…å­˜ä½ç½®ï¼Œå¤§å°ä¸º _outsize_ å­—èŠ‚ã€‚æ­¤å¤–ï¼Œå¦‚æœè°ƒç”¨æˆåŠŸï¼Œæ­¤æ“ä½œç å°†è¿”å› 1ï¼Œå¦åˆ™è¿”å› 0ã€‚

æˆ‘ä»¬å†æ¬¡æŸ¥çœ‹æˆ‘ä»¬çš„ä»£ç ï¼š

let s1 := call(sub(gas(), 5000), token, 0, 0x7c, 0x44, 0, 0)

âœ… **gas:** å¯ç”¨äºæ‰§è¡Œçš„ gas æ•°é‡

æˆ‘ä»¬ä½¿ç”¨ gas() - 5000 è°ƒç”¨ **_token_** åˆçº¦çš„â€œtransferâ€å‡½æ•°ï¼Œcalldata çš„ç»“æ„ä¸ºï¼š**\[selector\]\[pair\]\[amountIn\]**ã€‚calldata å°†ä»å†…å­˜ä½ç½® 0x7c ä»¥ 0x44 å­—èŠ‚ï¼ˆ= 68 å­—èŠ‚ = 4 å­—èŠ‚é€‰æ‹©å™¨ + 32 å­—èŠ‚åœ°å€ + 32 å­—èŠ‚ uint256ï¼‰è¿›è¡Œæ£€ç´¢ã€‚æ­¤è°ƒç”¨ä¸ä¼šè¿”å›ä»»ä½•å€¼ï¼Œå› æ­¤æˆ‘ä»¬ä¸º _out, outsize_ ä¼ é€’ä¸¤ä¸ª 0ã€‚

# åœ¨æ±‡ç¼–ä¸­è°ƒç”¨ Uniswap V2 â€œswapâ€ å‡½æ•°

è¿™ä¸€éƒ¨åˆ†åº”è¯¥å¾ˆç®€å•ï¼Œå› ä¸ºå®ƒæœ¬è´¨ä¸Šç­‰åŒäºæˆ‘ä»¬åœ¨ä¸Šä¸€èŠ‚ä¸­è°ƒç”¨çš„â€œtransferâ€å‡½æ•°ã€‚

åœ¨æˆ‘ä»¬ç¼–å†™â€œswapâ€è°ƒç”¨çš„æ±‡ç¼–ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å» Uniswap V2 æ ¸å¿ƒåˆçº¦ï¼Œçœ‹çœ‹æˆ‘ä»¬æ­£åœ¨è°ƒç”¨çš„å‡½æ•°ï¼š

![](https://img.learnblockchain.cn/attachments/migrate/1732070013837)

ç›¸å½“å¤æ‚ï¼Œä½†æˆ‘ä»¬éœ€è¦çŸ¥é“çš„æ˜¯ï¼Œæˆ‘ä»¬åº”è¯¥å°†ç›¸å…³çš„è¾“å…¥ä»£å¸è¾“å…¥åˆ° pair åˆçº¦ä¸­ï¼Œç„¶åæˆ‘ä»¬å¯ä»¥ä½œä¸ºç»“æœè·å¾— amountOut çš„å…¶ä»–ä»£å¸ã€‚

fallback() external payable {  
    address memUser = user;  
  
    assembly {  
        // owner check  
        if iszero(eq(caller(), memUser)) {  
            revert(0, 0)  
        }  
  
        // read calldata  
        let token := shr(96, calldataload(0x00))  
        let pair := shr(96, calldataload(0x14))  
        let amountIn := shr(128, calldataload(0x28))  
        let amountOut := shr(128, calldataload(0x38))  
        let tokenOutNo := shr(248, calldataload(0x48))  
  
        // call transfer  
        mstore(0x7c, ERC20\_TRANSFER\_ID)  
        mstore(0x80, pair)  
        mstore(0xa0, amountIn)  
  
        let s1 := call(sub(gas(), 5000), token, 0, 0x7c, 0x44, 0, 0)  
        if iszero(s1) {  
            revert(0, 0)  
        }  
  
        // call swap  
        mstore(0x7c, PAIR\_SWAP\_ID)  
        switch tokenOutNo  
        case 0 {  
            mstore(0x80, amountOut)  
            mstore(0xa0, 0)  
        }  
        case 1 {  
            mstore(0x80, 0)  
            mstore(0xa0, amountOut)  
        }  
        mstore(0xc0, address())  
        mstore(0xe0, 0x80)  
  
        let s2 := call(sub(gas(), 5000), pair, 0, 0x7c, 0xa4, 0, 0)  
        if iszero(s2) {  
            revert(0, 0)  
        }  
    }  
}

é¦–å…ˆï¼Œæˆ‘ä»¬å°†â€œswapâ€å‡½æ•°çš„é€‰æ‹©å™¨ 0x022c0d9f å­˜å‚¨åˆ°å†…å­˜ä½ç½® 0x7cã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ£€æŸ¥ tokenOutNo æ˜¯å¦ä¸º 0 æˆ– 1ã€‚å¦‚æœ tokenOutNo ä¸º 0ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬ä»å‰é¢çš„â€œtransferâ€éƒ¨åˆ†å‘é€åˆ° pair çš„è¾“å…¥ä»£å¸æ˜¯ä»£å¸ 1ï¼Œå¹¶ä¸”æˆ‘ä»¬å¸Œæœ›è·å¾— amountOut çš„ä»£å¸ 0 ä½œä¸ºå›æŠ¥ã€‚

å› æ­¤ï¼Œå¦‚æœ tokenOutNo ä¸º 0ï¼Œæˆ‘ä»¬å°† amountOut å­˜å‚¨åˆ° 0x80ï¼Œå¹¶å°† 0 å­˜å‚¨åˆ° 0xa0ã€‚åä¹‹ï¼Œå¦‚æœ tokenOutNo ä¸º 1ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†æ­¤åˆçº¦çš„åœ°å€å­˜å‚¨åˆ°å†…å­˜ä½ç½® 0xc0ï¼Œç„¶åå°†ç©ºå­—èŠ‚å­˜å‚¨åˆ° 0xe0ã€‚

æœ€åï¼Œæˆ‘ä»¬é€šè¿‡ä»¥ä¸‹æ–¹å¼è°ƒç”¨â€œswapâ€ï¼š

let s2 := call(sub(gas(), 5000), pair, 0, 0x7c, 0xa4, 0, 0)

æ­¤å‡½æ•°è°ƒç”¨çš„ calldata ä¸º 164 å­—èŠ‚ï¼Œå…¶æ€»å’Œä¸ºï¼š

*   **selector:** 4 å­—èŠ‚
*   **uint256:** 32 å­—èŠ‚
*   **uint256:** 32 å­—èŠ‚
*   **address:** 32 å­—èŠ‚
*   **empty bytes:** 64 å­—èŠ‚

# æ¯”è¾ƒ gas æˆæœ¬ï¼šSolidity ä¸æ±‡ç¼–

æœ€åï¼Œæˆ‘ç¼–å†™äº†è¿™ä¸ªåä¸ºâ€œswapâ€çš„ fallback å‡½æ•°çš„ Solidity ç‰ˆæœ¬ã€‚ä»¥ä¸‹æ˜¯æˆ‘ä»¬ Sandwich.sol çš„å®Œæ•´ä»£ç ï¼š

// SPDX-License-Identifier: MIT  

```solidity
pragma solidity >=0.8.0;  
  
import "./IERC20.sol";  
import "./SafeTransfer.sol";  
  
interface IUniswapV2Pair {  
    function swap(  
        uint amount0Out,  
        uint amount1Out,  
        address to,  
        bytes calldata data  
    ) external;  
}  
  
contract Sandwich {  
    using SafeTransfer for IERC20;  
  
    address internal immutable user;  
    bytes4 internal constant ERC20_TRANSFER_ID = 0xa9059cbb;  
    bytes4 internal constant PAIR_SWAP_ID = 0x022c0d9f;  
  
    receive() external payable {}  
  
    constructor(address _owner) {  
        user = _owner;  
    }  
  
    function recoverERC20(address token) public {  
        // same code here...  
    }  
  
    function swap(  
        address token,  
        address pair,  
        uint128 amountIn,  
        uint128 amountOut,  
        uint8 tokenOutNo  
    ) external payable {  
        require(msg.sender == user, "Not the owner");  
        IERC20(token).transfer(pair, amountIn);  
        if (tokenOutNo == 0) {  
            IUniswapV2Pair(pair).swap(amountOut, 0, address(this), "");  
        } else {  
            IUniswapV2Pair(pair).swap(0, amountOut, address(this), "");  
        }  
    }  
  
    fallback() external payable {  
       // same code here...  
    }  
}

ä¸€åˆ‡ä¿æŒä¸å˜ï¼Œé™¤äº†æˆ‘æ·»åŠ çš„åä¸ºâ€œswapâ€çš„é¢å¤–å‡½æ•°å’Œ IUniswapV2Pair æ¥å£ã€‚

ä¸ºäº†åœ¨ä¸»ç½‘æµ‹è¯•è¿™ä¸ªå¹¶æ¯”è¾ƒä¸¤ä¸ªå‡½æ•°è°ƒç”¨çš„ gas æˆæœ¬ï¼Œæˆ‘å°†ä½¿ç”¨ Foundry å¯¹ä¸»ç½‘è¿›è¡Œç¡¬åˆ†å‰ã€‚è¿™ä¸ªè¿‡ç¨‹è®©ä½ å¯ä»¥ä»æœ¬åœ°æœºå™¨ä½¿ç”¨ä¸»ç½‘çŠ¶æ€ï¼Œä½†ä¸ä¸‹è½½ä»»ä½•è¿œç¨‹æ•°æ®ã€‚å¯¹ä¸»ç½‘è¿›è¡Œç¡¬åˆ†å‰æ˜¯æµ‹è¯•ä½ çš„å‡½æ•°è°ƒç”¨çš„ä¸€ä¸ªæœ‰ç”¨æ–¹æ³•ï¼Œå› ä¸ºè¿™å°†ä½¿ä½ èƒ½å¤Ÿé’ˆå¯¹çœŸå®çš„ä»¥å¤ªåŠçŠ¶æ€æµ‹è¯•ä½ çš„å‡½æ•°è°ƒç”¨ã€‚

ä½ åŸºæœ¬ä¸Šå¯ä»¥è®¿é—®å·²ç»åœ¨ä»¥å¤ªåŠä¸»ç½‘ä¸Šè¿è¡Œçš„æ‰€æœ‰åè®®ï¼Œå› æ­¤ä½ å¯ä»¥è¿è¡Œçš„æµ‹è¯•èŒƒå›´å˜å¾—æ— ç©·æ— å°½ï¼Œå¹¶ä¸”æ¯”åœ¨ Anvil æœ¬åœ°æµ‹è¯•ç½‘ä¸Šæµ‹è¯•ä½ çš„åˆçº¦æ›´ä¸ºçœŸå®ã€‚ç¡¬åˆ†å‰ä¸ä¼šå°†æ‰€æœ‰çŠ¶æ€å¤åˆ¶åˆ°ä½ çš„æœ¬åœ°æœºå™¨ï¼Œå› æ­¤æ—¢ä¸ä¼šèŠ±è´¹å¾ˆé•¿æ—¶é—´ï¼Œä¹Ÿä¸ä¼šèŠ±è´¹ä»»ä½•è´¹ç”¨ã€‚

ä½ å¯ä»¥å‚è€ƒ Foundry ä¹¦ç±ï¼š

[

## Foundry Book

### A book on all things Foundry

book.getfoundry.sh



](https://book.getfoundry.sh/tutorials/forking-mainnet-with-cast-anvil?source=post_page-----93c31b06cf96--------------------------------)

ä½¿ç”¨ Anvil è¿›è¡Œç¡¬åˆ†å‰éå¸¸ç®€å•ï¼š

anvil --fork-url <RPC_ENDPOINT_OF_YOUR_CHOICE>

ä½¿ç”¨ä½ é€‰æ‹©çš„ RPC ç«¯ç‚¹è¿è¡Œæ­¤å‘½ä»¤ï¼Œä½ å°±å‡†å¤‡å¥½äº†ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦å°†æœ€ç»ˆçš„ Sandwich åˆçº¦éƒ¨ç½²åˆ° Anvil ä¸»ç½‘ç¡¬åˆ†å‰ï¼š

forge create --rpc-url http://127.0.0.1:8545 --constructor-args 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266 --private-key 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80 src/Sandwich.sol:Sandwich

æˆ‘å¾—åˆ°çš„å“åº”æ˜¯ï¼š

\[â °\] Compiling...  
No files changed, compilation skipped  
Deployer: 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266  
Deployed to: 0xE2b5bDE7e80f89975f7229d78aD9259b2723d11F  
Transaction hash: 0x2038f9c7a09037d1ed64d7b93cf7827060ab24ae497c12084bd3a6c086f3df71

Copy: 0xE2b5bDE7e80f89975f7229d78aD9259b2723d11F

ç„¶ååˆ›å»ºä¸€ä¸ªç”¨äºæµ‹è¯•çš„ Javascript æ–‡ä»¶ï¼š

const { ethers } = require('ethers');  
  
const SANDWICH_ADDRESS = '0xE2b5bDE7e80f89975f7229d78aD9259b2723d11F';  
const WETH_ADDRESS = '0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2';  
const USDT_ADDRESS = '0xdAC17F958D2ee523a2206206994597C13D831ec7';  
const WETH_USDT_PAIR_ADDRESS = '0x0d4a11d5EEaaC28EC3F61d100daF4d40471f1852';  
const WETH_TOKEN_0 = 1;  
const DECIMALS = {  
    WETH: 18,  
    USDT: 6  
};  
  
const SANDWICH_ABI = require('./out/Sandwich.sol/Sandwich.json').abi; // ABI returned from Foundry compile  
const WETH_ABI = require('./weth.json'); // I got the ABI from Etherscan  
  
const calcNextBlockBaseFee = (curBlock) => {  
    const baseFee = curBlock.baseFeePerGas;  
    const gasUsed = curBlock.gasUsed;  
    const targetGasUsed = curBlock.gasLimit.div(2);  
    const delta = gasUsed.sub(targetGasUsed);  
  
    const newBaseFee = baseFee.add(  
        baseFee.mul(delta).div(targetGasUsed).div(ethers.BigNumber.from(8))  
    );  
  
    // Add 0-9 wei so it becomes a different hash each time  
    const rand = Math.floor(Math.random() * 10);  
    return newBaseFee.add(rand);  
};  
  
async function main() {  
    const PUBLIC = '0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266';  
    const PRIVATE = '0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80';  
  
    const provider = new ethers.providers.JsonRpcProvider('http://127.0.0.1:8545'); // anvil  
    const wallet = new ethers.Wallet(PRIVATE, provider);  
    const { chainId } = await provider.getNetwork();  
  
    // SETUP: create contract instances  
    const sandwich = new ethers.Contract(SANDWICH_ADDRESS, SANDWICH_ABI, wallet);  
    const weth = new ethers.Contract(WETH_ADDRESS, WETH_ABI, wallet);  
    const usdt = new ethers.Contract(USDT_ADDRESS, WETH_ABI, wallet);  
  
    ////////////////////////  
    // STEP 1: Wrap 1 ETH //  
    ////////////////////////  
    console.log('\\n===== Wrapping ETH =====');  
  
    let wethBalance = await weth.balanceOf(PUBLIC);  
    console.log('- WETH balance before: ', wethBalance.toString());  
  
    // simply send 2 ETH to WETH contract  
    await wallet.sendTransaction({  
        to: WETH_ADDRESS,  
        value: ethers.utils.parseEther('2'),  
    });  
  
    wethBalance = await weth.balanceOf(PUBLIC);  
    console.log('- WETH balance after: ', wethBalance.toString());  
  
    ///////////////////////////////////////////////////////////////////////////////  
    // STEP 2: Transfer WETH to Sandwich contract so we can use it on Uniswap V2 //  
    ///////////////////////////////////////////////////////////////////////////////  
    console.log('\\n===== Transferring WETH =====');  
  
    let calldata = weth.interface.encodeFunctionData(  
        'transfer',  
        [  
            SANDWICH_ADDRESS,  
            ethers.utils.parseUnits('1', DECIMALS.WETH),  
        ]  
    );  
    let signedTx = await wallet.signTransaction({  
        to: WETH_ADDRESS, // call transfer on WETH  
        from: PUBLIC,  
        data: calldata,  
        chainId,  
        maxPriorityFeePerGas: 0,  
        maxFeePerGas: calcNextBlockBaseFee(await provider.getBlock()),  
        gasLimit: 3000000,  
        nonce: await wallet.getTransactionCount(),  
        type: 2,  
    });  
    let txResponse = await provider.sendTransaction(signedTx);  
    let receipt = await provider.getTransactionReceipt(txResponse.hash);  
    // console.log('- WETH transfer gas used: ', receipt.gasUsed.toString());  
  
    wethBalance = await weth.balanceOf(SANDWICH_ADDRESS);  
    console.log('- WETH balance before swap: ', wethBalance.toString());  
  
    let usdtBalance = await usdt.balanceOf(SANDWICH_ADDRESS);  
    console.log('- USDT balance before swap: ', usdtBalance.toString());  
  
    //////////////////////////////////////////////////////////  
    // STEP 3: Calling "swap" function on Sandwich contract //  
    //////////////////////////////////////////////////////////  
    console.log('\\n===== Calling Swap =====');  
  
    calldata = sandwich.interface.encodeFunctionData(  
        'swap',  
        [  
            WETH_ADDRESS,  
            WETH_USDT_PAIR_ADDRESS,  
            ethers.utils.parseUnits('0.5', DECIMALS.WETH),  
            ethers.utils.parseUnits('950', DECIMALS.USDT), // the current rate is 976, change accordingly  
            WETH_TOKEN_0 ? 1 : 0, // out token is 1 if WETH is token 0  
        ]  
    );  
    signedTx = await wallet.signTransaction({  
        to: SANDWICH_ADDRESS, // calling swap on Sandwich  
        from: PUBLIC,  
        data: calldata,  
        chainId,  
        maxPriorityFeePerGas: 0,  
        maxFeePerGas: calcNextBlockBaseFee(await provider.getBlock()),  
        gasLimit: 3000000,  
        nonce: await wallet.getTransactionCount(),  
        type: 2,  
    });  
    txResponse = await provider.sendTransaction(signedTx);  
    receipt = await provider.getTransactionReceipt(txResponse.hash);  
    console.log('- Swap gas used: ', receipt.gasUsed.toString());  
```

```javascript
wethBalance = await weth.balanceOf(SANDWICH_ADDRESS);  
console.log('- WETH balance after swap: ', wethBalance.toString());  
  
usdtBalance = await usdt.balanceOf(SANDWICH_ADDRESS);  
console.log('- USDT balance after swap: ', usdtBalance.toString());  
  
////////////////////////////////////////////////////////////  
// ç¬¬ 4 æ­¥ï¼šè°ƒç”¨ Sandwich åˆçº¦çš„å›é€€å‡½æ•° //  
////////////////////////////////////////////////////////////  
console.log('\\n===== Calling Fallback =====');  
  
calldata = ethers.utils.solidityPack(  
    ['address', 'address', 'uint128', 'uint128', 'uint8'],  
    [  
        WETH_ADDRESS,  
        WETH_USDT_PAIR_ADDRESS,  
        ethers.utils.parseUnits('0.5', DECIMALS.WETH),  
        ethers.utils.parseUnits('950', DECIMALS.USDT),  
        WETH_TOKEN_0 ? 1 : 0,  
    ]  
);  
signedTx = await wallet.signTransaction({  
    to: SANDWICH_ADDRESS,  
    from: PUBLIC,  
    data: calldata,  
    chainId,  
    maxPriorityFeePerGas: 0,  
    maxFeePerGas: calcNextBlockBaseFee(await provider.getBlock()),  
    gasLimit: 3000000,  
    nonce: await wallet.getTransactionCount(),  
    type: 2,  
});  
txResponse = await provider.sendTransaction(signedTx);  
receipt = await provider.getTransactionReceipt(txResponse.hash);  
console.log('- Assembly gas used: ', receipt.gasUsed.toString());  
  
wethBalance = await weth.balanceOf(SANDWICH_ADDRESS);  
console.log('- WETH balance after swap: ', wethBalance.toString());  
  
usdtBalance = await usdt.balanceOf(SANDWICH_ADDRESS);  
console.log('- USDT balance after swap: ', usdtBalance.toString());  
}  
  
(async () => {  
    await main();  
})();  

è¿™æ˜¯ä¸€ä¸ªè¾ƒé•¿çš„è„šæœ¬ï¼Œä½†ç¼–å†™æ–¹å¼æ˜“äºç†è§£ã€‚è¯¥è„šæœ¬åŒ…å«å››ä¸ªæ­¥éª¤ï¼Œåˆ†åˆ«æ˜¯ï¼š

1.  åŒ…è£¹ 2 ä¸ªä»¥å¤ªå¸ï¼Œ
2.  å°† 1 ä¸ª WETH è½¬ç§»åˆ° Sandwich åˆçº¦ï¼Œ
3.  ä½¿ç”¨ Solidity ç‰ˆæœ¬çš„â€œswapâ€å°† 0.5 WETH äº¤æ¢ä¸º USDTï¼Œ
4.  ä½¿ç”¨ Yul ç‰ˆæœ¬çš„â€œswapâ€å°† 0.5 WETH äº¤æ¢ä¸º USDT

æœ€ç»ˆç»“æœå¾ˆæœ‰è¶£ï¼š

![](https://img.learnblockchain.cn/attachments/migrate/1732070014362)

æ­£å¦‚æˆ‘ä»¬æ‰€çœ‹åˆ°çš„ï¼Œè°ƒç”¨ Solidity ç‰ˆæœ¬çš„ swap æ¶ˆè€—äº† 100765 gasï¼Œè€Œæ±‡ç¼–ç‰ˆæœ¬æ¶ˆè€—äº† 99373 gasã€‚ gas æˆæœ¬æœ‰æ‰€æ”¹å–„ã€‚

# æ¥ä¸‹æ¥æ˜¯ä»€ä¹ˆï¼Ÿ

è¿™ç¯‡æ–‡ç« è¾ƒé•¿ï¼Œæ¶‰åŠåœ¨ MEV äº¤æ˜“ä¸­ä½¿ç”¨æ±‡ç¼–ã€‚æˆ‘ä»¬çœ‹åˆ°ä½¿ç”¨æ±‡ç¼–å¯ä»¥ä½¿æˆ‘ä»¬çš„åˆçº¦æ›´å…· gas æ•ˆç‡ã€‚

åœ¨æ¥ä¸‹æ¥çš„æ–‡ç« ä¸­ï¼Œæˆ‘å°†ï¼š

1.  ä½¿ç”¨ Pythonã€Javascriptã€Golang å’Œ Rust æ„å»ºä¸€ä¸ªç®€å•çš„ MEV æœºå™¨äººï¼Œç„¶åå°è¯•åŒæ—¶è¿è¡Œå®ƒä»¬ï¼Œçœ‹çœ‹è¯­è¨€å·®å¼‚æ˜¯å¦ä¼šå¯¹æ€§èƒ½æå‡äº§ç”Ÿå½±å“ã€‚
2.  ä½¿ç”¨ REVM æ„å»ºä¸€ä¸ªç®€å•çš„äº¤æ˜“æ¨¡æ‹Ÿå™¨ã€‚è¿™å¯ä»¥å¸®åŠ©ç†è§£ Foundry çš„åº•å±‚å·¥ä½œåŸç†ï¼Œå¹¶å¸®åŠ©æ„å»ºä¸€ä¸ªé«˜åº¦ä¼˜åŒ–çš„æ¨¡æ‹Ÿå¼•æ“ä¾›æˆ‘ä»¬çš„ MEV æœºå™¨äººä½¿ç”¨ã€‚
3.  å°è¯•ç†è§£ç”± MevAlphaLeak ç¼–å†™çš„ ApeBot ([https://remix.ethereum.org/#address=0x666f80a198412bcb987c430831b57ad61facb666](https://remix.ethereum.org/#address=0x666f80a198412bcb987c430831b57ad61facb666))
4.  æ„å»ºä¸€ä¸ªç®€å•çš„ CEX-DEX å¥—åˆ©æœºå™¨äººï¼Œä»¥åå‘æ‰§è¡Œå½±å“ä»·æ ¼çš„äº¤æ˜“ã€‚

æˆ‘ç›®å‰æ­£åœ¨åŒæ—¶è¿›è¡Œè¿™å››ä¸ªé¡¹ç›®ï¼Œä¸çŸ¥é“å“ªä¸ªä¼šå…ˆå®Œæˆã€‚æˆ‘çŸ¥é“æˆ‘å¿…é¡»ä¸“æ³¨äºä¸€ä¸ªé¡¹ç›®ï¼Œä½†æˆ‘è§‰å¾—æˆ‘å¤©ç”Ÿå°±é€‚åˆå¤šä»»åŠ¡å¤„ç†â€¦â€¦å“¦ï¼Œå¥½å§ã€‚

å¾ˆå¿«å†è§ï¼æ„Ÿè°¢ä½ çš„é˜…è¯» ğŸ˜ƒ

ä»¥ä¸‹æ˜¯æˆ‘ç”¨æ¥å­¦ä¹  EVM å’Œæ±‡ç¼–çš„ä¸€äº›ç²¾å½©èµ„æºã€‚

## å‚è€ƒæ–‡çŒ®ï¼š

[

## Yul åˆå­¦è€…æŒ‡å—

### ä»€ä¹ˆæ˜¯ Yulï¼Ÿ

coinsbench.com



](https://coinsbench.com/beginners-guide-to-yul-12a0a18095ef?source=post_page-----93c31b06cf96--------------------------------)

[

## EVM æ·±åº¦æ¢è®¨ï¼šé€šå¾€é˜´æš—è¶…çº§ç¼–ç è€…çš„é“è·¯ ğŸ¥· ğŸ’» - ç¬¬ 1 éƒ¨åˆ†

### æ·±å…¥æŒ–æ˜åˆçº¦å‡½æ•°è°ƒç”¨æœŸé—´çš„ EVM æœºåˆ¶

noxx.substack.com



](https://noxx.substack.com/p/evm-deep-dives-the-path-to-shadowy?source=post_page-----93c31b06cf96--------------------------------)

[ å…³äº Solidity çš„ä¸€åˆ‡ â€” æ–‡ç« ç³»åˆ—](https://medium.com/coinmonks/all-about-solidity-article-series-f57be7bf6746?source=post_page-----93c31b06cf96--------------------------------)

[ å®ç”¨çš„ Solidity æ±‡ç¼–å…¥é—¨ï¼šç¬¬ 0 éƒ¨åˆ†](https://mirror.xyz/0xB38709B8198d147cc9Ff9C133838a044d78B064B/nk40v2MJKSHXXNSlbqqhpwJf4MtZ9V2Vp8P_bSNwjYc?source=post_page-----93c31b06cf96--------------------------------)

[ å¦‚ä½•åœ¨ Solidity ä¸­ä½¿ç”¨ä½çº§è°ƒç”¨è¿›è¡Œåˆçº¦å‡½æ•°è°ƒç”¨å’Œæ”¯ä»˜ ](https://kushgoyal.com/ethereum-solidity-how-use-call-delegatecall/?source=post_page-----93c31b06cf96--------------------------------)
```

> æˆ‘æ˜¯ [AI ç¿»è¯‘å®˜](https://learnblockchain.cn/people/19584)ï¼Œä¸ºå¤§å®¶è½¬è¯‘ä¼˜ç§€è‹±æ–‡æ–‡ç« ï¼Œå¦‚æœ‰ç¿»è¯‘ä¸é€šçš„åœ°æ–¹ï¼Œåœ¨[è¿™é‡Œ](https://github.com/lbc-team/Pioneer/blob/master/translations/9972.md)ä¿®æ”¹ï¼Œè¿˜è¯·åŒ…æ¶µï½