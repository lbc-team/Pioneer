
>- åŸæ–‡é“¾æ¥ï¼š[medium.com/@solidquant...](https://medium.com/@solidquant/100-hours-of-building-a-sandwich-bot-a89235281da3)
>- è¯‘è€…ï¼š[AIç¿»è¯‘å®˜](https://learnblockchain.cn/people/19584)ï¼Œæ ¡å¯¹ï¼š[ç¿»è¯‘å°ç»„](https://learnblockchain.cn/people/412)
>- æœ¬æ–‡é“¾æ¥ï¼š[learnblockchain.cn/articleâ€¦](https://learnblockchain.cn/article/9954)
    
# 100 å°æ—¶æ„å»ºä¸‰æ˜æ²»æœºå™¨äºº

## ä»å¤´åˆ°å°¾ï¼šæ­£ç¡®æ„å»ºè‡ªå·±çš„ä¸‰æ˜æ²»æœºå™¨äºº

![](https://img.learnblockchain.cn/attachments/migrate/1731979870047)

> Fotor AIï¼šâ€œåƒä¸‰æ˜æ²»çš„å‰å¨ƒå¨ƒâ€ç»è¿‡ 16 æ¬¡è¿­ä»£

**ä»Šå¤©ï¼Œæˆ‘ä»¬å°†ä¸€èµ·æ„å»ºä¸€ä¸ªä¸‰æ˜æ²»æœºå™¨äººã€‚** ğŸ¥ª

æ˜¯çš„ï¼Œæˆ‘çŸ¥é“è¿™å¬èµ·æ¥å¯èƒ½æœ‰äº›å¥‡æ€ªã€‚æˆ‘ç†è§£ä½ å¯èƒ½åœ¨æƒ³ï¼š

> åˆæ¥äº†ã€‚ç½‘ä¸Šå·²ç»æœ‰å¾ˆå¤šèµ„æºå¯ä»¥å­¦ä¹ è¿™ä¸ªäº†ã€‚ä¸ºä»€ä¹ˆè¿˜è¦ä»ä½ è¿™æ ·çš„äººçš„èº«ä¸Šå†æ¥ä¸€ç¯‡æ— èŠçš„ä¸‰æ˜æ²»æœºå™¨äººæ•™ç¨‹ï¼Ÿ

å¥½é—®é¢˜ã€‚ ğŸ¤”

è€å®è¯´ï¼Œå®é™…ä¸Šç½‘ä¸Šå¹¶æ²¡æœ‰é‚£ä¹ˆå¤šå¥½çš„èµ„æºã€‚è€Œä¸”é‚£äº›èµ„æºï¼Œè¦ä¹ˆæ˜¯å‡ ä¸ªæœˆ/å‡ å¹´å‰çš„ï¼Œè¦ä¹ˆåœ¨ä½¿ç”¨æ¡ˆä¾‹ä¸Šæœ‰é™ï¼Œæ‰€ä»¥ä¸å¦¨ç¨å¾®æ›´æ–°ä¸€ä¸‹ä»£ç ã€‚

æˆ‘èŠ±äº†è¶…è¿‡ 100 å°æ—¶æ¥å®Œå–„è¿™ä¸ªè®¾ç½®ã€‚æ— è®ºä½ æ˜¯åˆšåˆšæ¥è§¦è¿™ä¸ªç”Ÿæ€ç³»ç»Ÿï¼Œè¿˜æ˜¯æ·±å…¥å…¶ä¸­ï¼Œéƒ½å¯ä»¥æŠŠè¿™å½“ä½œä½ çš„æŒ‡å—ã€‚

å¦‚æœä½ è¿˜æ²¡æœ‰å°è¯•ä»é›¶å¼€å§‹æ„å»ºä¸€ä¸ª MEV æœºå™¨äººï¼Œç°åœ¨æ˜¯ä½ çš„æœºä¼šã€‚å¿«é€Ÿæé†’ä¸€ä¸‹ï¼Œè¿™ä¸ªé¡¹ç›®ä¸ä¼šä»ç¬¬ä¸€å¤©å°±å¼€å§‹ç›ˆåˆ©ã€‚å¦‚æœå¯ä»¥çš„è¯ï¼Œå®ƒå°±ä¸ä¼šåƒè¿™æ ·å…¬å¼€åˆ†äº«ã€‚ä½†å®ƒä¼šéå¸¸æ¥è¿‘çœŸå®çš„æƒ…å†µï¼Œéšç€æˆ‘ä»¬é€æ­¥æ·»åŠ æ›´å¤šåŠŸèƒ½ï¼Œæ”¶ç›Šä¼šå¼€å§‹æµå…¥ã€‚æˆ‘ä»¬å°†åœ¨ä¸‹ä¸ªæœˆå¯¹ä»£ç è¿›è¡Œå¾®è°ƒï¼Œä»¥å®ç°æœ€ä½³æ€§èƒ½ (ç„¶åå†æ·±å…¥ç ”ç©¶ç‹™å‡»å’Œæ”¯æŒSolana)ã€‚

**è¿™æ˜¯æœ€ç»ˆç»“æœçš„é¢„è§ˆï¼š**

![](https://img.learnblockchain.cn/attachments/migrate/1731979870044)

æˆ‘åˆ†äº«äº†æˆ‘çš„ Github ä»“åº“é“¾æ¥ï¼Œä¾›å–œæ¬¢ç«‹å³æ·±å…¥ä»£ç çš„äººä½¿ç”¨ï¼š

[ GitHub - solidquant/sandooo](https://github.com/solidquant/sandooo?source=post_page-----a89235281da3--------------------------------)

æœ¬ç³»åˆ—å°†åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼š

1.  **ï¼ˆç¬¬ 1 éƒ¨åˆ†ï¼‰ï¼šè¯†åˆ«**
2.  **ï¼ˆç¬¬ 2 éƒ¨åˆ†ï¼‰ï¼šæ‰§è¡Œ**

åœ¨ä»Šå¤©çš„æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†ä¸»è¦å…³æ³¨è¯†åˆ«è¿‡ç¨‹ï¼Œè€Œåœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­æ·±å…¥æ¢è®¨å¦‚ä½•å¤„ç†æ‰§è¡Œéƒ¨åˆ†ã€‚

## ç›®å½•ï¼š

1.  **ä¸‰æ˜æ²»æœºå™¨äºº 101**
2.  **ä½¿ç”¨ Solidity/Yul çš„ä¸‰æ˜æ²»æ™ºèƒ½åˆçº¦**
3.  **ä½¿ç”¨ REVM çš„ä¸‰æ˜æ²»æ¨¡æ‹Ÿå¼•æ“**

## å¼•è¨€

æˆ‘ä»¬å¤§å¤šæ•°äººå¯èƒ½éƒ½ç†Ÿæ‚‰ç”±**libevm**ç¼–å†™çš„ JS ä¸‰æ˜æ²»æœºå™¨äººï¼š

[ GitHub - libevm/subway](https://github.com/libevm/subway?source=post_page-----a89235281da3--------------------------------): å¦‚ä½•åœ¨ä»¥å¤ªåŠä¸Šæ‰§è¡Œä¸‰æ˜æ²»æ”»å‡»çš„å®ç”¨ç¤ºä¾‹


æˆ‘ä»ç„¶è®°å¾—æˆ‘ç¬¬ä¸€æ¬¡æ¥è§¦ MEVï¼Œæ‰€æœ‰çš„ä¸€åˆ‡éƒ½å§‹äºè¿™ä¸ªè€æ´¾çš„ä»“åº“â€”â€”æ¸¸æˆä¸­çš„çœŸæ­£ç»å…¸ã€‚å°½ç®¡è¿™ä¸ªé¡¹ç›®å·²ç»æœ‰äº›å¹´å¤´ï¼Œä½†ä»ä¸­å¯ä»¥å­¦åˆ°å¾ˆå¤šä¸œè¥¿ã€‚å¯¹äºä»»ä½•åˆå­¦ MEV çš„äººï¼Œç¡®ä¿ä½ é€è¡Œåˆ†ææ¯ä¸€è¡Œä»£ç ã€‚

ç„¶è€Œï¼Œå½“ç„¶å­˜åœ¨ä¸€äº›å±€é™æ€§ã€‚å¹¶ä¸æ˜¯å› ä¸ºè¿™ä¸ªé¡¹ç›®ä¸å‡ºè‰²ï¼Œè€Œæ˜¯**åœ¨è¿‡å»ä¸‰å¹´ä¸­ï¼ŒMEV å¸‚åœºå‘ç”Ÿäº†ä¸¥é‡çš„æ¼”å˜**ã€‚

æˆ‘ä»¬åœ¨è¿™é‡ŒæŒ–æ˜è¿™äº›å˜åŒ–ï¼Œçœ‹çœ‹å¦‚ä»Šåœ¨ MEV é¢†åŸŸè·åˆ©åˆ°åº•éœ€è¦ä»€ä¹ˆã€‚å¦‚æœä½ å’Œæˆ‘ä¸€æ ·å…´å¥‹ï¼Œé‚£å°±è®©æˆ‘ä»¬ç»§ç»­è¿™æ®µæ—…ç¨‹ã€‚ğŸ™Œ

ğŸ‘¾ åŠ å…¥æˆ‘ä»¬çš„ Discord å›¢é˜Ÿï¼Œæˆåƒä¸Šä¸‡çš„äººæ¯å¤©éƒ½åœ¨è®¨è®º MEV ç›¸å…³çš„å†…å®¹ã€‚å•ç‹¬ç ”ç©¶å¯èƒ½ä¼šæœ‰äº›å­¤ç‹¬ï¼Œæ‰€ä»¥å¿«æ¥æ‰“ä¸ªæ‹›å‘¼ ğŸ„ğŸ„ã€‚çœ‹çœ‹å…¶ä»–äººæ˜¯å¦‚ä½•åº”å¯¹è¿™ä¸ªé¢†åŸŸçš„ï¼š

[ åŠ å…¥ Solid Quant Discord æœåŠ¡å™¨ï¼](https://discord.com/invite/e6KpjTQP98?source=post_page-----a89235281da3--------------------------------)


åœ¨æ¯ä¸ª MEV ç­–ç•¥ä¸­ï¼Œä½ å¿…é¡»é‡‡å–ä¸¤ä¸ªæ­¥éª¤ï¼š**è¯†åˆ«**å’Œ**æ‰§è¡Œ**ã€‚åœ¨ä»Šå¤©çš„æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†é‡ç‚¹å…³æ³¨è¯†åˆ«ä¸‰æ˜æ²»æœºä¼šã€‚åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†å‘åŒºå—æ„å»ºè€…å‘é€çœŸå®è®¢å•ï¼Œå¹¶å°è¯•ä¸å…¶ä»–ä¸‰æ˜æ²»æœºå™¨äººç«äº‰ã€‚

å¦‚æœä½ è¿˜ä¸å¤ªç†Ÿæ‚‰åŒºå—æ„å»ºè€…ï¼Œå¯ä»¥çœ‹çœ‹æˆ‘ä¹‹å‰çš„æ–‡ç« ï¼š

[æˆ‘ä¸åœ¨ä¹æˆ‘æ˜¯å¦è¢«å¤¹åœ¨ä¸­é—´ï¼Œæ›´å¤§çš„äº‹æƒ…æ­£åœ¨åˆ°æ¥](/@solidquant/i-dont-care-if-i-get-sandwiched-bigger-things-are-coming-to-mev-d1dca7dedf30?source=post_page-----a89235281da3--------------------------------) ä»‹ç»äº† MEV çš„å†…éƒ¨è¿ä½œä»¥åŠè¡Œä¸šå¦‚ä½•è½¬å˜


## ä¸‰æ˜æ²»æœºå™¨äºº 101

æˆ‘ä»¬å°†é¦–å…ˆè®¾ç½®æˆ‘ä»¬çš„é¡¹ç›®ã€‚

âœ‹âœ‹ **è¯·æ³¨æ„ï¼Œä½¿ç”¨å…¨èŠ‚ç‚¹è¿è¡Œç”Ÿäº§ä»£ç å°†ä¸ºä½ æä¾›æœ€ä½³æ€§èƒ½ã€‚MEV ç­–ç•¥é€šå¸¸éå¸¸ä¾èµ–ç½‘ç»œï¼Œå› æ­¤æœ€å¥½æ¶ˆé™¤ä»»ä½•ç›¸å…³çš„å»¶è¿Ÿï¼Œè€Œæœ€ç®€å•çš„æ–¹æ³•å°±æ˜¯è¿è¡Œä¸€ä¸ªå…¨èŠ‚ç‚¹ã€‚æˆ‘ä¸ªäººä½¿ç”¨ Geth + Lighthouseã€‚**

æˆ‘è¿˜ä½¿ç”¨**Rust** ğŸ¦€è¿›è¡Œæ•´ä¸ªé¡¹ç›®ï¼Œå¦‚æœä½ è¿˜ä¸ç†Ÿæ‚‰ Rustï¼Œä¹Ÿä¸ç”¨æ‹…å¿ƒï¼Œå› ä¸ºè¿™é‡Œçš„æ¦‚å¿µå³ä½¿ä½ ä¸æ‡‚ä¹Ÿèƒ½ç†è§£ã€‚ä½†å»ºè®®ä½ åœ¨æ·±å…¥ä¹‹å‰å…ˆå­¦ä¹  Rustã€‚

### é¡¹ç›®è®¾ç½®

é¦–å…ˆï¼Œåœ¨ä½ çš„æœ¬åœ°æœºå™¨ä¸Šåˆ›å»ºä¸€ä¸ªæ–°çš„ Rust é¡¹ç›®ï¼Œæ–¹æ³•æ˜¯ï¼š

cargo new sandooo

è¿™å°†åœ¨åä¸º**sandooo**çš„æ–°ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª Rust æ¨¡æ¿ã€‚

ä½¿ç”¨ä½ é€‰æ‹©çš„ IDE æ‰“å¼€è¯¥ç›®å½•ï¼Œå¹¶å°†ä»¥ä¸‹å†…å®¹å¤åˆ¶å¹¶ç²˜è´´åˆ°**Cargo.toml**æ–‡ä»¶ä¸­ **(sandooo/Cargo.toml)**ï¼š

[ sandooo/Cargo.toml at main Â· solidquant/sandooo](https://github.com/solidquant/sandooo/blob/main/Cargo.toml?source=post_page-----a89235281da3--------------------------------) ä¸€ä¸ªä¸‰æ˜æ²»æœºå™¨äººã€‚é€šè¿‡åœ¨ GitHub ä¸Šåˆ›å»ºå¸æˆ·æ¥ä¸º solidquant/sandooo çš„å¼€å‘åšå‡ºè´¡çŒ®ã€‚

  

```


\[package\]  
name = "sandooo"  
version = "0.1.0"  
edition = "2021"  
  
\[dependencies\]  
dotenv = "0.15.0"  
anyhow = "1.0.70"  
itertools = "0.11.0"  
serde = "1.0.188"  
serde\_json = "1.0.107"  
bounded-vec-deque = "0.1.1"  
  
\# Telegram  
teloxide = { version = "0.12", features = \["macros"\] }  
  
futures = "0.3.5"  
futures-util = "\*"  
tokio = { version = "1.29.0", features = \["full"\] }  
tokio-stream = { version = "0.1", features = \['sync'\] }  
tokio-tungstenite = "\*"  
async-trait = "0.1.74"  
  
ethers-core = "2.0"  
ethers-providers = "2.0"  
ethers-contract = "2.0"  
ethers = { version = "2.0", features = \["abigen", "ws", "ipc"\] }  
  
ethers-flashbots = { git = "https://github.com/onbjerg/ethers-flashbots" }  
  
eth-encode-packed = "0.1.0"  
rlp = { version = "0.5", features = \["derive"\] }  
  
foundry-evm-mini = { git = "https://github.com/solidquant/foundry-evm-mini.git" }  
  
revm = { version = "3", default-features = false, features = \[  
  "std",  
  "serde",  
  "memory\_limit",  
  "optional\_eip3607",  
  "optional\_block\_gas\_limit",  
  "optional\_no\_base\_fee",  
\] }  
  
csv = "1.2.2"  
colored = "2.0.0"  
log = "0.4.17"  
fern = { version = "0.6.2", features = \["colored"\] }  
chrono = "0.4.23"  
indicatif = "0.17.5"  
  
\[patch.crates-io\]  
revm = { git = "https://github.com/bluealloy/revm/", rev = "80c909d6f242886cb26e6103a01d1a4bf9468426" }  
  
\[profile.release\]  
codegen-units = 1  
lto = "fat"
```

å®Œæˆåï¼Œåœ¨**src**ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªæ–°ç›®å½•ï¼Œå¹¶å‘½åä¸º**common**ã€‚ç„¶ååˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶ï¼Œå‘½åä¸ºï¼š**constants.rs (sandooo/src/common/constants.rs)**ï¼š

[ sandooo/src/common/constants.rs 
](https://github.com/solidquant/sandooo/blob/main/src/common/constants.rs?source=post_page-----a89235281da3--------------------------------)
 ä¸€ä¸ªä¸‰æ˜æ²»æœºå™¨äººã€‚é€šè¿‡åœ¨ GitHub ä¸Šåˆ›å»ºä¸€ä¸ªå¸æˆ·æ¥ä¸º solidquant/sandooo çš„å¼€å‘åšå‡ºè´¡çŒ®ã€‚

 

```
pub static PROJECT_NAME: &str = "sandooo";  
  
// åŠ è½½ç¯å¢ƒå˜é‡ä¸ºå­—ç¬¦ä¸²å€¼çš„å‡½æ•°  
pub fn get_env(key: &str) -> String {  
    std::env::var(key).unwrap_or(String::from(""))  
}  
  
#[derive(Debug, Clone)]  
pub struct Env {  
    pub https_url: String,  
    pub wss_url: String,  
    pub bot_address: String,  
    pub private_key: String,  
    pub identity_key: String,  
    pub telegram_token: String,  
    pub telegram_chat_id: String,  
    pub use_alert: bool,  
    pub debug: bool,  
}  
  
// åˆ›å»ºæ–°çš„ Env ç»“æ„å°†è‡ªåŠ¨åŠ è½½ç¯å¢ƒå˜é‡  
impl Env {  
    pub fn new() -> Self {  
        Env {  
            https_url: get_env("HTTPS_URL"),  
            wss_url: get_env("WSS_URL"),  
            bot_address: get_env("BOT_ADDRESS"),  
            private_key: get_env("PRIVATE_KEY"),  
            identity_key: get_env("IDENTITY_KEY"),  
            telegram_token: get_env("TELEGRAM_TOKEN"),  
            telegram_chat_id: get_env("TELEGRAM_CHAT_ID"),  
            use_alert: get_env("USE_ALERT").parse::<bool>().unwrap(),  
            debug: get_env("DEBUG").parse::<bool>().unwrap(),  
        }  
    }  
}  
  
pub static COINBASE: &str = "0xDAFEA492D9c6733ae3d56b7Ed1ADB60692c98Bc5"; // Flashbots Builder  
  
pub static WETH: &str = "0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2";  
pub static WETH_BALANCE_SLOT: i32 = 3;  
pub static WETH_DECIMALS: u8 = 18;
```

è¿™ä½¿æˆ‘ä»¬èƒ½å¤Ÿåœ¨å¯åŠ¨æ—¶åŠ è½½ç¯å¢ƒå˜é‡ã€‚è‡ªç„¶ï¼Œä¸‹ä¸€æ­¥æ˜¯åœ¨æ ¹ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª **.env** æ–‡ä»¶ï¼Œå³ **sandooo** ç›®å½• **(sandooo/.env)**ï¼š

[  sandooo/.env.example ](https://github.com/solidquant/sandooo/blob/main/.env.example?source=post_page-----a89235281da3--------------------------------)

 ä¸€ä¸ªä¸‰æ˜æ²»æœºå™¨äººã€‚é€šè¿‡åœ¨ GitHub ä¸Šåˆ›å»ºä¸€ä¸ªå¸æˆ·æ¥ä¸º solidquant/sandooo çš„å¼€å‘åšå‡ºè´¡çŒ®ã€‚

 




```
HTTPS_URL=http://localhost:8545  
WSS_URL=ws://localhost:8546  
BOT_ADDRESS="..."  
PRIVATE_KEY="..."  
IDENTITY_KEY="..."  
TELEGRAM_TOKEN="..."  
TELEGRAM_CHAT_ID="..."  
USE_ALERT=false  
DEBUG=true  
  
RUST_BACKTRACE=1
```
    
*   **PRIVATE_KEY**: å¦‚æœä½ æ‰“ç®—ä½¿ç”¨çœŸå®é’±åŒ…è¿è¡Œä¸‰æ˜æ²»æœºå™¨äººï¼Œè¿™å°±æ˜¯ä½ çš„å®é™…ç§é’¥
*   **IDENTITY_KEY**: è¿™å¯ä»¥è®¾ç½®ä¸ºä½ é€‰æ‹©çš„ä»»ä½•ç§é’¥ã€‚æ¥æ”¶èº«ä»½å¯†é’¥çš„æ„å»ºè€…å°†ä½¿ç”¨å®ƒæ ¹æ®æœç´¢è€…å£°èª‰ä¼˜å…ˆå¤„ç†æŸäº›æ†ç»‘åŒ…ã€‚ä½ å¯ä»¥ä»è¿™é‡Œäº†è§£æ›´å¤šå…³äºæœç´¢è€…å£°èª‰çš„ä¿¡æ¯: [https://docs.flashbots.net/flashbots-auction/advanced/reputation](https://docs.flashbots.net/flashbots-auction/advanced/reputation)
*   **TELEGRAM_TOKEN / TELEGRAM_CHAT_ID**: å¦‚æœä½ ä¸æƒ³ä½¿ç”¨ Telegram è­¦æŠ¥ï¼Œå¯ä»¥å°†è¿™äº›å­—æ®µç•™ç©ºã€‚
*   **DEBUG**: æˆ‘ä»¬ç¨åå°†ä½¿ç”¨æ­¤æ ‡å¿—æ¥æ”¯æŒå¼€å‘/ç”Ÿäº§æ¨¡å¼ã€‚å¦‚æœ **DEBUG** è®¾ç½®ä¸º trueï¼Œæˆ‘ä»¬å°†åªè¿è¡Œæ¨¡æ‹Ÿï¼Œè€Œä¸å‘é€ä»»ä½•çœŸå®çš„æ†ç»‘åŒ…ã€‚

æˆ‘ä»¬è¿˜å¸Œæœ›ç¾åŒ–æˆ‘ä»¬çš„æ§åˆ¶å°æ—¥å¿—ï¼Œå› æ­¤æˆ‘ä»¬åœ¨ **src/common** ç›®å½•ä¸­æ·»åŠ ä¸€ä¸ª **utils.rs** æ–‡ä»¶ **(sandooo/src/common/utils.rs)**ï¼š

[ sandooo/src/common/utils.rs  ](https://github.com/solidquant/sandooo/blob/main/src/common/utils.rs?source=post_page-----a89235281da3--------------------------------)
 ä¸€ä¸ªä¸‰æ˜æ²»æœºå™¨äººã€‚é€šè¿‡åœ¨ GitHub ä¸Šåˆ›å»ºä¸€ä¸ªå¸æˆ·æ¥ä¸º solidquant/sandooo çš„å¼€å‘åšå‡ºè´¡çŒ®ã€‚

 




```
use anyhow::Result;  
use ethers::core::rand::thread_rng;  
use ethers::prelude::*;  
use ethers::{  
    self,  
    types::{  
        transaction::eip2930::{AccessList, AccessListItem},  
        U256,  
    },  
};  
use fern::colors::{Color, ColoredLevelConfig};  
use foundry_evm_mini::evm::utils::{b160_to_h160, h160_to_b160, ru256_to_u256, u256_to_ru256};  
use log::LevelFilter;  
use rand::Rng;  
use revm::primitives::{B160, U256 as rU256};  
use std::str::FromStr;  
use std::sync::Arc;  
  
use crate::common::constants::{PROJECT_NAME, WETH};  
  
// æ ¼å¼åŒ–æˆ‘ä»¬çš„æ§åˆ¶å°æ—¥å¿—çš„å‡½æ•°  
pub fn setup_logger() -> Result<()> {  
    let colors = ColoredLevelConfig {  
        trace: Color::Cyan,  
        debug: Color::Magenta,  
        info: Color::Green,  
        warn: Color::Red,  
        error: Color::BrightRed,  
        ..ColoredLevelConfig::new()  
    };  
  
    fern::Dispatch::new()  
        .format(move |out, message, record| {  
            out.finish(format_args!(  
                "{}[{}] {}",  
                chrono::Local::now().format("[%H:%M:%S]"),  
                colors.color(record.level()),  
                message  
            ))  
        })  
        .chain(std::io::stdout())  
        .level(log::LevelFilter::Error)  
        .level_for(PROJECT_NAME, LevelFilter::Info)  
        .apply()?;  
  
    Ok(())  
}  
  
// è®¡ç®—ä¸‹ä¸€ä¸ªåŒºå—çš„åŸºç¡€è´¹ç”¨ï¼Œç»™å®šä¸Šä¸€ä¸ªåŒºå—çš„ gas ä½¿ç”¨é‡/é™åˆ¶  
// å‚è€ƒ: https://www.blocknative.com/blog/eip-1559-fees  
pub fn calculate_next_block_base_fee(  
    gas_used: U256,  
    gas_limit: U256,  
    base_fee_per_gas: U256,  
) -> U256 {  
    let gas_used = gas_used;  
  
    let mut target_gas_used = gas_limit / 2;  
    target_gas_used = if target_gas_used == U256::zero() {  
        U256::one()  
    } else {  
        target_gas_used  
    };  
  
    let new_base_fee = {  
        if gas_used > target_gas_used {  
            base_fee_per_gas  
                + ((base_fee_per_gas * (gas_used - target_gas_used)) / target_gas_used)  
                    / U256::from(8u64)  
        } else {  
            base_fee_per_gas  
                - ((base_fee_per_gas * (target_gas_used - gas_used)) / target_gas_used)  
                    / U256::from(8u64)  
        }  
    };  
  
    let seed = rand::thread_rng().gen_range(0..9);  
    new_base_fee + seed  
}  
  
pub fn access_list_to_ethers(access_list: Vec<(B160, Vec<rU256>)>) -> AccessList {  
    AccessList::from(  
        access_list  
            .into_iter()  
            .map(|(address, slots)| AccessListItem {  
                address: b160_to_h160(address),  
                storage_keys: slots  
                    .into_iter()  
                    .map(|y| H256::from_uint(&ru256_to_u256(y)))  
                    .collect(),  
            })  
            .collect::<Vec<AccessListItem>>(),  
    )  
}  
  
pub fn access_list_to_revm(access_list: AccessList) -> Vec<(B160, Vec<rU256>)> {  
    access_list  
        .0  
        .into_iter()  
        .map(|x| {  
            (  
                h160_to_b160(x.address),  
                x.storage_keys  
                    .into_iter()  
                    .map(|y| u256_to_ru256(y.0.into()))  
                    .collect(),  
            )  
        })  
        .collect()  
}  
  
abigen!(  
    IERC20,  
    r#"[  
        function balanceOf(address) external view returns (uint256)  
    ]"#,  
);  
  
// å®ç”¨å‡½æ•°  
  
pub async fn get_token_balance(  
    provider: Arc<Provider<Ws>>,  
    owner: H160,  
    token: H160,  
) -> Result<U256> {  
    let contract = IERC20::new(token, provider);  
    let token_balance = contract.balance_of(owner).call().await?;  
    Ok(token_balance)  
}  

```rust
pub fn create_new_wallet() -> (LocalWallet, H160) {  
    let wallet = LocalWallet::new(&mut thread_rng());  
    let address = wallet.address();  
    (wallet, address)  
}  
  
pub fn to_h160(str_address: &'static str) -> H160 {  
    H160::from_str(str_address).unwrap()  
}  
  
pub fn is_weth(token_address: H160) -> bool {  
    token_address == to_h160(WETH)  
}
```

**setup_logger** å‡½æ•°å°†è´Ÿè´£æ ¼å¼åŒ–æˆ‘ä»¬çš„æ—¥å¿—ï¼Œæˆ‘ä»¬è¿˜æ·»åŠ äº†ä¸€äº›é¢å¤–çš„å‡½æ•°ä»¥ä¾¿åœ¨æ•´ä¸ªé¡¹ç›®ä¸­ä½¿ç”¨ã€‚æˆ‘ä»¬å°†åœ¨å®ƒä»¬å‡ºç°æ—¶çœ‹åˆ°å®ƒä»¬çš„ç”¨æ³•ã€‚

æˆ‘ä»¬å¿«å®Œæˆäº†ã€‚æˆ‘ä»¬åªéœ€å¤„ç†å¯¼å…¥æˆ‘ä»¬çš„æ–°æ–‡ä»¶å’Œå‡½æ•°ï¼Œä»¥ä¾¿å®ƒä»¬å¯ä»¥åœ¨æˆ‘ä»¬çš„é¡¹ç›®ä¸­ä½¿ç”¨ã€‚

ä¸ºæ­¤ï¼š

1. åˆ›å»º **sandooo/src/lib.rs**ï¼š

pub mod common;

2. åˆ›å»º **sandooo/src/common/mod.rs**ï¼š

pub mod constants;  
pub mod utils;

é¡¹ç›®è®¾ç½®å·²å®Œæˆã€‚ç°åœ¨æˆ‘ä»¬å¯ä»¥è¿›å…¥ä¸‰æ˜æ²»æœºå™¨äººæ›´æœ‰è¶£çš„æ–¹é¢ã€‚

### Mempool æµ

ä¾‹å¦‚ï¼Œå‡è®¾æœ‰äººå°† Uniswap è®¢å•äº¤æ˜“å‘é€åˆ°å…¬å…±å†…å­˜æ± ã€‚ä»»ä½•ç›´æ¥å‘é€åˆ°åŒºå—é“¾çš„äº¤æ˜“é€šå¸¸ä¼šè¿›å…¥å…¬å…±å†…å­˜æ± ã€‚

ä»»ä½•äººéƒ½å¯ä»¥é€šè¿‡ä¸èŠ‚ç‚¹æä¾›è€…å»ºç«‹ websocket è¿æ¥æ¥è®¿é—®è¿™äº›æ•°æ®ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†åœ¨ **sandooo/src/common/streams.rs** ä¸­åˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶ï¼š

[sandooo/src/common/streams.rs ](https://github.com/solidquant/sandooo/blob/main/src/common/streams.rs?source=post_page-----a89235281da3--------------------------------)

 

```

use ethers::{  
    providers::{Middleware, Provider, Ws},  
    types::*,  
};  
use std::sync::Arc;  
use tokio::sync::broadcast::Sender;  
use tokio_stream::StreamExt;  
  
use crate::common::utils::calculate_next_block_base_fee;  
  
#[derive(Default, Debug, Clone)]  
pub struct NewBlock {  
    pub block_number: U64,  
    pub base_fee: U256,  
    pub next_base_fee: U256,  
}  
  
#[derive(Debug, Clone)]  
pub struct NewPendingTx {  
    pub added_block: Option<U64>,  
    pub tx: Transaction,  
}  
  
impl Default for NewPendingTx {  
    fn default() -> Self {  
        Self {  
            added_block: None,  
            tx: Transaction::default(),  
        }  
    }  
}  
  
#[derive(Debug, Clone)]  
pub enum Event {  
    Block(NewBlock),  
    PendingTx(NewPendingTx),  
}  
  
// å»ºç«‹ä¸€ä¸ª websocket è¿æ¥ä»¥è·å–æ–°åˆ›å»ºçš„åŒºå—  
pub async fn stream_new_blocks(provider: Arc<Provider<Ws>>, event_sender: Sender<Event>) {  
    let stream = provider.subscribe_blocks().await.unwrap();  
    let mut stream = stream.filter_map(|block| match block.number {  
        Some(number) => Some(NewBlock {  
            block_number: number,  
            base_fee: block.base_fee_per_gas.unwrap_or_default(),  
            next_base_fee: U256::from(calculate_next_block_base_fee(  
                block.gas_used,  
                block.gas_limit,  
                block.base_fee_per_gas.unwrap_or_default(),  
            )),  
        }),  
        None => None,  
    });  
  
    while let Some(block) = stream.next().await {  
        match event_sender.send(Event::Block(block)) {  
            Ok(_) => {}  
            Err(_) => {}  
        }  
    }  
}  
  
// å»ºç«‹ä¸€ä¸ª websocket è¿æ¥ä»¥è·å–æ–°çš„å¾…å¤„ç†äº¤æ˜“  
pub async fn stream_pending_transactions(provider: Arc<Provider<Ws>>, event_sender: Sender<Event>) {  
    let stream = provider.subscribe_pending_txs().await.unwrap();  
    let mut stream = stream.transactions_unordered(256).fuse();  
  
    while let Some(result) = stream.next().await {  
        match result {  
            Ok(tx) => match event_sender.send(Event::PendingTx(NewPendingTx {  
                added_block: None,  
                tx,  
            })) {  
                Ok(_) => {}  
                Err(_) => {}  
            },  
            Err(_) => {}  
        };  
    }  
}
```

å¹¶æ›´æ–° **sandooo/src/common/mod.rs**ï¼š
```
pub mod constants;  
pub mod streams;  
pub mod utils;
```

è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åœ¨ **streams.rs** ä¸­ä½¿ç”¨è¿™äº›å‡½æ•°ã€‚

ç°åœ¨æœ‰äº†è¿™ä¸¤ä¸ªå‡½æ•°ï¼Œæˆ‘ä»¬å°†èƒ½å¤Ÿå®æ—¶è·å–æ–°å—å’Œå¾…å¤„ç†äº¤æ˜“ã€‚ç„¶è€Œï¼Œæˆ‘ä»¬ä»ç„¶æ²¡æœ‰å®šä¹‰ä¸€ä¸ªäº‹ä»¶å¤„ç†ç¨‹åºæ¥å¤„ç† Block å’Œ PendingTx äº‹ä»¶ã€‚

ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†åœ¨ **src** ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªæ–°ç›®å½•ï¼Œæˆ‘ä»¬å°†å…¶å‘½åä¸ºï¼š**sandooo/src/sandwich**ã€‚åœ¨æ­¤ç›®å½•ä¸­åˆ›å»ºä¸¤ä¸ªæ–°æ–‡ä»¶ï¼š

*   **sandooo/src/sandwich/strategy.rs**ï¼š
```
use bounded_vec_deque::BoundedVecDeque;  
use ethers::signers::{LocalWallet, Signer};  
use ethers::{  
    providers::{Middleware, Provider, Ws},  
    types::{BlockNumber, H160, H256, U256, U64},  
};  
use log::{info, warn};  
use std::{collections::HashMap, str::FromStr, sync::Arc};  
use tokio::sync::broadcast::Sender;  
  
// æˆ‘ä»¬ç¨åä¼šæ›´æ–°è¿™éƒ¨åˆ†ï¼Œç›®å‰åªéœ€å¯¼å…¥å¿…è¦çš„ç»„ä»¶  
use crate::common::constants::{Env, WETH};  
use crate::common::streams::{Event, NewBlock};  
use crate::common::utils::{calculate_next_block_base_fee, to_h160};  
  
pub async fn run_sandwich_strategy(provider: Arc<Provider<Ws>>, event_sender: Sender<Event>) {  
    let mut event_receiver = event_sender.subscribe();  
  
    loop {  
        match event_receiver.recv().await {  
            Ok(event) => match event {  
                Event::Block(block) => {  
                    info!("{:?}", block);  
                }  
                Event::PendingTx(mut pending_tx) => {  
                    info!("{:?}", pending_tx);  
                }  
            },  
            _ => {}  
        }  
    }  
}
```
*   **sandooo/src/sandwich/mod.rs**ï¼š

pub mod strategy;

*   **sandooo/src/lib.rs**ï¼š

pub mod common;  
pub mod sandwich;

å¸Œæœ›ä½ ç°åœ¨æ˜ç™½ï¼Œæ¯æ¬¡æˆ‘ä»¬åœ¨ **src** ç›®å½•ä¸­æ·»åŠ ä¸€ä¸ªæ–°ç›®å½•æ—¶ï¼Œæˆ‘ä»¬éƒ½ä¼šåœ¨ **sandooo/src/lib.rs** ä¸­æ›´æ–°å®ƒï¼Œå¹¶ä¸”è¿™äº›ç›®å½•åº”è¯¥æœ‰ä¸€ä¸ª **mod.rs** æ–‡ä»¶ã€‚æ¯æ¬¡æˆ‘ä»¬åœ¨è¯¥ç›®å½•ä¸­æ·»åŠ æ–°æ–‡ä»¶æ—¶ï¼Œæˆ‘ä»¬éƒ½å¿…é¡»åœ¨ **mod.rs** æ–‡ä»¶ä¸­æ·»åŠ å®ƒã€‚ä»ç°åœ¨å¼€å§‹è¯·ä¸è¦å¿˜è®°è¿™æ ·åšï¼Œå› ä¸ºæˆ‘å°†ä¸å†æè¿°è¿™ä¸ªè¿‡ç¨‹ï¼Œå¹¶å‡è®¾å®ƒæ€»æ˜¯ä¼šå®Œæˆã€‚

å‰å¾€ **main.rs** å¹¶æ›´æ–°ä»£ç ï¼š
```
use anyhow::Result;  
use ethers::providers::{Provider, Ws};  
use log::info;  
use std::sync::Arc;  
use tokio::sync::broadcast::{self, Sender};  
use tokio::task::JoinSet;  
  
use sandooo::common::constants::Env;  
use sandooo::common::streams::{stream_new_blocks, stream_pending_transactions, Event};  
use sandooo::common::utils::setup_logger;  
use sandooo::sandwich::strategy::run_sandwich_strategy;  
  
#[tokio::main]  
async fn main() -> Result<()> {  
    dotenv::dotenv().ok();  
    setup_logger().unwrap();  
  
    info!("Starting Sandooo");  
  
    let env = Env::new();  
  
    let ws = Ws::connect(env.wss_url.clone()).await.unwrap();  
    let provider = Arc::new(Provider::new(ws));  
  
    let (event_sender, _): (Sender<Event>, _) = broadcast::channel(512);  
  
    let mut set = JoinSet::new();  
  
    set.spawn(stream_new_blocks(provider.clone(), event_sender.clone()));  
    set.spawn(stream_pending_transactions(  
        provider.clone(),  
        event_sender.clone(),  
    ));  
```

```rust
set.spawn(run_sandwich_strategy(  
    provider.clone(),  
    event_sender.clone(),  
));  
  
while let Some(res) = set.join_next().await {  
    info!("{:?}", res);  
}  
  
Ok(())  
}
```

ä¸»å‡½æ•°æ˜¯æˆ‘ä»¬æ•´ä¸ªç³»ç»Ÿçš„å…¥å£ç‚¹ï¼Œå®ƒå°†ä½¿ç”¨ Tokio çš„ JoinSet è¿è¡Œä¸‰ä¸ªå¼‚æ­¥å‡½æ•°ã€‚

é€šè¿‡ä»¥ä¸‹å‘½ä»¤è¿è¡Œå½“å‰çš„ Rust ç¨‹åºï¼š

cargo run

å°†ä¼šåœ¨ä½ çš„ç»ˆç«¯ä¸Šæ˜¾ç¤ºå¤§é‡å¾…å¤„ç†çš„äº¤æ˜“ï¼š

![](https://img.learnblockchain.cn/attachments/migrate/1731979870411)

å¥½å§ï¼Œè¿™å¤ªå¤šäº†ï¼Œå…‰çœ‹ç€å°±è®©æˆ‘çœ¼ç›ç–¼ã€‚æŠ±æ­‰è®©ä½ çœ‹åˆ°è¿™ä¸ªã€‚ä½†è‡³å°‘æˆ‘ä»¬çŸ¥é“ä»£ç ç°åœ¨æ˜¯æœ‰æ•ˆçš„ã€‚æ‰€ä»¥æˆ‘ä»¬åªéœ€è¦ä¸€ç§æ–¹æ³•æ¥å¼„æ¸…æ¥š **è¿™äº›å¾…å¤„ç†äº¤æ˜“ä¸­å“ªäº›å€¼å¾—å…³æ³¨** å’Œ **å®ƒä»¬æ˜¯å¦å¯ä»¥è¿›è¡Œå¤¹å‡»**ã€‚æˆ‘ä»¬å°†å°è¯•é€ä¸€è§£å†³ã€‚

## ğŸ” å“ªäº›å¾…å¤„ç†äº¤æ˜“å€¼å¾—å…³æ³¨ï¼Ÿ

æˆ‘ä»¬èƒ½æƒ³åˆ°çš„ç¬¬ä¸€ä¸ªç­”æ¡ˆå¯èƒ½æ˜¯è§£ç è¿™äº›å¾…å¤„ç†äº¤æ˜“ä¸­çš„è¾“å…¥æ•°æ®ã€‚å¦‚æœå®ƒä»¬æ˜¯å¯¹ Uniswap æ± æˆ– Uniswap è·¯ç”±å™¨çš„ç›´æ¥è°ƒç”¨ï¼Œæˆ‘ä»¬åº”è¯¥èƒ½å¤Ÿä»…é€šè¿‡è¿™äº›æ•°æ®å¼„æ¸…æ¥šäº¤æ˜“æ„å›¾ä¹°å…¥æˆ–å–å‡ºå“ªä¸ªä»£å¸ï¼Œä»¥åŠæ•°é‡ã€‚

ç„¶è€Œï¼Œè¿™ç§æ–¹æ³•å¹¶ä¸æ˜¯å¾ˆå¯æ‰©å±•ã€‚æ˜¯çš„ï¼Œæˆ‘ä»¬å¯ä»¥æ•è·å¦‚ä¸‹äº¤æ˜“ï¼š

![](https://img.learnblockchain.cn/attachments/migrate/1731979870427)

è¿™äº›æ˜¯ç›´æ¥ä¸ Uniswap é€šç”¨è·¯ç”±å™¨äº¤äº’çš„äº¤æ˜“ã€‚

ä½†æ˜¯ï¼Œæˆ‘ä»¬æ— æ³•æ•è·é‚£äº›å¤æ‚å¾—å¤šä½†å¯èƒ½å¯ä»¥å¤¹å‡»çš„äº¤æ˜“ã€‚è¿™äº›å¯èƒ½æ˜¯æ¥è‡ªèšåˆå™¨å¦‚ 1inch å’Œ 0x çš„äº¤æ˜“ï¼Œæˆ–è€…æ˜¯æ™ºèƒ½åˆçº¦åœ¨ Uniswap ä¸­å¤–éƒ¨è°ƒç”¨çš„äº¤æ¢ã€‚

æ­¤å¤–ï¼Œå¦‚æœä½ æƒ³æ·»åŠ æ›´å¤šçš„ DEXï¼Œä½ éœ€è¦æ‰¾åˆ°ä¸€ç§æ–¹æ³•ï¼Œé€šè¿‡é˜…è¯»å®ƒä»¬çš„å‡½æ•°è§„èŒƒæ¥è§£ç æ‰€æœ‰äº¤æ˜“ã€‚

**è¿™å°±æ˜¯æˆ‘ä»¬éœ€è¦ä¸€ç§æ›´å¯æ‰©å±•çš„æ–¹æ³•çš„åŸå› ã€‚**

â“ ä½ çŸ¥é“åœ¨äº¤æ˜“åœ¨ä¸‹ä¸€ä¸ªåŒºå—ç¡®è®¤ä¹‹å‰ï¼Œæœ‰å¯èƒ½å¼„æ¸…æ¥šå®ƒå°†å¯¹åŒºå—é“¾çŠ¶æ€åšä»€ä¹ˆå—ï¼Ÿ

**æˆ‘ä»¬å¯ä»¥é€šè¿‡è¿½è¸ªäº¤æ˜“è°ƒç”¨æ¥å®ç°è¿™ä¸€ç‚¹ã€‚** è¿½è¸ªè°ƒç”¨å°†å°è¯•åœ¨è°ƒç”¨è€…æŒ‡å®šçš„åŒºå—çŠ¶æ€ä¸Šè¿è¡Œäº¤æ˜“ï¼Œå¹¶è¿”å›è¯¸å¦‚ï¼šä½¿ç”¨çš„ gasã€è°ƒç”¨æ ˆã€è¿”å›çš„æ—¥å¿—ç­‰å€¼ã€‚

æˆ‘ä»¬å°†å°è¯•ä½¿ç”¨ **eth_traceCall** æ–¹æ³•åœ¨ Geth ä¸Šå¼„æ¸…æ¥šå¾…å¤„ç†äº¤æ˜“æ¶‰åŠå“ªäº› Uniswap V2 æ± â€”â€”é€šè¿‡ _â€œæ¶‰åŠâ€_ æˆ‘ä»¬çš„æ„æ€æ˜¯å“ªäº›æ± çš„çŠ¶æ€å› è°ƒç”¨è€Œæ”¹å˜ã€‚

[ debug_traceCall | ä»¥å¤ªåŠ](https://docs.chainstack.com/reference/ethereum-tracecall?source=post_page-----a89235281da3--------------------------------)

ä»¥å¤ªåŠ API æ–¹æ³•ï¼Œåœ¨ç‰¹å®šåŒºå—æ‰§è¡Œçš„ä¸Šä¸‹æ–‡ä¸­è¿½è¸ª eth_call çš„æ‰§è¡Œã€‚

 



è®©æˆ‘ä»¬åœ¨ **sandwich** ç›®å½•ä¸­åˆ›å»ºå¦ä¸€ä¸ªæ–‡ä»¶ï¼š**sandooo/src/sandwich/simulation.rs**ï¼š

use anyhow::Result;  
use eth_encode_packed::ethabi::ethereum_types::{H160 as eH160, U256 as eU256};  
use eth_encode_packed::{SolidityDataType, TakeLastXBytes};  
use ethers::abi::ParamType;  
use ethers::prelude::*;  
use ethers::providers::{Provider, Ws};  
use ethers::types::{transaction::eip2930::AccessList, Bytes, H160, H256, I256, U256, U64};  
use log::info;  
use revm::primitives::{Bytecode, U256 as rU256};  
use std::{collections::HashMap, default::Default, str::FromStr, sync::Arc};  
  
use crate::common::constants::{WETH, WETH_BALANCE_SLOT};  
use crate::common::streams::{NewBlock, NewPendingTx};  
use crate::common::utils::{create_new_wallet, is_weth, to_h160};  
  
#[derive(Debug, Clone, Default)]  
pub struct PendingTxInfo {  
    pub pending_tx: NewPendingTx,  
    pub touched_pairs: Vec<SwapInfo>,  
}  
  
#[derive(Debug, Clone)]  
pub enum SwapDirection {  
    Buy,  
    Sell,  
}  
  
#[derive(Debug, Clone)]  
pub struct SwapInfo {  
    pub tx_hash: H256,  
    pub target_pair: H160,  
    pub main_currency: H160,  
    pub target_token: H160,  
    pub version: u8,  
    pub token0_is_main: bool,  
    pub direction: SwapDirection,  
}  
  
pub static V2_SWAP_EVENT_ID: &str = "0xd78ad95f";  
  
pub async fn debug_trace_call(  
    provider: &Arc<Provider<Ws>>,  
    new_block: &NewBlock,  
    pending_tx: &NewPendingTx,  
) -> Result<Option<CallFrame>> {  
    let mut opts = GethDebugTracingCallOptions::default();  
    let mut call_config = CallConfig::default();  
    call_config.with_log = Some(true); // ğŸ‘ˆ ç¡®ä¿æˆ‘ä»¬è·å–æ—¥å¿—  
  
    opts.tracing_options.tracer = Some(GethDebugTracerType::BuiltInTracer(  
        GethDebugBuiltInTracerType::CallTracer,  
    ));  
    opts.tracing_options.tracer_config = Some(GethDebugTracerConfig::BuiltInTracer(  
        GethDebugBuiltInTracerConfig::CallTracer(call_config),  
    ));  
  
    let block_number = new_block.block_number;  
    let mut tx = pending_tx.tx.clone();  
    let nonce = provider  
        .get_transaction_count(tx.from, Some(block_number.into()))  
        .await  
        .unwrap_or_default();  
    tx.nonce = nonce;  
  
    let trace = provider  
        .debug_trace_call(&tx, Some(block_number.into()), opts)  
        .await;  
  
    match trace {  
        Ok(trace) => match trace {  
            GethTrace::Known(call_tracer) => match call_tracer {  
                GethTraceFrame::CallTracer(frame) => Ok(Some(frame)),  
                _ => Ok(None),  
            },  
            _ => Ok(None),  
        },  
        _ => Ok(None),  
    }  

**debug_trace_call** å‡½æ•°å°†è¿”å›åœ¨è¿½è¸ªå¾…å¤„ç†äº¤æ˜“åè¿”å›çš„è°ƒç”¨å¸§ã€‚æˆ‘ä»¬å¯ä»¥åœ¨ç¨å¾®è°ƒæ•´ç­–ç•¥å‡½æ•°åå°è¯•è¿è¡Œè¿™ä¸ª **(sandooo/src/sandwich/strategy.rs)**ï¼š

// ... å¯¼å…¥  
  
pub async fn run_sandwich_strategy(provider: Arc<Provider<Ws>>, event_sender: Sender<Event>) {  
    let block = provider  
        .get_block(BlockNumber::Latest)  
        .await  
        .unwrap()  
        .unwrap();  
    let mut new_block = NewBlock {  
        block_number: block.number.unwrap(),  
        base_fee: block.base_fee_per_gas.unwrap(),  
        next_base_fee: calculate_next_block_base_fee(  
            block.gas_used,  
            block.gas_limit,  
            block.base_fee_per_gas.unwrap(),  
        ),  
    };  
  
    let mut event_receiver = event_sender.subscribe();  
  
    loop {  
        match event_receiver.recv().await {  
            Ok(event) => match event {  
                Event::Block(block) => {  
                    new_block = block;  
                    info!("[Block #{:?}]", new_block.block_number);  
                }  
                Event::PendingTx(mut pending_tx) => {  
                    let frame = debug_trace_call(&provider, &new_block, &pending_tx).await;  
                    match frame {  
                        Ok(frame) => info!("{:?}", frame),  
                        Err(e) => info!("{e:?}"),  
                    }  
                }  
            },  
            _ => {}  
        }  
    }  
}

è¿è¡Œï¼š

cargo run

å°†ä¼šç»™ä½ ä¸€ä¸ªè°ƒç”¨å¸§ï¼Œçœ‹èµ·æ¥åƒè¿™æ ·ï¼š

![](https://img.learnblockchain.cn/attachments/migrate/1731979870426)

æˆ‘ä»¬æ„Ÿå…´è¶£çš„éƒ¨åˆ†æ˜¯æ—¥å¿—ã€‚ç„¶è€Œï¼Œä½œä¸ºè¿½è¸ªç»“æœè¿”å›çš„è°ƒç”¨æ ˆæ˜¯é€’å½’çš„ï¼Œå› æ­¤ä¸€ä¸ªè°ƒç”¨å¸§å¯ä»¥æœ‰å¤šä¸ªå…¶ä»–è°ƒç”¨ï¼Œè¿™æ˜¯ä¸€ç³»åˆ—å…¶ä»–è°ƒç”¨å¸§ã€‚æ¯ä¸ªè°ƒç”¨å¸§å¯ä»¥åŒ…å«æ—¥å¿—ã€‚
```

ä¸ºäº†é€’å½’åœ°ä»è°ƒç”¨å¸§ä¸­æå–æ—¥å¿—ï¼Œæˆ‘ä»¬ä½¿ç”¨å¦ä¸€ä¸ªè¾…åŠ©å‡½æ•°ï¼Œè¯¥å‡½æ•°å°†åœ¨ **sandooo/src/sandwich/simulation.rs** ä¸­å®šä¹‰ï¼š

```rust
pub fn extract_logs(call_frame: &CallFrame, logs: &mut Vec<CallLogFrame>) {  
    if let Some(ref logs_vec) = call_frame.logs {  
        logs.extend(logs_vec.iter().cloned());  
    }  
  
    if let Some(ref calls_vec) = call_frame.calls {  
        for call in calls_vec {  
            extract_logs(call, logs);  
        }  
    }  
}
```

é€šè¿‡è¿™ä¸ªæ–°å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾åœ°å°†æ—¥å¿—æ‰å¹³åŒ–ä¸ºä¸€ä¸ªå•ä¸€çš„å‘é‡ã€‚ä½ å¯ä»¥å°è¯•å†æ¬¡æ›´æ–° **strategy.rs** å‡½æ•°ï¼š

```rust
loop {  
    match event_receiver.recv().await {  
        Ok(event) => match event {  
            Event::Block(block) => {  
                new_block = block;  
                info!("[Block #{:?}]", new_block.block_number);  
            }  
            // åªéœ€æ›´æ–°è¿™ä¸€éƒ¨åˆ† ğŸ‘‡  
            Event::PendingTx(mut pending_tx) => {  
                let frame = debug_trace_call(&provider, &new_block, &pending_tx).await;  
                match frame {  
                    Ok(frame) => match frame {  
                        Some(frame) => {  
                            let mut logs = Vec::new();  
                            extract_logs(&frame, &mut logs);  
                            info!("{:?}", logs);  
                        }  
                        _ => {}  
                    },  
                    Err(e) => info!("{e:?}"),  
                }  
            }  
        },  
        _ => {}  
    }  
}
```

å°è¯•è¿è¡Œè¿™ä¸ªï¼Œä½ ç°åœ¨ä¼šçœ‹åˆ°æ‰€æœ‰çš„æ—¥å¿—éƒ½è¢«æ‰å¹³åŒ–ä¸ºä¸€ä¸ªå•ä¸€çš„å‘é‡ï¼š

![](https://img.learnblockchain.cn/attachments/migrate/1731979870422)

å½“ç„¶ï¼Œä¸€äº›è¿½è¸ªå°†æ²¡æœ‰æ—¥å¿—ã€‚

ä¸‹ä¸€æ­¥æ˜¯è¿‡æ»¤è¿™äº›æ—¥å¿—ï¼Œå¹¶æ‰¾å‡ºå“ªäº›å¾…å¤„ç†äº¤æ˜“æ­£åœ¨å°è¯•åœ¨ Uniswap V2 DEX ä¸Šè¿›è¡Œäº¤æ¢ã€‚_ï¼ˆæˆ‘ä»¬ç°åœ¨å°†é‡ç‚¹æ”¾åœ¨ Uniswap V2 ä¸Šï¼Œå¹¶åœ¨æœ¬ç³»åˆ—çš„æœ€åéƒ¨åˆ†æ·»åŠ  V3ã€‚ï¼‰_

æˆ‘ä»¬å¯ä»¥é€šè¿‡è¿‡æ»¤å‡ºå¦‚ä¸‹çš„ Swap æ—¥å¿—æ¥å®ç°ï¼š

![](https://img.learnblockchain.cn/attachments/migrate/1731979871300)

é€šè¿‡è®¿é—® Etherscanï¼Œä½ å¯ä»¥çŸ¥é“ Swap äº‹ä»¶çš„ 4 å­—èŠ‚é€‰æ‹©å™¨æ˜¯ **0xd78ad95f**ï¼Œå¯ä»¥ä» topic0 ä¸­çœ‹åˆ°ï¼š

![](https://img.learnblockchain.cn/attachments/migrate/1731979871994)

[

## Uniswap V2: USDT | åœ°å€ 0x0d4a11d5eeaac28ec3f61d100daf4d40471f1852 | Etherscan

### åˆçº¦åœ°å€ 0x0d4a11d5eeaac28ec3f61d100daf4d40471f1852 é¡µé¢å…è®¸ç”¨æˆ·æŸ¥çœ‹æºä»£ç â€¦

etherscan.io

](https://etherscan.io/address/0x0d4a11d5eeaac28ec3f61d100daf4d40471f1852?source=post_page-----a89235281da3--------------------------------#events)

å› æ­¤ï¼Œæˆ‘ä»¬å°†åœ¨ **sandooo/src/sandwich/simulation.rs** ä¸­æ·»åŠ å¦ä¸€ä¸ªå‡½æ•°ï¼š

```rust
pub async fn extract_swap_info(  
    provider: &Arc<Provider<Ws>>,  
    new_block: &NewBlock,  
    pending_tx: &NewPendingTx,  
    pools_map: &HashMap<H160, Pool>,  
) -> Result<Vec<SwapInfo>> {  
    let tx_hash = pending_tx.tx.hash;  
    let mut swap_info_vec = Vec::new();  
  
    let frame = debug_trace_call(provider, new_block, pending_tx).await?;  
    if frame.is_none() {  
        return Ok(swap_info_vec);  
    }  
    let frame = frame.unwrap();  
  
    let mut logs = Vec::new();  
    extract_logs(&frame, &mut logs);  
  
    for log in &logs {  
        match &log.topics {  
            Some(topics) => {  
                if topics.len() > 1 {  
                    let selector = &format!("{:?}", topics[0])[0..10];  
                    let is_v2_swap = selector == V2_SWAP_EVENT_ID;  
                    if is_v2_swap {  
                        let pair_address = log.address.unwrap();  
  
                        // ä»…è¿‡æ»¤æˆ‘ä»¬åœ¨å†…å­˜ä¸­ä¿ç•™çš„æ±   
                        let pool = pools_map.get(&pair_address);  
                        if pool.is_none() {  
                            continue;  
                        }  
                        let pool = pool.unwrap();  
  
                        let token0 = pool.token0;  
                        let token1 = pool.token1;  
  
                        let token0_is_weth = is_weth(token0);  
                        let token1_is_weth = is_weth(token1);  
  
                        // ä»…è¿‡æ»¤ WETH äº¤æ˜“å¯¹  
                        if !token0_is_weth && !token1_is_weth {  
                            continue;  
                        }  
  
                        let (main_currency, target_token, token0_is_main) = if token0_is_weth {  
                            (token0, token1, true)  
                        } else {  
                            (token1, token0, false)  
                        };  
  
                        let (in0, _, _, out1) = match ethers::abi::decode(  
                            &[  
                                ParamType::Uint(256),  
                                ParamType::Uint(256),  
                                ParamType::Uint(256),  
                                ParamType::Uint(256),  
                            ],  
                            log.data.as_ref().unwrap(),  
                        ) {  
                            Ok(input) => {  
                                let uints: Vec<U256> = input  
                                    .into_iter()  
                                    .map(|i| i.to_owned().into_uint().unwrap())  
                                    .collect();  
                                (uints[0], uints[1], uints[2], uints[3])  
                            }  
                            _ => {  
                                let zero = U256::zero();  
                                (zero, zero, zero, zero)  
                            }  
                        };  
  
                        let zero_for_one = (in0 > U256::zero()) && (out1 > U256::zero());  
  
                        let direction = if token0_is_main {  
                            if zero_for_one {  
                                SwapDirection::Buy  
                            } else {  
                                SwapDirection::Sell  
                            }  
                        } else {  
                            if zero_for_one {  
                                SwapDirection::Sell  
                            } else {  
                                SwapDirection::Buy  
                            }  
                        };  
  
                        let swap_info = SwapInfo {  
                            tx_hash,  
                            target_pair: pair_address,  
                            main_currency,  
                            target_token,  
                            version: 2,  
                            token0_is_main,  
                            direction,  
                        };  
                        swap_info_vec.push(swap_info);  
                    }  
                }  
            }  
            _ => {}  
        }  
    }  
  
    Ok(swap_info_vec)  
}
```

æˆ‘ä»¬åœ¨ä¸¤ä¸ªæ­¥éª¤ä¸­è¿‡æ»¤æ—¥å¿—ï¼š

1. é¦–å…ˆï¼Œä»…è¿‡æ»¤æˆ‘ä»¬åœ¨ **pools_map** ä¸­ä¿ç•™çš„æ± ã€‚æˆ‘ä»¬è¿˜æ²¡æœ‰æ·»åŠ è¿™ä¸€éƒ¨åˆ†ï¼Œä½†æˆ‘ä»¬å°†åœ¨ä¸‹ä¸€èŠ‚ä¸­æ·»åŠ ã€‚
2. å…¶æ¬¡ï¼Œä»…è¿‡æ»¤ WETH äº¤æ˜“å¯¹æ± ã€‚

ä¸€æ—¦æˆ‘ä»¬å®Œæˆäº†è¿™ä¸ªï¼Œæˆ‘ä»¬é€šè¿‡ä»¥ä¸‹æ–¹å¼è§£ç æ—¥å¿—æ•°æ®ï¼š

```rust
ethers::abi::decode(  
    &\[  
        ParamType::Uint(256),  
        ParamType::Uint(256),  
        ParamType::Uint(256),  
        ParamType::Uint(256),  
    \],  
    log.data.as_ref().unwrap(),  
)
```

å¹¶æå–å‡º **amount0In, amount1In, amount0Out, amount1Out** å€¼ã€‚

æˆ‘ä»¬è¿˜å¯ä»¥åˆ©ç”¨è¿™äº›æ•°æ®ç¡®å®šäº¤æ˜“æ˜¯ç”¨äºè´­ä¹°è¿˜æ˜¯å‡ºå”®ç›®æ ‡ä»£å¸ã€‚æˆ‘ä»¬å°† **ç›®æ ‡ä»£å¸** å®šä¹‰ä¸ºä¸ WETH ä»£å¸ï¼ˆ**ä¸»è´§å¸**ï¼‰é…å¯¹çš„ä»£å¸ã€‚

ç°åœ¨è®©æˆ‘ä»¬æ·»åŠ ä¸€ç§æ–¹æ³•ï¼Œåœ¨ç¨‹åºå¯åŠ¨æ—¶æ›´æ–° Uniswap V2 æ± åŠå…¶ç›¸å…³çš„ ERC-20 ä»£å¸ï¼Œä»¥ä¾¿è¿½è¸ª + æ—¥å¿—æå–èƒ½å¤Ÿæ­£å¸¸å·¥ä½œã€‚

åœ¨ **sandooo/src/common** ä¸­æ·»åŠ ä¸¤ä¸ªæ–°æ–‡ä»¶ï¼š

1.  **pools.rs**

[

## sandooo/src/common/pools.rs at main Â· solidquant/sandooo

### A sandwich bot. Contribute to solidquant/sandooo development by creating an account on GitHub.

github.com

](https://github.com/solidquant/sandooo/blob/main/src/common/pools.rs?source=post_page-----a89235281da3--------------------------------)

**2\. tokens.rs**

[

## sandooo/src/common/tokens.rs at main Â· solidquant/sandooo

### A sandwich bot. Contribute to solidquant/sandooo development by creating an account on GitHub.

github.com

](https://github.com/solidquant/sandooo/blob/main/src/common/tokens.rs?source=post_page-----a89235281da3--------------------------------)

**3\. bytecode.rs**

[

## sandooo/src/common/bytecode.rs at main Â· solidquant/sandooo

### A sandwich bot. Contribute to solidquant/sandooo development by creating an account on GitHub.

github.com

](https://github.com/solidquant/sandooo/blob/main/src/common/bytecode.rs?source=post_page-----a89235281da3--------------------------------)

å®Œæˆåï¼Œè®©æˆ‘ä»¬å†æ¬¡æ›´æ–° **sandooo/src/sandwich/strategy.rs** æ–‡ä»¶ï¼š

```rust
pub async fn run_sandwich_strategy(provider: Arc<Provider<Ws>>, event_sender: Sender<Event>) {  
    let env = Env::new();  
  
    // load_all_pools:  
    // this will load all Uniswap V2 pools that was deployed after the block #10000000  
    let (pools, prev_pool_id) = load_all_pools(env.wss_url.clone(), 10000000, 50000)  
        .await  
        .unwrap();  
  
    // load_all_tokens:  
    // this will get all the token information including: name, symbol, symbol, totalSupply  
    let block_number = provider.get_block_number().await.unwrap();  
    let tokens_map = load_all_tokens(&provider, block_number, &pools, prev_pool_id)  
        .await  
        .unwrap();  
    info!("Tokens map count: {:?}", tokens_map.len());  
  
    // filter pools that don't have both token0 / token1 info  
    let pools_vec: Vec<Pool> = pools  
        .into_iter()  
        .filter(|p| {  
            let token0_exists = tokens_map.contains_key(&p.token0);  
            let token1_exists = tokens_map.contains_key(&p.token1);  
            token0_exists && token1_exists  
        })  
        .collect();  
    info!("Filtered pools by tokens count: {:?}", pools_vec.len());  
  
    let pools_map: HashMap<H160, Pool> = pools_vec  
        .clone()  
        .into_iter()  
        .map(|p| (p.address, p))  
        .collect();  
  
    let block = provider  
        .get_block(BlockNumber::Latest)  
        .await  
        .unwrap()  
        .unwrap();  
    let mut new_block = NewBlock {  
        block_number: block.number.unwrap(),  
        base_fee: block.base_fee_per_gas.unwrap(),  
        next_base_fee: calculate_next_block_base_fee(  
            block.gas_used,  
            block.gas_limit,  
            block.base_fee_per_gas.unwrap(),  
        ),  
    };  
  
    let mut event_receiver = event_sender.subscribe();  
  
    loop {  
        match event_receiver.recv().await {  
            Ok(event) => match event {  
                Event::Block(block) => {  
                    new_block = block;  
                    info!("\[Block #{:?}\]", new_block.block_number);  
                }  
                Event::PendingTx(mut pending_tx) => {  
                    let swap_info =  
                        extract_swap_info(&provider, &new_block, &pending_tx, &pools_map).await;  
                    info!("{:?}", swap_info);  
                }  
            },  
            _ => {}  
        }  
    }  
}
```

ğŸ‘ğŸ‘ğŸ‘ ç°åœ¨ä»æ ¹ç›®å½•åˆ›å»ºä¸€ä¸ªæ–°ç›®å½•ï¼š**sandooo/cache.** è¿™ä¸€éƒ¨åˆ†å¾ˆé‡è¦ï¼Œå› ä¸º **pools.rs** å’Œ **tokens.rs** å°†åˆ›å»ºä¸€ä¸ªæ‰€æœ‰ç°æœ‰ Uniswap V2 æ± å’Œä»£å¸çš„æ–‡ä»¶ç¼“å­˜ï¼Œä»¥ä¾¿åœ¨æˆ‘ä»¬é‡å¯ç³»ç»Ÿæ—¶å¿«é€ŸåŠ è½½ã€‚

å½“ä½ åœ¨åˆ›å»º **cache** ç›®å½•åå¯åŠ¨ç³»ç»Ÿæ—¶ï¼Œä½ ä¼šçœ‹åˆ°ç¨‹åºå¼€å§‹ä½¿ç”¨ RPC èŠ‚ç‚¹ç«¯ç‚¹åŠ è½½æ± ï¼š

![](https://img.learnblockchain.cn/attachments/migrate/1731979872168)

åœ¨è®©ç¨‹åºè¿è¡Œä¸€æ®µæ—¶é—´åï¼ˆæˆ‘ä½¿ç”¨å…¨èŠ‚ç‚¹å¤§çº¦èŠ±äº† 30 åˆ†é’Ÿï¼‰ï¼Œå®ƒå°†å¼€å§‹æ‰“å°æˆ‘ä»¬ä» geth è·Ÿè¸ªä¸­æå–çš„äº¤æ¢ä¿¡æ¯ã€‚

![](https://img.learnblockchain.cn/attachments/migrate/1731979872252)

å¦‚ä½ æ‰€è§ï¼Œæˆ‘ä»¬å¾—åˆ°äº† **target_pair, main_currency, target_token, å’Œæ­£ç¡®çš„äº¤æ¢æ–¹å‘** çš„å¾…å¤„ç†äº¤æ˜“ã€‚

æˆ‘ä»¬ç»ˆäºå‡†å¤‡å¥½è¿›å…¥åˆ†æä¸­æ›´æœ‰è¶£çš„éƒ¨åˆ†ï¼š*ç†è§£ä¸‰æ˜æ²»æ†ç»‘çš„åˆ©æ¶¦å’Œæˆæœ¬ç»“æ„ã€‚*

## ğŸ¥ª è¿™äº›äº¤æ˜“ä¸­å“ªä¸€ä¸ªæ˜¯å¯ä»¥è¿›è¡Œä¸‰æ˜æ²»äº¤æ˜“çš„ï¼Ÿ

è¦å›ç­”è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¿…é¡»ç†è§£ä¸‰æ˜æ²»æ†ç»‘çš„åˆ©æ¶¦å’Œæˆæœ¬åˆ†ææ˜¯å¦‚ä½•è¿›è¡Œçš„ã€‚

æˆ‘ä»¬å°†è€ƒè™‘æœ€åŸºæœ¬çš„ä¸‰æ˜æ²»æ†ç»‘ç±»å‹ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

*   **å‰ç½®äº¤æ˜“ï¼š** WETH â†’ ç›®æ ‡ä»£å¸ **ï¼ˆè´­ä¹°ï¼‰**
*   **å—å®³è€…äº¤æ˜“ï¼š** WETH â†’ ç›®æ ‡ä»£å¸ **ï¼ˆè´­ä¹°ï¼‰**
*   **åç½®äº¤æ˜“ï¼š** ç›®æ ‡ä»£å¸ â†’ WETH **ï¼ˆå‡ºå”®ï¼‰**

![](https://img.learnblockchain.cn/attachments/migrate/1731979872560)

ç†è§£ä¸‰æ˜æ²»ç­–ç•¥çš„ç®€å•å½¢å¼å¯¹äºæ·±å…¥äº†è§£æ›´å¤æ‚çš„å˜ä½“è‡³å…³é‡è¦ã€‚æˆ‘ä»¬æœ€ç»ˆä¼šåœ¨å°† V3 é›†æˆåˆ°æˆ‘ä»¬çš„æœºå™¨äººæ—¶å¤„ç†è¿™äº›é«˜çº§ç­–ç•¥ã€‚ä½†ç°åœ¨ï¼Œè®©æˆ‘ä»¬æŒæ¡åŸºç¡€çŸ¥è¯†ã€‚

ä¸‰æ˜æ²»çš„æ¦‚å¿µéå¸¸ç®€å•ï¼š**ä½ åœ¨æŸäººä¹‹å‰è´­ä¹°ï¼Œå¹¶åœ¨é‚£ä¸ªäººä¹‹åç«‹å³å‡ºå”®ï¼Œä»¥ç¡®ä¿è·å¾—åˆ©æ¶¦ã€‚** å¦‚æœæ›´å¤šäººè´­ä¹°æŸä¸ªä»£å¸ï¼Œä»·æ ¼å°±ä¼šä¸Šæ¶¨ï¼Œè¿™å°±æ˜¯ä¸‰æ˜æ²»ç­–ç•¥çš„åˆ©æ¶¦éƒ¨åˆ†å¦‚ä½•è¿ä½œã€‚

ç”±äºæˆ‘ä»¬ç°åœ¨èƒ½å¤Ÿç›‘æ§æ¥è‡ª Uniswap V2 æ± çš„æ‰€æœ‰ä¹°å…¥å’Œå–å‡ºäº¤æ˜“ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å°è¯•å°†å®ƒä»¬åˆ†ç»„ä¸ºå‰ç½®ã€å—å®³è€…å’Œåç½®äº¤æ˜“çš„æ†ç»‘ï¼Œå¹¶æ‰¾å‡ºä»¥ä¸‹å†…å®¹ï¼š

1.  **åœ¨å—å®³è€…ä¹‹å‰æˆ‘ä»¬å¯ä»¥è´­ä¹°çš„æœ€å¤§ä»£å¸æ•°é‡ï¼Œ** ç¡®ä¿å—å®³è€…çš„äº¤æ˜“ä¸ä¼šå›æ»šï¼ˆäº¤æ˜“å¯èƒ½ç”±äºç”¨æˆ·åœ¨ä½¿ç”¨ Uniswap V2 è·¯ç”±åˆçº¦æ—¶è®¾ç½®çš„æ»‘ç‚¹å®¹å¿åº¦è€Œå›æ»šï¼‰
2.  **å¦‚æœæ‰€æœ‰ä¸‰ç¬”äº¤æ˜“éƒ½é¡ºåˆ©è¿›è¡Œè€Œä¸å›æ»šï¼Œæˆ‘ä»¬å¯ä»¥é¢„æœŸè·å¾—çš„æœ€å¤§åˆ©æ¶¦**

é€šè¿‡æˆ‘ä»¬çš„æ¨¡æ‹Ÿå¼•æ“ã€‚

ä¸å…¶ç†è®ºåŒ–è®¡ç®—å¦‚ä½•è¿ä½œï¼Œä¸å¦‚å®æ—¶æ„å»ºä¸€äº›æ†ç»‘å¹¶æ¨¡æ‹Ÿå®ƒä»¬ï¼Œä»¥æŸ¥çœ‹æˆ‘ä»¬æ˜¯å¦çœŸçš„èƒ½è·åˆ©ã€‚è®©æˆ‘ä»¬ç«‹å³å¼€å§‹ã€‚

# ä½¿ç”¨ Solidity/Yul çš„ä¸‰æ˜æ²»æ™ºèƒ½åˆçº¦

é“¾ä¸Šäº¤æ˜“ä¸åœ¨å¸å®‰ã€Bybit ç­‰ä¸­å¿ƒåŒ–äº¤æ˜“æ‰€çš„é“¾ä¸‹äº¤æ˜“æœ‰æ‰€ä¸åŒã€‚æˆ‘ä¸ä¼šå¯¹å“ªç§æ›´å…·æŒ‘æˆ˜æ€§å‘è¡¨æ„è§ï¼Œå› ä¸ºè¿™æ˜¯ä¸€ä¸ªä¸»è§‚é—®é¢˜ã€‚æœ‰äº›äººè®¤ä¸ºåœ¨ä¸­å¿ƒåŒ–äº¤æ˜“æ‰€æ„å»ºç­–ç•¥æ›´å›°éš¾ï¼Œå› ä¸ºä»·æ ¼æ³¢åŠ¨è¿…é€Ÿï¼Œè€Œå¦ä¸€äº›äººåˆ™è®¤ä¸ºé“¾ä¸Šäº¤æ˜“æ›´å¤æ‚ï¼Œå› ä¸ºè¾ƒé•¿çš„åŒºå—æ„å»ºæ—¶é—´å¸¦æ¥äº†æ–°çš„æŒ‘æˆ˜ã€‚è¿™ä¸¤ç§è§‚ç‚¹éƒ½æœ‰å…¶åˆç†æ€§ï¼Œåœ¨ä»»ä½•å¹³å°ä¸Šå®ç°ç›ˆåˆ©éƒ½ä¸æ˜¯ä¸€ä»¶å®¹æ˜“çš„äº‹ã€‚

ç„¶è€Œï¼Œæœ‰ä¸€ç‚¹æ˜¯ç¡®å®šçš„ï¼š**MEV çš„æ‰§è¡Œæ–¹é¢æ¯” CEX äº¤æ˜“å¤æ‚å¾—å¤š**ã€‚

å¦‚æœä½ æƒ³åœ¨ MEV ä¸­è·åˆ©ï¼Œäº†è§£å¦‚ä½•å¼€å‘ä¸€ä¸ªå®‰å…¨é«˜æ•ˆçš„æ™ºèƒ½åˆçº¦è‡³å…³é‡è¦ã€‚

å¯¹ Yul ä¸ç†Ÿæ‚‰çš„è¯»è€…å¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰å…³äºè¯¥ä¸»é¢˜çš„æ–‡ç« ï¼š

[

## å¦‚ä½•åœ¨ä½ çš„ MEV é¡¹ç›®ä¸­ä½¿ç”¨ Yul

### ä¸€ä»½å…³äºé™ä½ gas æˆæœ¬å’Œä½¿ç”¨æ±‡ç¼–å¤„ç†é”™è¯¯ã€è½¬ç§»ä»£å¸ã€äº¤æ¢ä»£å¸ç­‰çš„ A åˆ° Z æŒ‡å—

medium.com



](/@solidquant/up-your-mev-game-by-using-assembly-93c31b06cf96?source=post_page-----a89235281da3--------------------------------)

æˆ‘ä»¬éœ€è¦ä¸€ä¸ªåˆçº¦æ¥æ¨¡æ‹Ÿæˆ‘ä»¬çš„äº¤æ˜“ _(å½“ç„¶åœ¨å®é™…äº¤æ˜“ä¸­ä¹Ÿæ˜¯å¦‚æ­¤)_ï¼Œå¸®åŠ©æˆ‘ä»¬ç¡®å®šæ½œåœ¨æ”¶ç›Šå’Œç›¸å…³çš„ gas æˆæœ¬ã€‚é‰´äºæ¯ä¸ªäººéƒ½ä¼šæœ‰ä¸€ä¸ªé’ˆå¯¹å…¶ç­–ç•¥é‡èº«å®šåˆ¶çš„åˆçº¦ï¼Œé¢„è®¡ä¼šé‡åˆ°å„ç§åˆ©æ¶¦å’Œæˆæœ¬åˆ†æã€‚

åˆçº¦åœ¨è¿™é‡Œæä¾›ï¼š

[

## sandooo/contracts/src/Sandooo.sol at main Â· solidquant/sandooo

### ä¸€ä¸ªä¸‰æ˜æ²»æœºå™¨äººã€‚é€šè¿‡åœ¨ GitHub ä¸Šåˆ›å»ºå¸æˆ·æ¥è´¡çŒ® solidquant/sandooo çš„å¼€å‘ã€‚

github.com



](https://github.com/solidquant/sandooo/blob/main/contracts/src/Sandooo.sol?source=post_page-----a89235281da3--------------------------------)

è¿™æ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„åˆçº¦ï¼Œä½¿ç”¨ Foundry ç¼–å†™ï¼Œé‡‡ç”¨ Yul è¯­è¨€ã€‚

æˆ‘ä»¬å°†å¿«é€ŸæŸ¥çœ‹ **fallback** å‡½æ•°ï¼š

```yul
fallback() external payable {  
    // We check that the msg.sender is the owner who deployed the contract  
    require(msg.sender == owner, "NOT_OWNER");  
  
    assembly {  
        let ptr := mload(0x40)  
        let end := calldatasize()  
  
        // the first 8 bytes (64 bits, uint64) of the calldata is the block_number  
        // we want to make sure that our transactions are valid only on  
        // the block that we've specified  
        let block_number := shr(192, calldataload(0))  
        if iszero(eq(block_number, number())) {  
            revert(0, 0)  
        }  
  
        // we can pass in multiple swap instructions  
        // which we'll use later when we group multiple sandwiches together  
        for {  
            let offset := 8  
        } lt(offset, end) {  
  
        } {  
            let zeroForOne := shr(248, calldataload(offset)) // 1 byte  
            let pair := shr(96, calldataload(add(offset, 1))) // 20 bytes  
            let tokenIn := shr(96, calldataload(add(offset, 21))) // 20 bytes  
            let amountIn := calldataload(add(offset, 41)) // 32 bytes  
            let amountOut := calldataload(add(offset, 73)) // 32 bytes  
            offset := add(offset, 105) // 1 + 20 + 20 + 32 + 32  
  
            // transfer tokenIn to pair contract first  
            mstore(ptr, TOKEN_TRANSFER_ID)  
            mstore(add(ptr, 4), pair)  
            mstore(add(ptr, 36), amountIn)  
  
            if iszero(call(gas(), tokenIn, 0, ptr, 68, 0, 0)) {  
                revert(0, 0)  
            }  
  
            // call swap function in UniswapV2Pair contract  
            // zeroForOne means the transaction is a swap going from token0 to token1  
            // Uniswap V2 swap function expects us to pass it in the amountOut value  
            // so if zeroForOne == 1 (true), the out token is token1  
            // and if zeroForOne == 0 (false), the out token is token0  
            mstore(ptr, V2_SWAP_ID)  
            switch zeroForOne  
            case 0 {  
                mstore(add(ptr, 4), amountOut)  
                mstore(add(ptr, 36), 0)  
            }  
            case 1 {  
                mstore(add(ptr, 4), 0)  
                mstore(add(ptr, 36), amountOut)  
            }  
            mstore(add(ptr, 68), address())  
            mstore(add(ptr, 100), 0x80)  
  
            if iszero(call(gas(), pair, 0, ptr, 164, 0, 0)) {  
                revert(0, 0)  
            }  
        }  
    }  
}
```

# ä½¿ç”¨ REVM çš„ä¸‰æ˜æ²»æ¨¡æ‹Ÿå¼•æ“

ç°åœ¨æˆ‘ä»¬å·²ç»å‡†å¤‡å¥½åˆçº¦ï¼Œç»ˆäºå¯ä»¥è¿›è¡Œä¸€äº›çœŸå®çš„æ¨¡æ‹Ÿäº†ã€‚

æˆ‘ä»¬å°†æ€»å…±è¿è¡Œä¸‰ä¸ªæ¨¡æ‹Ÿæ­¥éª¤ï¼š

1.  **å¼€èƒƒèœ** æ¨¡æ‹Ÿ
2.  è¾“å…¥é‡‘é¢ **ä¼˜åŒ–** æ¨¡æ‹Ÿ
3.  **ä¸»èœ** æ¨¡æ‹Ÿ

ä½ å¯èƒ½ä¼šæƒ³ï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦è¿™ä¹ˆå¤šæ¨¡æ‹Ÿæ­¥éª¤ï¼Œä½†ä½ ä¼šçœ‹åˆ°å®ƒä»¬åœ¨ç”Ÿæ€ç³»ç»Ÿä¸­éƒ½æœ‰å…¶ä½œç”¨ã€‚

## å¼€èƒƒèœæ¨¡æ‹Ÿ

[

## sandooo/src/sandwich/appetizer.rs at main Â· solidquant/sandooo

### ä¸€ä¸ªä¸‰æ˜æ²»æœºå™¨äººã€‚é€šè¿‡åœ¨ GitHub ä¸Šåˆ›å»ºå¸æˆ·æ¥è´¡çŒ® solidquant/sandooo çš„å¼€å‘ã€‚

github.com



](https://github.com/solidquant/sandooo/blob/main/src/sandwich/appetizer.rs?source=post_page-----a89235281da3--------------------------------)

åœ¨å¼€èƒƒèœæ¨¡æ‹Ÿä¸­ï¼Œæˆ‘ä»¬å°è¯•å°† 0.1 WETH ä½œä¸ºæˆ‘ä»¬ç¬¬ä¸€æ¬¡è´­ä¹°äº¤æ˜“ï¼ˆå‰ç½®äº¤æ˜“ï¼‰çš„ amountInï¼Œå¹¶å°è¯•æŸ¥çœ‹å®ƒæ˜¯å¦æœ‰åˆ©å¯å›¾ã€‚

è¿™æ˜¯ä¸ºäº†å‡å°‘æˆ‘ä»¬åœ¨åç»­æ­¥éª¤ä¸­è¿è¡Œçš„æ¨¡æ‹Ÿæ•°é‡ã€‚å¦‚æœä¸‰æ˜æ²»æ†ç»‘åŒ…ç”šè‡³æ— æ³•æ¥å— 0.1 WETH ä½œä¸ºè¾“å…¥ï¼Œé‚£ä¹ˆç»§ç»­è¿›è¡Œä¼˜åŒ–æ­¥éª¤å°±æ²¡æœ‰æ„ä¹‰ã€‚

## è¾“å…¥é‡‘é¢ ä¼˜åŒ– æ¨¡æ‹Ÿ

å¦‚æœæˆ‘ä»¬çš„å¼€èƒƒèœæ¨¡æ‹Ÿé€šè¿‡äº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬æƒ³è¦åœ¨è¿›å…¥ä¸‹ä¸€æ­¥ä¹‹å‰æ‰¾å‡ºä¼˜åŒ–åçš„ WETH amountIn å€¼ã€‚

ä½ å¯ä»¥åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­æŸ¥çœ‹ä¼˜åŒ–è¿‡ç¨‹ï¼š

[

## sandooo/src/sandwich/simulation.rs at main Â· solidquant/sandooo

### ä¸€ä¸ªä¸‰æ˜æ²»æœºå™¨äººã€‚é€šè¿‡åœ¨ GitHub ä¸Šåˆ›å»ºå¸æˆ·æ¥è´¡çŒ® solidquant/sandooo çš„å¼€å‘ã€‚

github.com



](https://github.com/solidquant/sandooo/blob/main/src/sandwich/simulation.rs?source=post_page-----a89235281da3--------------------------------)

é€šè¿‡äºŒæ¬¡æœç´¢ï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾å‡ºå¯ä»¥ç”¨ WETH è´­ä¹°çš„ä»£å¸æ•°é‡ï¼Œä»¥æœ€å¤§åŒ–æˆ‘ä»¬çš„æ”¶ç›Šã€‚

## ä¸»èœ æ¨¡æ‹Ÿ

[

## sandooo/src/sandwich/main_dish.rs at main Â· solidquant/sandooo

### ä¸€ä¸ªä¸‰æ˜æ²»æœºå™¨äººã€‚é€šè¿‡åœ¨ GitHub ä¸Šåˆ›å»ºå¸æˆ·æ¥è´¡çŒ® solidquant/sandooo çš„å¼€å‘ã€‚

github.com



](https://github.com/solidquant/sandooo/blob/main/src/sandwich/main_dish.rs?source=post_page-----a89235281da3--------------------------------)

åœ¨æˆ‘ä»¬å®Œæˆä¼˜åŒ–æ­¥éª¤åï¼Œæˆ‘ä»¬ä½¿ç”¨è¯¥ç»“æœè¿è¡Œå¦ä¸€ä¸ªæ¨¡æ‹Ÿå¹¶è®¡ç®—å‡†ç¡®çš„æ”¶å…¥å€¼ã€‚

æ”¶å…¥è®¡ç®—å¦‚ä¸‹ï¼š

*   **åˆ©æ¶¦** = åˆçº¦ WETH ä½™é¢ä¹‹å - WETH ä½™é¢ä¹‹å‰
*   **æˆæœ¬** = ç”¨æˆ· ETH ä½™é¢ä¹‹å - ETH ä½™é¢ä¹‹å‰
*   **æ”¶å…¥** **= åˆ©æ¶¦ - æˆæœ¬**

å¦‚æœæ”¶å…¥å¤§äº 0ï¼Œåˆ™æ„å‘³ç€ä¸‰æ˜æ²»æ†ç»‘åŒ…å¯ä»¥è¦†ç›–æˆ‘ä»¬çš„ gas æˆæœ¬ï¼Œå› æ­¤æˆ‘ä»¬ä½¿ç”¨æ­¤æ­¥éª¤çš„æ”¶å…¥å€¼è®¡ç®—è´¿èµ‚é‡‘é¢ã€‚

è¿è¡ŒåŒ…å«æ‰€æœ‰è¿™äº›ç»„ä»¶çš„ç³»ç»Ÿå°†äº§ç”Ÿä»¥ä¸‹ gifã€‚å°è¯•è¿è¡Œï¼š

```bash
cargo run
```

![](https://img.learnblockchain.cn/attachments/migrate/1731979872596)

## æ¥ä¸‹æ¥æœŸå¾…ä»€ä¹ˆ

è¿™æ˜¯ä¸€æ®µç›¸å½“çš„æ—…ç¨‹ã€‚ğŸ™ éå¸¸æ„Ÿè°¢ä½ ä»¬çš„é™ªä¼´ã€‚

æœ€åˆï¼Œæˆ‘è®¡åˆ’å°†å…¶åˆ†è§£ä¸ºå‡ ç¯‡å°æ–‡ç« ï¼Œä½†æˆ‘æƒ³å¼ºè°ƒé€è¡Œæ·±å…¥ GitHub ä»£ç çš„é‡è¦æ€§ã€‚è‡ªå·±è¿è¡Œç¨‹åºå¹¶äº²çœ¼è§è¯å…¶æˆåŠŸè¿è¡Œæ˜¯æˆ‘æ¨èç»™æ¯ä¸ªäººçš„ç»ä½³å®è·µã€‚

åœ¨æœ¬ç³»åˆ—çš„åç»­æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†æ·±å…¥æ¢è®¨å¦‚ä½•å°†æ†ç»‘åŒ…å‘é€ç»™åƒ Flashbots è¿™æ ·çš„æ„å»ºè€…ã€‚æˆ‘ä»¬å°†æ¯”è¾ƒæˆ‘ä»¬çš„æ†ç»‘åŒ…ä¸å½“å‰ç³»ç»Ÿä¸­ç«äº‰å¯¹æ‰‹çš„è¡¨ç°ï¼Œå¹¶æ¢ç´¢æˆ‘ä»¬å¯ä»¥åœ¨è®¾ç½®ä¸­ç¼–ç»‡çš„æ½œåœ¨ä¼˜åŒ–ã€‚

ä¸‹æ¬¡è§ï¼Œå¤§å®¶ï¼ğŸ’¥

> æˆ‘æ˜¯ [AI ç¿»è¯‘å®˜](https://learnblockchain.cn/people/19584)ï¼Œä¸ºå¤§å®¶è½¬è¯‘ä¼˜ç§€è‹±æ–‡æ–‡ç« ï¼Œå¦‚æœ‰ç¿»è¯‘ä¸é€šçš„åœ°æ–¹ï¼Œåœ¨[è¿™é‡Œ](https://github.com/lbc-team/Pioneer/blob/master/translations/9954.md)ä¿®æ”¹ï¼Œè¿˜è¯·åŒ…æ¶µï½