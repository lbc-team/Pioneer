
>- åŸæ–‡é“¾æ¥ï¼š[zk.bearblog.dev/tornado-cash...](https://zk.bearblog.dev/tornado-cash-manual/)
>- è¯‘è€…ï¼š[AIç¿»è¯‘å®˜](https://learnblockchain.cn/people/19584)ï¼Œæ ¡å¯¹ï¼š[ç¿»è¯‘å°ç»„](https://learnblockchain.cn/people/412)
>- æœ¬æ–‡é“¾æ¥ï¼š[learnblockchain.cn/articleâ€¦](https://learnblockchain.cn/article/10174)
    
_2024 å¹´ 12 æœˆ 02 æ—¥_

![header](https://img.learnblockchain.cn/attachments/migrate/1733708325164)

> æœ¬æ–‡ç”±ä¸€ä½å·¥ç¨‹å¸ˆçˆ±å¥½è€…æ’°å†™ï¼ˆå—¨ï¼Œæˆ‘æ˜¯ [Krishang](https://zk.bearblog.dev/about/) ğŸ‘‹ğŸ½ï¼‰ï¼ŒçŒ®ç»™åŒæ ·æ˜¯å·¥ç¨‹å¸ˆå’Œçˆ±å¥½è€…çš„ä½ ã€‚
> 
> è¯·åœ¨è¿™ä¸ª [tornado-cash-rebuilt](https://github.com/nkrishang/tornado-cash-rebuilt) ä»“åº“ä¸­æå‡ºé—®é¢˜ï¼Œä»¥ä¾¿æŒ‡å‡ºä»»ä½•ä»£ç é—®é¢˜ã€‚è°¢è°¢ï¼

æœ¬æ–‡æ˜¯å¯¹ [é›¶çŸ¥è¯†ä»‹ç»](https://zk.bearblog.dev/introduction/) æ–‡ç« çš„åç»­å†…å®¹ã€‚æˆ‘ä»¬å°†è¯¦ç»†ä»‹ç» [Tornado Cash](https://docs.tornado.ws/) çš„ä»£ç åº“ã€‚

æˆ‘ä»¬çš„ç›®æ ‡æ˜¯è®©ä½ äº†è§£æ•´ä¸ªå¼€å‘å‘¨æœŸï¼Œè€Œä¸ä»…ä»…æ˜¯ Solidity æ™ºèƒ½åˆçº¦ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†æ¶µç›– \[1\] æ¶æ„æ¦‚è¿°ï¼Œ\[2\] Circom ZK ç”µè·¯ï¼Œ\[3\] æ™ºèƒ½åˆçº¦ä»¥åŠ \[4\] å®¢æˆ·ç«¯çš„è¯æ˜ç”Ÿæˆå’ŒéªŒè¯ï¼ˆä½¿ç”¨ Javascriptï¼‰ã€‚

Tornado Cash äº 2019 å¹´é¦–æ¬¡æ¨å‡ºã€‚è‡ªé‚£æ—¶ä»¥æ¥ï¼ŒZK å·¥å…·çš„å‘å±•ä½¿å¾—åŸå§‹ä»“åº“æœ‰äº›è¿‡æ—¶ã€‚æˆ‘ä»¬å°†é€šè¿‡ [tornado-cash-rebuilt](https://github.com/nkrishang/tornado-cash-rebuilt) ä»“åº“æ¥é‡å»º Tornado Cashï¼Œä»¥ç°ä»£çš„ Solidity å’Œ ZK å·¥å…·è¿›è¡Œæ•™è‚²ç›®çš„çš„é‡å»ºã€‚

## æ¦‚è¿°

Tornado Cash çš„ç›®æ ‡æ˜¯è®©ä¸€ä¸ªè´¦æˆ·ï¼ˆAliceï¼‰å‘å…¶æ™ºèƒ½åˆçº¦å­˜å…¥ 1 ä»¥å¤ªï¼Œå¹¶å…è®¸å¦ä¸€ä¸ªè´¦æˆ·ï¼ˆBobï¼‰æå– Alice çš„å­˜æ¬¾ï¼Œè€Œä¸äº§ç”Ÿä»»ä½•å¯è¯†åˆ«çš„å…³è”ã€‚

![tornado-cash-diagram](https://img.learnblockchain.cn/attachments/migrate/1733708325503)

Tornado Cash é€šè¿‡è®©å­˜æ¬¾äººæäº¤ä¸€ä¸ª _commitment_ ä»¥åŠä»–ä»¬çš„å­˜æ¬¾æ¥å®ç°æ­¤ç›®æ ‡ã€‚è¿™ä¸ªæ‰¿è¯ºæ˜¯ä¸¤ä¸ªå€¼çš„å“ˆå¸Œè¾“å‡ºã€‚

C=hash(n,s)

å…¶ä¸­ C è¢«ç§°ä¸º _commitment_ï¼Œn å’Œ sï¼ˆ_nullifier_ å’Œ _secret_ï¼‰æ˜¯ä»…å­˜æ¬¾äººæ‰€çŸ¥çš„ç§æœ‰å€¼ã€‚æ™ºèƒ½åˆçº¦å°†ä»…åœ¨æå–è€…è¯æ˜ä»–ä»¬çŸ¥é“ n å’Œ s æ—¶ï¼Œé‡Šæ”¾è¯¥å­˜æ¬¾é‡‘é¢ç»™æå–è€…ã€‚

ä¸ºäº†è¯æ˜è¿™ä¸€ç‚¹ï¼Œå¦‚æœæå–è€…å¿…é¡»å°† n å’Œ sï¼ˆä»¥ç›´æ¥æˆ–é—´æ¥ä½†å¯æ¢å¤çš„æ–¹å¼ï¼‰æš´éœ²ç»™æ™ºèƒ½åˆçº¦ï¼Œå°±å¯èƒ½åœ¨ç‰¹å®šçš„å­˜æ¬¾å’Œæå–ä¹‹é—´å»ºç«‹è”ç³»ã€‚è¿™æ˜¯å› ä¸ºæˆ‘ä»¬å¯ä»¥ä»åˆçº¦ä¸­æ‰€æœ‰å­˜æ¬¾ä¸­ç®€å•åœ°æŸ¥æ‰¾æ‰¿è¯ºå€¼ Cï¼Œå¹¶æ£€æŸ¥å“ªä¸ªæ»¡è¶³ C=hash(n,s)ã€‚

ä¸ºäº†é¿å…åœ¨å­˜æ¬¾å’Œæå–ä¹‹é—´å»ºç«‹ä»»ä½•å…³è”ï¼ŒTornado Cash ä½¿ç”¨é›¶çŸ¥è¯†è¯æ˜ç®—æ³• **Groth-16** æ¥å…è®¸æå–è€…è¯æ˜ä»–ä»¬å¯¹ä¸ç‰¹å®šå­˜æ¬¾ç›¸å…³çš„æŸäº› n å’Œ s çš„çŸ¥è¯†ã€‚

## æ¶æ„

Tornado Cash ç”±ä¸¤ä¸ªæ™ºèƒ½åˆçº¦ `ETHTornado` å’Œ `Verifier` ä»¥åŠä¸€ä¸ªç”µè·¯ `Circuit` ç»„æˆã€‚

1.  `ETHTornado`ï¼šç”¨æˆ·é€šè¿‡æ­¤åˆçº¦çš„ `deposit` å’Œ `withdraw` å‡½æ•°è¿›è¡Œäº¤äº’ã€‚
    
2.  `Verifier`ï¼šå®ƒçš„å”¯ä¸€ç›®çš„å°±æ˜¯éªŒè¯ä¸º Tornado Cash ç”µè·¯ç”Ÿæˆçš„è¯æ˜ï¼Œå¹¶åœ¨æ¯æ¬¡æå–æ—¶è¢«è°ƒç”¨ã€‚
    
3.  `Circuit`ï¼šå®ƒåœ¨æœ€å¼€å§‹æ—¶è¢«ç”¨æ¥ç”Ÿæˆ `Verifier` æ™ºèƒ½åˆçº¦ã€‚ä¹‹åï¼Œæ¯æ¬¡æå–æ—¶ï¼Œæå–è€…å°†ç§æœ‰å€¼ nullifier n å’Œ secret s ä½œä¸ºè¾“å…¥æä¾›ç»™ç”µè·¯ï¼Œå¹¶æ¥æ”¶ç›¸å…³çš„é›¶çŸ¥è¯†è¯æ˜æ•°æ®ä½œä¸ºè¾“å‡ºã€‚
    

è¦å‘ Tornado Cash å­˜å…¥ 1 ä»¥å¤ªï¼Œå­˜æ¬¾é’±åŒ…è°ƒç”¨ `ETHTornado` æ™ºèƒ½åˆçº¦ä¸Šçš„ `deposit` å‡½æ•°ï¼Œå¹¶å‘é€ä¸€ä¸ªåˆçº¦å­˜å‚¨åœ¨é»˜å…‹å°”æ ‘ä¸­çš„ _commitment_ã€‚

![deposit-architecture](https://img.learnblockchain.cn/attachments/migrate/1733708325517)

è¦æå–ç‰¹å®šçš„å­˜æ¬¾ï¼Œæå–é’±åŒ…è°ƒç”¨ `ETHTornado` æ™ºèƒ½åˆçº¦ä¸Šçš„ `withdraw` å‡½æ•°ã€‚

ä¸ºäº†é˜²æ­¢åœ¨æå–é’±åŒ…å’ŒåŸå§‹å­˜æ¬¾é’±åŒ…ä¹‹é—´åˆ›å»ºå¯è¿½æº¯çš„å…³è”ï¼Œåˆçº¦è¦æ±‚æå–è€…å‘é€ä¸€ä¸ªå…³äºä»–ä»¬å¯¹ä¸ç‰¹å®šå­˜æ¬¾çš„æ‰¿è¯º C=hash(n,s) ç›¸å…³çš„ nullifier n å’Œ secret s çš„çŸ¥è¯†çš„ _zero knowledge proof_ã€‚

![with-architecture](https://img.learnblockchain.cn/attachments/migrate/1733708325522)

æå–è€…å°† \[1\] è¯æ˜å’Œ \[2\] â€œå…¬å…±è¾“å…¥â€ å‘é€åˆ° `withdraw` å‡½æ•°ã€‚è¿™ä¸¤ä¸ªå€¼éƒ½è¢«å‘é€åˆ° `Verifier` åˆçº¦ï¼Œå¦‚æœæä¾›çš„è¯æ˜æœ‰é—®é¢˜ï¼Œåˆçº¦å°±ä¼šå›é€€ã€‚

å…¬å…±è¾“å…¥ä¹‹æ‰€ä»¥ç§°ä¸ºå…¬å…±ï¼Œæ˜¯å› ä¸ºæå–è€…ç›´æ¥å‘é€å®ƒä»¬ï¼Œæ²¡æœ‰ä»»ä½•åŠ å¯†æˆ–éšè—ã€‚

æš´éœ²è¿™äº›è¾“å…¥å¯¹è¯æ˜ç”Ÿæˆäº†é‡è¦çš„ä¿è¯ï¼Œè€Œä¸å¦¨ç¢é›¶çŸ¥è¯†æ€§è´¨ã€‚ä¾‹å¦‚ï¼Œå…¬å…±è¾“å…¥ `recipient` æ˜¯æå–å­˜æ¬¾å°†è¦å‘é€çš„åœ°å€ã€‚ç”±äºè¿™ä¸ªè¯æ˜æ˜¯ä»¥è¿™ä¸ªç‰¹å®šçš„ `recipient` å€¼ä½œä¸ºè¾“å…¥ç”Ÿæˆçš„ï¼Œå› æ­¤æ²¡æœ‰äººå¯ä»¥æ¶æ„åœ°å¤åˆ¶å¹¶åœ¨å¦ä¸€ä¸ªæå–äº¤æ˜“ä¸­ä½¿ç”¨è¿™ä¸ªç›¸åŒçš„è¯æ˜ï¼Œè€Œè¯¥äº¤æ˜“æœ‰ä¸€ä¸ªä¸åŒçš„æ”¶ä»¶äººåœ°å€ã€‚

![proof-gen-architecture](https://img.learnblockchain.cn/attachments/migrate/1733708325539)

æå–è€…é€šè¿‡ä¸ `Circuit` äº¤äº’ç”Ÿæˆå…³äºä»–ä»¬å¯¹ nullifier n å’Œ secret s çš„çŸ¥è¯†çš„é›¶çŸ¥è¯†è¯æ˜ã€‚

ç”µè·¯æ¥å— \[1\] å…¬å…±è¾“å…¥å’Œ \[2\] ç§æœ‰è¾“å…¥ã€‚å…¬å…±è¾“å…¥åŒ…æ‹¬é»˜å…‹å°”æ ¹ `root`ï¼Œç§æœ‰è¾“å…¥åŒ…æ‹¬ nullifierã€secret å’Œé»˜å…‹å°”æ ‘è·¯å¾„å…ƒç´ ã€‚

ç”µè·¯å¯¹ nullifier å’Œ secret è¿›è¡Œå“ˆå¸Œä»¥è®¡ç®—å‡ºæ‰¿è¯ºï¼Œå¹¶ä½¿ç”¨è¿™ä¸ªæ‰¿è¯ºå’Œè·¯å¾„å…ƒç´ ï¼Œç”µè·¯è®¡ç®—å‡ºä¸€ä¸ªé»˜å…‹å°”æ ¹å¹¶æ£€æŸ¥å®ƒæ˜¯å¦ä¸å…¬å…±è¾“å…¥ `root` ç›¸åŒã€‚

## ä»€ä¹ˆæ˜¯é»˜å…‹å°”æ ‘ï¼Ÿ

> æœ¬èŠ‚çº¯ç²¹æ˜¯è‡ªæˆ‘æ»¡è¶³ã€‚æˆ‘åªæ˜¯æƒ³å†™ä¸€ä¸ªç®€å•ã€æ¸…æ™°ä¸”ç®€çŸ­çš„é»˜å…‹å°”æ ‘è§£é‡Šã€‚

é»˜å…‹å°”æ ‘æ˜¯ä¸€ç§äºŒå‰æ ‘ã€‚å®ƒæœ‰ä¸€ä¸ªæ ¹èŠ‚ç‚¹ï¼Œæ ¹èŠ‚ç‚¹æœ‰ä¸¤ä¸ªå­èŠ‚ç‚¹ï¼Œæ¯ä¸ªå­èŠ‚ç‚¹å„æœ‰ä¸¤ä¸ªå­èŠ‚ç‚¹ï¼Œä¾æ­¤ç±»æ¨ã€‚

æ³¨æ„åœ¨æ ¹çº§åˆ«ï¼Œæ ‘æœ‰ 20^0=1 ä¸ªèŠ‚ç‚¹ã€‚åœ¨Layer1ï¼Œæ ‘æœ‰ 2^1 ä¸ªèŠ‚ç‚¹ï¼Œåœ¨ Layer2 æœ‰ 2^2 ä¸ªèŠ‚ç‚¹ ... åœ¨ç¬¬ n å±‚ï¼Œæ ‘æœ‰ 2^n ä¸ªèŠ‚ç‚¹ã€‚

![merkle-tree-1](https://img.learnblockchain.cn/attachments/migrate/1733708325551)

æ¯ä¸ªçˆ¶èŠ‚ç‚¹æ˜¯å…¶ä¸¤ä¸ªå­èŠ‚ç‚¹çš„å“ˆå¸Œã€‚å› æ­¤ï¼Œparent=hash(c1,c2)ã€‚è¿™é€‚ç”¨äºæ‰€æœ‰èŠ‚ç‚¹ï¼Œé™¤äº†æ ‘çš„å¶å­èŠ‚ç‚¹ï¼ˆæ²¡æœ‰è‡ªèº«å­èŠ‚ç‚¹çš„æœ€åº•å±‚èŠ‚ç‚¹ï¼‰ã€‚

æ ‘çš„æ¯ä¸ªå¶å­æ˜¯â€œåŸå§‹æ•°æ®â€çš„ä¸€éƒ¨åˆ†ã€‚å¦‚æœä¸€æ£µé»˜å…‹å°”æ ‘æœ‰ n å±‚ï¼ˆä¸è®¡ç®—æ ¹ä½œä¸ºå±‚ï¼‰ï¼Œè¿™æ„å‘³ç€å®ƒå¯ä»¥å®¹çº³ 2^n ä¸ªåŸå§‹æ•°æ®ã€‚ä»è¿™äº›å¶å­èŠ‚ç‚¹ï¼Œå¯ä»¥æ„å»ºæ•´ä¸ªé»˜å…‹å°”æ ‘ã€‚

é»˜å…‹å°”æ ‘çš„â€œè¶…çº§èƒ½åŠ›â€åœ¨äºï¼Œå¦‚æœæ ‘åŒ…å« 2^n ä¸ªå¶å­ï¼Œåˆ™åªéœ€ n ä¸ªæ•°æ®å³å¯è¯æ˜æŸä¸ªæ•°æ®æ˜¯æ ‘çš„ä¸€ä¸ªå¶å­ã€‚

å‡è®¾ Alice æœ‰ä¸€æ£µåŒ…å« 2^n ä¸ªå¶å­çš„é»˜å…‹å°”æ ‘ï¼Œå…¶æ ¹ä¸º Rã€‚Bob æœ‰ä¸€æ®µæ•°æ® dï¼ˆå›¾ä¸­çš„ç»¿è‰²èŠ‚ç‚¹ï¼‰ï¼Œä»–æƒ³å‘ Alice è¯æ˜å®ƒæ˜¯æ ‘çš„ä¸€ä¸ªå¶å­ã€‚å¦‚æœ Bob å°† d å‘é€ç»™ Aliceï¼Œè€Œå¥¹ç›²ç›®åœ°å°† d ä¸æ¯ä¸ªå¶å­è¿›è¡Œæ¯”è¾ƒï¼Œè¿™ä¼šå‘ç”Ÿ 2^n æ¬¡æ“ä½œï¼Œè¿™æ ·åšæ˜¯éå¸¸éº»çƒ¦çš„ã€‚

![merkle-tree-2](https://img.learnblockchain.cn/attachments/migrate/1733708325836)

ä¸ºäº†å‡å°‘æ“ä½œæ¬¡æ•°ï¼ŒBob å°† d ä¸ç›¸å…³è·¯å¾„å…ƒç´ ï¼ˆå³å…„å¼ŸèŠ‚ç‚¹ã€çˆ¶èŠ‚ç‚¹ã€ç¥–çˆ¶èŠ‚ç‚¹ã€æ›¾ç¥–çˆ¶èŠ‚ç‚¹ç­‰æ ‘çš„èŠ‚ç‚¹ï¼Œå›¾ä¸­ç”¨è“è‰²æ ‡è®°ï¼‰ä¸€èµ·å‘é€ç»™ Aliceã€‚åˆ©ç”¨è¿™ n ä¸ªèŠ‚ç‚¹ï¼ŒAlice å¯ä»¥é‡å»ºé»˜å…‹å°”æ ‘æ ¹ R1ï¼Œå¹¶æ£€æŸ¥å®ƒæ˜¯å¦ä¸å¥¹çš„é»˜å…‹å°”æ ‘æ ¹ R ç›¸åŒï¼Œä»¥ç¡®å®š d æ˜¯å¦æ˜¯å¥¹çš„é»˜å…‹å°”æ ‘çš„ä¸€ä¸ªå¶å­ã€‚

![merkle-tree-4](https://img.learnblockchain.cn/attachments/migrate/1733708325883)

## ä»£ç 

åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†è¯¦ç»†å®¡æŸ¥ Tornado Cash èƒŒåçš„ä»£ç ã€‚æˆ‘å»ºè®®é€šè¿‡å…‹éš† [tornado-cash-rebuilt](https://github.com/nkrishang/tornado-cash-rebuilt) ä»“åº“æ¥è·Ÿéšï¼Œå¹¶é¡ºä¾¿ç»™å®ƒä¸€ä¸ªæ˜Ÿæ˜Ÿã€‚æŒ‰ç…§ç®€å•çš„ README æŒ‡ç¤ºè¿›è¡Œè®¾ç½®ã€‚

## ç«¯åˆ°ç«¯æµç¨‹

è®©æˆ‘ä»¬é¦–å…ˆæŸ¥çœ‹ [test\_mixer\_single\_deposit](https://github.com/nkrishang/tornado-cash-rebuilt/blob/main/test/ETHTornado.t.sol#L96C14-L96C39) æµ‹è¯•æ¡ˆä¾‹ï¼Œä»¥äº†è§£ Tornado Cash çš„ç«¯åˆ°ç«¯æµç¨‹ã€‚

åœ¨æ¥ä¸‹æ¥çš„å¸–å­ä¸­ï¼Œæˆ‘ä»¬å°†è¯¦ç»†æŸ¥çœ‹æ­¤æµ‹è¯•æ¡ˆä¾‹çš„æ¯ä¸ªç»„ä»¶ï¼Œä»¥ä¾¿å¯¹è¯¥ç«¯åˆ°ç«¯æµç¨‹çš„å†…éƒ¨è¿è¡Œæœ‰ä¸€ä¸ªå®Œæ•´çš„ä½çº§ç†è§£ã€‚

![test-mixer-single-deposit](https://img.learnblockchain.cn/attachments/migrate/1733708325911)

1. æˆ‘ä»¬ç”Ÿæˆä¸¤ä¸ªéšæœºçš„ bytes32 å€¼ `nullifier` å’Œ `secret`ã€‚`commitment` åªæ˜¯è¿™ä¸¤ä¸ªç”Ÿæˆå€¼çš„å“ˆå¸Œã€‚å­˜å…¥è€…è°ƒç”¨ `deposit` å‡½æ•°å¹¶ä¼ é€’æ‰¿è¯ºã€‚

2. æˆ‘ä»¬ä½¿ç”¨ç”µè·¯ç”Ÿæˆä¸€ä¸ªé›¶çŸ¥è¯†è¯æ˜ï¼ˆæˆ‘ä»¬å¯¹ nullifier å’Œ secret çš„çŸ¥è¯†ï¼‰ã€‚

3. ä½œä¸ºåˆç†æ€§æ£€æŸ¥ï¼Œæˆ‘ä»¬ç›´æ¥è°ƒç”¨éªŒè¯åˆçº¦é€šè¿‡æˆ‘ä»¬çš„è¯æ˜æ¥éªŒè¯æˆ‘ä»¬çš„è¯æ˜æ˜¯å¦åˆæ³•ã€‚

4. æå–è€…è°ƒç”¨ `withdraw` å‡½æ•°å¹¶æä¾›è¯æ˜å’Œå…¬å…±è¾“å…¥ä»¥è·å–å­˜æ¬¾ã€‚

æ­¤æµ‹è¯•æœ¬èº«åº”ä¿è¯ä½  Tornado Cash çš„å­˜å–æ¬¾æµç¨‹æ˜¯ä¸€ä¸ªç±»å‹åŒ–ä¸”å…·ä½“çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥é€æ­¥åˆ†è§£å¹¶å®Œå…¨ç†è§£ã€‚

## ç”Ÿæˆ `nullifier` å’Œ `secret`

æ­¥éª¤ \[1\] ä¸­çš„ `_generateCommitment` ä½¿ç”¨ [forge](https://book.getfoundry.sh/) `vm.ffi` API è°ƒç”¨ [/forge-ffi-scripts/generateCommitment.js](https://github.com/nkrishang/tornado-cash-rebuilt/blob/main/forge-ffi-scripts/generateCommitment.js)ã€‚

![generateCommitment](https://img.learnblockchain.cn/attachments/migrate/1733708325930)

æˆ‘ä»¬ç®€å•åœ°ç”Ÿæˆä¸¤ä¸ªéšæœºæ•°ä½œä¸ºæˆ‘ä»¬çš„ nullifier å’Œ secretï¼Œå¹¶å°†å®ƒä»¬å“ˆå¸Œåœ¨ä¸€èµ·ä»¥åˆ›å»ºæˆ‘ä»¬çš„æ‰¿è¯ºã€‚

`pedersen` å‡½æ•°æ˜¯ä¸€ä¸ªå“ˆå¸Œå‡½æ•°ï¼ˆå°±åƒ `keccak256` æ˜¯ä¸€ä¸ªå“ˆå¸Œå‡½æ•°ï¼‰ï¼Œåœ¨é›¶çŸ¥è¯†è¯æ˜çš„ä¸Šä¸‹æ–‡ä¸­æ•ˆç‡å¾ˆé«˜ã€‚è¿™æ„å‘³ç€å½“æˆ‘ä»¬åœ¨ç”µè·¯ä¸­ä½¿ç”¨å®ƒæ—¶ï¼Œä¸å…¶ä»–å“ˆå¸Œå‡½æ•°ï¼ˆä¾‹å¦‚ keccak å“ˆå¸Œå‡½æ•°ï¼‰ç›¸æ¯”ï¼Œå®ƒåˆ›å»ºçš„ç®—æœ¯çº¦æŸè¾ƒå°‘ã€‚

## å­˜å…¥ä»¥å¤ª

å­˜å…¥è€…åœ¨ `ETHTornado` åˆçº¦ä¸Šè°ƒç”¨ [`deposit` å‡½æ•°](https://github.com/nkrishang/tornado-cash-rebuilt/blob/main/src/Tornado.sol#L57) ä»¥å­˜å…¥ä»¥å¤ªã€‚

![deposit](https://img.learnblockchain.cn/attachments/migrate/1733708326080)

åˆçº¦å°† `commitment` æ ‡è®°ä¸ºå·²ä½¿ç”¨ï¼Œç„¶åå°†å…¶å­˜å‚¨ä¸ºé»˜å…‹å°”æ ‘ä¸­çš„ä¸€ä¸ªå¶å­ï¼Œå…¶ API åœ¨ [`MerkleTreeWithHistory.sol`](https://github.com/nkrishang/tornado-cash-rebuilt/blob/main/src/MerkleTreeWithHistory.sol) ä¸­å®šä¹‰ã€‚

è¿™æ˜¯ä¸€ä¸ªå›ºå®šé«˜åº¦çš„é»˜å…‹å°”æ ‘ï¼Œå¹¶åœ¨æ¯ä¸€å±‚ç”¨ [ç‰¹å®šçš„é›¶å€¼](https://github.com/nkrishang/tornado-cash-rebuilt/blob/main/src/MerkleTreeWithHistory.sol#L121) è¿›è¡Œåˆå§‹åŒ–ã€‚

![zeroes](https://img.learnblockchain.cn/attachments/migrate/1733708326137)

`_insert` å‡½æ•°æ˜¯ä¸€ä¸ªç”¨äºä»ç´¢å¼• 0 åˆ° 2n æ’å…¥å¶å­åˆ°é»˜å…‹å°”æ ‘å¹¶åœ¨æ¯æ¬¡æ’å…¥æ—¶ç›¸åº”æ›´æ–°é»˜å…‹å°”æ ¹çš„ç®—æ³•ã€‚

![merkle-insert](https://img.learnblockchain.cn/attachments/migrate/1733708326187)

ä½ å¯ä»¥åƒä¸‹å›¾é‚£æ ·å¯è§†åŒ–æ’å…¥æ“ä½œã€‚æ ‘çš„æ¯ä¸ªå¶å­éƒ½æœ‰ç´¢å¼•ã€‚æ¯å±‚çš„ç°è‰²èŠ‚ç‚¹ç”¨è¯¥å±‚çš„é›¶å€¼åˆå§‹åŒ–ã€‚ç»¿è‰²èŠ‚ç‚¹è¡¨ç¤ºæˆ‘ä»¬åœ¨ `nextIndex` å¤„æ’å…¥æ‰¿è¯ºçš„å¶å­ï¼Œè“è‰²èŠ‚ç‚¹è¡¨ç¤ºå› æ­¤è€Œæ›´æ–°çš„èŠ‚ç‚¹ã€‚é»„è‰²èŠ‚ç‚¹æ˜¯å…ˆå‰æ’å…¥ä¸­æ›´æ–°çš„éé›¶èŠ‚ç‚¹ã€‚

![fixed-merkle-1-again](https://img.learnblockchain.cn/attachments/migrate/1733708326219)

![fixed-merkle-2](https://img.learnblockchain.cn/attachments/migrate/1733708326286)

æœ€åï¼Œ`_processDeposit` è°ƒç”¨ç¡®ä¿æ‰€æœ‰å­˜æ¬¾é‡‘é¢ç›¸åŒï¼Œä¾‹å¦‚ 1 ä¸ªä»¥å¤ªã€‚è¿™æ˜¯å› ä¸ºå¦‚æœæŸäººå­˜å…¥ç¡®åˆ‡çš„ 0.30024 ä¸ªä»¥å¤ªï¼Œå¹¶ä½¿ç”¨å¦ä¸€ä¸ªé’±åŒ…æå–ç›¸åŒé‡‘é¢ï¼Œåˆ™å­˜æ¬¾å’Œæå–çš„é‡‘é¢åœ¨å®ƒä»¬ä¹‹é—´å»ºç«‹äº†å…³è”ï¼Œè¿™æ˜¯æˆ‘ä»¬æƒ³è¦é¿å…çš„ã€‚

## ç”Ÿæˆè¯æ˜ `pA`, `pB`, `pC`

æ­¥éª¤ \[2\] ä¸­çš„ `_getWitnessAndProof` ä½¿ç”¨ [forge](https://book.getfoundry.sh/) `vm.ffi` API è°ƒç”¨ [/forge-ffi-scripts/getWitness.js](https://github.com/nkrishang/tornado-cash-rebuilt/blob/main/forge-ffi-scripts/getWitness.js)ã€‚

![genWitness-1](https://img.learnblockchain.cn/attachments/migrate/1733708326314)

åœ¨è¿™ä¸ªè„šæœ¬ä¸­ï¼Œæˆ‘ä»¬ä¸ç”µè·¯è¿›è¡Œäº¤äº’ä»¥ç”Ÿæˆä¸€ä¸ªé›¶çŸ¥è¯†è¯æ˜ã€‚æˆ‘ä»¬é¦–å…ˆç»„è£…ç”µè·¯çš„è¾“å…¥ï¼ˆç§æœ‰å’Œå…¬å…±ï¼‰ã€‚

[`mimcMerkleTree`](https://github.com/nkrishang/tornado-cash-rebuilt/blob/main/forge-ffi-scripts/utils/mimcMerkleTree.js) æ˜¯ `MerkleTreeWithHistory.sol` çš„ JavaScript å®ç°ã€‚é»˜å…‹å°”æ ‘ä½¿ç”¨çš„å“ˆå¸Œå‡½æ•°æ˜¯ [MiMC](https://byt3bit.github.io/primesym/mimc/) å“ˆå¸Œå‡½æ•°ï¼Œè¿™æ˜¯å¦ä¸€ä¸ªåœ¨é›¶çŸ¥è¯†è¯æ˜ä¸Šä¸‹æ–‡ä¸­é«˜æ•ˆçš„å“ˆå¸Œå‡½æ•°ã€‚

æ¥ä¸‹æ¥ï¼Œä½¿ç”¨ [snarkJS](https://github.com/iden3/snarkjs) åº“çš„ APIï¼Œæˆ‘ä»¬ç”Ÿæˆä¸€ä¸ªè¯æ˜ï¼Œå¹¶ä»¥æ‰€éœ€æ ¼å¼è¿”å›ã€‚

![genWitness-2](https://img.learnblockchain.cn/attachments/migrate/1733708326370)

## Tornado Cash ç”µè·¯ï¼š`withdraw.circom` å’Œ `merkle.circom`

â€œç”Ÿæˆè¯æ˜â€æˆ–â€œä¸ç”µè·¯äº¤äº’â€ç­‰åˆ°åº•æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ

æœ¬è´¨ä¸Šï¼Œç”µè·¯æ¥å—è¾“å…¥å¹¶æ‰§è¡Œ `assert` è¯­å¥ä»¥æ£€æŸ¥è¾“å…¥æ˜¯å¦æ»¡è¶³æŸäº›æ¡ä»¶ã€‚

[Tornado Cash çš„ç”µè·¯](https://github.com/nkrishang/tornado-cash-rebuilt/blob/main/circuits/withdraw.circom) æ¥å—ä»¥ä¸‹è¾“å…¥ï¼š

![circuit-inputs](https://img.learnblockchain.cn/attachments/migrate/1733708326754)

ç”µè·¯é¦–å…ˆæ–­è¨€ï¼š

hash( nullifier ) === nullifierHash

æ¥ä¸‹æ¥ï¼Œç”µè·¯æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

* ä½¿ç”¨æä¾›çš„ nullifier å’Œ secret è®¡ç®—æ‰¿è¯º
* ä½¿ç”¨æ‰¿è¯ºå’Œæä¾›çš„è·¯å¾„å…ƒç´ è®¡ç®—é»˜å…‹å°”æ ¹
* æœ€åï¼Œæ–­è¨€è®¡ç®—å‡ºçš„æ ¹å’Œä½œä¸ºå…¬å…±è¾“å…¥æä¾›çš„æ ¹ç›¸åŒã€‚

tree(commitment, path\_elements).root === root

ä¸€æ—¦ä½ ç†è§£äº†è¿™æ˜¯ç”µè·¯çš„å·¥ä½œï¼Œé˜…è¯»ä½¿ç”¨ [Circom](https://docs.circom.io/) ç¼–å†™çš„ç”µè·¯å°±ä¸å†æ˜¯éš¾äº‹ã€‚

æœ€åï¼Œä½ ä¼šæ³¨æ„åˆ°ç”µè·¯è½»æ¾ä½¿ç”¨äº†è¿™äº›å…¬å…±è¾“å…¥ã€‚

![unused-public-inputs](https://img.learnblockchain.cn/attachments/migrate/1733708326626)

è¿™äº›è¾“å…¥æœªå‚ä¸ä¸Šè¿°çš„æ–­è¨€è¯­å¥ï¼Œä½†æˆ‘ä»¬ç¡®å®å¸Œæœ›è¯æ˜ä¸è¿™äº›è¾“å…¥ä¸¥æ ¼ç›¸å…³ã€‚

ä¸¾ä¾‹æ¥è¯´ï¼Œå¦‚æœ Bob ä»¥è‡ªå·±çš„é’±åŒ…åœ°å€ä½œä¸º `recipient` ç”Ÿæˆäº†ä¸€ä¸ªè¯æ˜ï¼Œæˆ‘ä»¬å¹¶ä¸å¸Œæœ›æ¶æ„ç¬¬ä¸‰æ–¹èƒ½å¤Ÿç®€å•åœ°ç”¨è‡ªå·±çš„é’±åŒ…åœ°å€é‡å¤ä½¿ç”¨ Bob çš„è¯æ˜ã€‚åƒè¿™æ ·çš„è™šå‡æ–­è¨€ï¼š

(recipient \* recipient) === (recipient \* recipient)

ç¡®ä¿ä¸º Bob çš„é’±åŒ…ä½œä¸ºæ”¶ä»¶äººç”Ÿæˆçš„è¯æ˜åªèƒ½ä¸ Bob çš„é’±åŒ…ä½œä¸º `recipient` å…¬å…±è¾“å…¥ä¸€èµ·ä½¿ç”¨ã€‚

## éªŒè¯è¯æ˜

ä¸€æ—¦ä½ å…‹éš† [tornado-cash-rebuilt](https://github.com/nkrishang/tornado-cash-rebuilt)ï¼ŒREADME æŒ‡ç¤ºä½ è¿è¡Œ `make all`ã€‚

æ­¤è®¾ç½®è¯´æ˜æ¶‰åŠï¼š

*   ç¼–è¯‘ [`/circuits`](https://github.com/nkrishang/tornado-cash-rebuilt/tree/main/circuits) ä¸­çš„ Tornado Cash ç”µè·¯
*   æœ¬åœ°æä¾›ç†µï¼ˆåœ¨â€œ[tau åº†å…¸](https://a16zcrypto.com/posts/article/on-chain-trusted-setup-ceremony/) â€ä¸­ï¼‰
*   ç”Ÿæˆè¯æ˜å’ŒéªŒè¯å¯†é’¥ï¼ˆä½ å°†åœ¨ `/circuit_artifacts` ä¸­æ‰¾åˆ°ï¼‰
*   æœ€åï¼Œç”Ÿæˆ [`src/Verifier.sol`](https://github.com/nkrishang/tornado-cash-rebuilt/blob/main/src/Verifier.sol) åˆçº¦ã€‚

è¯¥åˆçº¦æ—¨åœ¨éªŒè¯æˆ‘ä»¬ä¸ºç‰¹å®šç”µè·¯ç¼–è¯‘å’Œç”Ÿæˆè¯æ˜/éªŒè¯å¯†é’¥çš„è¯æ˜ã€‚

![Verifier](https://img.learnblockchain.cn/attachments/migrate/1733708326650)

åœ¨æˆ‘ä»¬çš„æµ‹è¯•ç”¨ä¾‹ä¸­ï¼Œä¸€æ—¦ç”Ÿæˆäº†è¯æ˜ï¼Œæˆ‘ä»¬é€šè¿‡ç›´æ¥è°ƒç”¨ `Verifier` åˆçº¦çš„ `verifyProof` å‡½æ•°æ¥è¿›è¡Œåˆç†æ€§æ£€æŸ¥ï¼Œä»¥æ£€æŸ¥æˆ‘ä»¬æ˜¯å¦ç”Ÿæˆäº†æœ‰æ•ˆçš„è¯æ˜ã€‚

æˆ‘ä»¬ä»¥ `pA`ã€`pB`ã€`pC` æ ¼å¼å‘é€æˆ‘ä»¬çš„è¯æ˜ï¼Œè¯¥æ ¼å¼æ˜¯ä½äºåœ°å€ `0x08` çš„ [Ethereum é¢„ç¼–è¯‘](https://www.rareskills.io/post/solidity-precompiles) æ‰€æœŸæœ›çš„ã€‚
// åœ¨ \`verifyProof\` ä¸­è°ƒç”¨ 0x08 çš„é¢„ç¼–è¯‘
let success := staticcall(sub(gas(), 2000), 8, _pPairing, 768, _pPairing, 0x20)

å…³äºè¯æ˜ç”Ÿæˆå’ŒéªŒè¯çš„æ•°å­¦å’Œç®—æ³•ç•™å¾…å¦ä¸€å¤©è®¨è®ºã€‚ï¼ˆä¹Ÿè®¸æ˜¯ä¸‹ä¸€ç¯‡æ–‡ç« ï¼Ÿè®©æˆ‘ä»¬æ‹­ç›®ä»¥å¾…ã€‚ï¼‰

## æç°èµ„é‡‘

æå–è€…åœ¨ `ETHTornado` åˆçº¦ä¸Šè°ƒç”¨ [`withdraw` å‡½æ•°](https://github.com/nkrishang/tornado-cash-rebuilt/blob/main/src/Tornado.sol#L80) ä»¥æå–ç‰¹å®šå­˜æ¬¾ã€‚

![withdraw-fn](https://img.learnblockchain.cn/attachments/migrate/1733708326663)

åˆçº¦é€šè¿‡ç¡®ä¿ `nullifierHash` æœªè¢«ä½¿ç”¨æ¥ç¡®ä¿è¯æ˜æœªè¢«é‡æ”¾ã€‚ç„¶åï¼Œå®ƒç¡®ä¿æä¾›çš„å…¬å…±è¾“å…¥ `root` æ˜¯å…¶é»˜å…‹å°”æ ‘çš„ï¼ˆå½“å‰æˆ–è¿‡å» 30 ä¸ªï¼‰æ ¹ä¹‹ä¸€ï¼Œé€šè¿‡ `isKnownRoot` è¿›è¡ŒéªŒè¯ã€‚

æœ€åï¼Œåˆçº¦è°ƒç”¨ `Verifier` æ¥éªŒè¯æä¾›çš„è¯æ˜å’Œå…¬å…±è¾“å…¥ã€‚å¦‚æœéªŒè¯æˆåŠŸï¼Œåˆçº¦å°† `nullifierHash` æ ‡è®°ä¸ºå·²ä½¿ç”¨ï¼Œå¹¶å°†å­˜æ¬¾é‡Šæ”¾åˆ°æä¾›çš„æ¥æ”¶åœ°å€ã€‚

## å°±è¿™äº›ï¼

æˆ‘ä»¬å·²ç»ä»‹ç»äº†ä½¿ç”¨ Tornado Cash çš„å®Œæ•´ç«¯åˆ°ç«¯æµç¨‹ä¸­æ¶‰åŠçš„æ‰€æœ‰ç›¸å…³ä»£ç â€”â€”ä»ç”µè·¯åˆ°åˆçº¦å’Œå®¢æˆ·ç«¯ä»£ç ã€‚

è¿™ç¯‡æ–‡ç« æ²¡æœ‰æ¶µç›– [Groth-16](https://eprint.iacr.org/2016/260.pdf) é›¶çŸ¥è¯†è¯æ˜ç®—æ³•èƒŒåçš„æ•°å­¦ï¼Œå› æ­¤è¯æ˜ç”Ÿæˆå’ŒéªŒè¯çš„ _å¦‚ä½•_ ä»ç„¶å¯èƒ½å¯¹ä½ æ¥è¯´æ˜¯ä¸€ä¸ªé»‘ç›’ã€‚è¿™æ²¡å…³ç³»ã€‚ä¾‹å¦‚ï¼Œä½ å¯èƒ½ä¸çŸ¥é“å“ˆå¸Œå‡½æ•°æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œä½†ä½ ä»ç„¶åœ¨ä½¿ç”¨å®ƒä»¬ã€‚ï¼ˆå½“ç„¶ï¼Œæˆ‘ä¸æ˜¯å‘æ˜è¿™ä¸ªæ¯”å–»çš„äººã€‚ï¼‰

å¦‚æœä½ å¯¹æœ¬æ–‡ä¸­æåˆ°çš„ Tornado Cash æœ‰ä»»ä½•é—®é¢˜æˆ–ç–‘é—®ï¼Œæˆ–æƒ³æå‡ºä»»ä½•æ›´æ­£ï¼Œè¯·åœ¨ [tornado-cash-rebuilt](https://github.com/nkrishang/tornado-cash-rebuilt) ä»“åº“ä¸­æå‡ºé—®é¢˜ï¼Œæˆ–åœ¨æ¨ç‰¹ä¸Š DM æˆ‘ [@MonkeyMeaning](https://x.com/MonkeyMeaning)ã€‚

> æˆ‘æ˜¯ [AI ç¿»è¯‘å®˜](https://learnblockchain.cn/people/19584)ï¼Œä¸ºå¤§å®¶è½¬è¯‘ä¼˜ç§€è‹±æ–‡æ–‡ç« ï¼Œå¦‚æœ‰ç¿»è¯‘ä¸é€šçš„åœ°æ–¹ï¼Œåœ¨[è¿™é‡Œ](https://github.com/lbc-team/Pioneer/blob/master/translations/10174.md)ä¿®æ”¹ï¼Œè¿˜è¯·åŒ…æ¶µï½